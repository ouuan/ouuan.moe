{
    "version": "https://jsonfeed.org/version/1",
    "title": "ouuan's blog: 标签: firefox",
    "home_page_url": "https://ouuan.moe/tag/firefox",
    "feed_url": "https://ouuan.moe/tag/firefox/feed.json",
    "description": "标签: firefox - ouuan 的博客。",
    "author": {
        "name": "ouuan",
        "url": "https://github.com/ouuan"
    },
    "items": [
        {
            "id": "https://ouuan.moe/post/2024/05/psd-firefox-startup",
            "content_html": "\n<p>为了提升性能<span class=\"mojikumi-line-end\">，</span>更好地利用 RAM<span class=\"mojikumi-line-end\">，</span>我一直在使用 <a href=\"https://github.com/graysky2/profile-sync-daemon\">profile-sync-daemon</a><span class=\"mojikumi-line-end\">，</span>也经常在开机时遇到下面这个报错<span class=\"mojikumi-line-end\">：</span></p>\n<blockquote>\n<p>Firefox is already running, but is not responding. To use Firefox, you must first close the existing Firefox process, restart your device, or use a different profile.</p>\n</blockquote>\n<p>之前都是把弹窗关掉手动重启一下<span class=\"mojikumi-line-end\">，</span>最近终于去研究了一下把它修了<span class=\"mojikumi-line-end\">。</span></p>\n\n<h2 id=\"profile-sync-daemon\" class=\"heading\"><a href=\"#profile-sync-daemon\" class=\"heading-anchor\" aria-label=\"章节： profile-sync-daemon\" tabindex=\"-1\"></a><span>profile-sync-daemon</span></h2>\n<p><a href=\"https://github.com/graysky2/profile-sync-daemon\">profile-sync-daemon</a> 就是在启动时把 browser profile 从硬盘复制到内存盘<span class=\"mojikumi-line-end\">，</span>然后创建 symlink 到内存盘<span class=\"mojikumi-line-end\">，</span>并且在需要的时候写回硬盘<span class=\"mojikumi-line-end\">，</span>在浏览器运行过程中主要都是访问内存<span class=\"mojikumi-line-end\">，</span>从而减少硬盘访问<span class=\"mojikumi-line-end\">，</span>理论上可以提升性能<span class=\"mojikumi-line-end\">、</span>降低硬盘损耗<span class=\"mojikumi-line-end\">。</span></p>\n<p>总之如果内存用不完的话<span class=\"mojikumi-line-end\">，</span>用这个东西看起来不亏<span class=\"mojikumi-line-start\">（</span>其实我一开始就是因为有 32G 内存用不完去搜了一下如何利用内存才知道有这个工具<span class=\"mojikumi-line-start\">（</span></p>\n<h2 id=\"探寻报错原因\" class=\"heading\"><a href=\"#探寻报错原因\" class=\"heading-anchor\" aria-label=\"章节： 探寻报错原因\" tabindex=\"-1\"></a><span>探寻报错原因</span></h2>\n<p>在用了 profile-sync-daemon 后<span class=\"mojikumi-line-end\">，</span>在开机时我经常遇到下面这个报错<span class=\"mojikumi-line-end\">：</span></p>\n<p><picture><source type=\"image/webp\" srcset=\"/assets/firefox-already-running.a013edd1.webp\"><img srcset=\"/assets/firefox-already-running.a43a35f3.png\" loading=\"lazy\" src=\"/assets/firefox-already-running.a43a35f3.png\" width=\"441\" height=\"176\" alt=\"弹窗：Firefox is already running, but is not responding. To use Firefox, you must first close the existing Firefox process, restart your device, or use a different profile.\"></picture></p>\n<p>单次处理这个问题非常简单<span class=\"mojikumi-line-end\">，</span>关掉弹窗重启 Firefox 即可<span class=\"mojikumi-line-end\">。</span>但每次都遇到还是很烦<span class=\"mojikumi-line-end\">，</span>时间久了我还是去研究了一下<span class=\"mojikumi-line-end\">。</span></p>\n<p>根据错误提示以及搜索结果<span class=\"mojikumi-line-end\">，</span>刚开机时又肯定不会有其他 Firefox 进程在跑<span class=\"mojikumi-line-end\">，</span>我一开始主要怀疑是 profile-sync-daemon 在关机前备份时出了问题<span class=\"mojikumi-line-end\">，</span>导致有 lock 之类的没有释放掉就备份了<span class=\"mojikumi-line-end\">。</span></p>\n<p>由于我手动处理的时候都是重启一下 Firefox<span class=\"mojikumi-line-end\">，</span>所以我尝试修复的时候一开始先是写了个脚本自动重启 Firefox<span class=\"mojikumi-line-end\">，</span>发现直接重启不行<span class=\"mojikumi-line-end\">，</span>又尝试用 <code>xdotool</code> / <code>wmctrl</code> 等待报错弹窗出现后再重启<span class=\"mojikumi-line-end\">，</span>发现成功与否不太稳定<span class=\"mojikumi-line-end\">。</span>而进一步地<span class=\"mojikumi-line-end\">，</span>我发现重启这个过程是不必要的<span class=\"mojikumi-line-end\">，</span>重点其实在于<span class=\"mojikumi-line-end\">，</span>要多等待一会儿<span class=\"mojikumi-line-end\">。</span></p>\n<p>于是我去观察了一下刚开机时 profile 的状态<span class=\"mojikumi-line-end\">，</span>终于发现了问题<span class=\"mojikumi-line-end\">。</span>刚开机时 profile directory 会被设为到 <code>/dev/null</code> 的 symlink<span class=\"mojikumi-line-end\">，</span>而在整个 profile 都复制到内存盘后才会替换为正确的 symlink<span class=\"mojikumi-line-end\">，</span>我的 profile 比较大<span class=\"mojikumi-line-start\">（</span>3GB<span class=\"mojikumi\">）</span><span class=\"mojikumi-line-end\">，</span>就需要好几秒<span class=\"mojikumi-line-end\">。</span>只不过 Firefox 给的错误提示非常具有误导性<span class=\"mojikumi-line-end\">，</span>它其实是无法从 <code>/dev/null</code> 正常读取 profile<span class=\"mojikumi-line-end\">，</span>这和 <span class=\"mojikumi\">“</span>already running<span class=\"mojikumi\">”</span> 完全不沾边<span class=\"mojikumi-line-end\">。</span></p>\n<h2 id=\"问题修复\" class=\"heading\"><a href=\"#问题修复\" class=\"heading-anchor\" aria-label=\"章节： 问题修复\" tabindex=\"-1\"></a><span>问题修复</span></h2>\n<p>我的解决方案是写了个启动脚本<span class=\"mojikumi-line-end\">，</span>等待 profile directory 变成正确的 symlink 再启动 Firefox<span class=\"mojikumi-line-end\">：</span></p>\n<section class=\"code-block relative my-6 shadow\" itemprop=\"hasPart\" itemscope itemtype=\"https://schema.org/SoftwareSourceCode\" data-v-c675dba6><div class=\"h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex\" style=\"display:none;\" data-v-c675dba6><h3 class=\"text-3 text-footer\" itemprop=\"programmingLanguage\" aria-label=\"Shell 代码块\" data-v-c675dba6>Shell</h3><ile-root id=\"ile-1\"><button title=\"复制到剪贴板\" class=\"copy-button b-footer text-footer\" data-v-9288569d><span class=\"i-mdi-content-copy\" data-v-9288569d></span><span class=\"sr-only\" role=\"status\" data-v-9288569d></span></button></ile-root><!--ISLAND_HYDRATION_PLACEHOLDER_ile-1--></div><div class=\"dark:hidden\" itemprop=\"text\" data-v-c675dba6><pre class=\"shiki light\" style=\"background-color: #FBFBFB\" tabindex=\"0\"><code><span><span style=\"color: #989FB1\">#!/bin/bash</span></span>\n<span></span>\n<span><span style=\"color: #989FB1\"># Fix &quot;Firefox is already running&quot; at startup when using profile-sync-daemon</span></span>\n<span></span>\n<span><span style=\"color: #4876D6\">set</span><span style=\"color: #403F53\"> </span><span style=\"color: #4876D6\">-euo</span><span style=\"color: #403F53\"> </span><span style=\"color: #4876D6\">pipefail</span></span>\n<span></span>\n<span><span style=\"color: #994CC3\">while</span><span style=\"color: #403F53\"> [[ </span><span style=\"color: #111111\">&quot;</span><span style=\"color: #4876D6\">$(readlink -n ~/.mozilla/firefox/</span><span style=\"color: #0C969B\">*</span><span style=\"color: #4876D6\">.default-release)</span><span style=\"color: #111111\">&quot;</span><span style=\"color: #403F53\"> </span><span style=\"color: #994CC3\">==</span><span style=\"color: #403F53\"> /dev/null ]]; </span><span style=\"color: #994CC3\">do</span></span>\n<span><span style=\"color: #403F53\">    </span><span style=\"color: #4876D6\">sleep</span><span style=\"color: #403F53\"> </span><span style=\"color: #AA0982\">1</span></span>\n<span><span style=\"color: #994CC3\">done</span></span>\n<span></span>\n<span><span style=\"color: #4876D6\">firefox</span><span style=\"color: #403F53\"> &amp;</span></span></code></pre></div><div class=\"dark:important-block\" style=\"display:none;\" data-v-c675dba6><pre class=\"shiki dark\" style=\"background-color: #011627\" tabindex=\"0\"><code><span><span style=\"color: #637777\">#!/bin/bash</span></span>\n<span></span>\n<span><span style=\"color: #637777\"># Fix &quot;Firefox is already running&quot; at startup when using profile-sync-daemon</span></span>\n<span></span>\n<span><span style=\"color: #C5E478\">set</span><span style=\"color: #D6DEEB\"> </span><span style=\"color: #82AAFF\">-euo</span><span style=\"color: #D6DEEB\"> </span><span style=\"color: #ECC48D\">pipefail</span></span>\n<span></span>\n<span><span style=\"color: #C792EA\">while</span><span style=\"color: #D6DEEB\"> [[ </span><span style=\"color: #D9F5DD\">&quot;</span><span style=\"color: #ECC48D\">$(</span><span style=\"color: #82AAFF\">readlink</span><span style=\"color: #ECC48D\"> </span><span style=\"color: #82AAFF\">-n</span><span style=\"color: #ECC48D\"> ~/.mozilla/firefox/</span><span style=\"color: #7FDBCA\">*</span><span style=\"color: #ECC48D\">.default-release)</span><span style=\"color: #D9F5DD\">&quot;</span><span style=\"color: #D6DEEB\"> </span><span style=\"color: #C792EA\">==</span><span style=\"color: #D6DEEB\"> /dev/null ]]; </span><span style=\"color: #C792EA\">do</span></span>\n<span><span style=\"color: #D6DEEB\">    </span><span style=\"color: #82AAFF\">sleep</span><span style=\"color: #D6DEEB\"> </span><span style=\"color: #F78C6C\">1</span></span>\n<span><span style=\"color: #C792EA\">done</span></span>\n<span></span>\n<span><span style=\"color: #82AAFF\">firefox</span><span style=\"color: #D6DEEB\"> &amp;</span></span></code></pre></div></section>\n<p>然后根据 Copilot 的建议改成了非轮询<span class=\"mojikumi-line-end\">，</span>使用 <code>inotifywait</code><span class=\"mojikumi-line-start\">（</span>意义不大<span class=\"mojikumi-line-end\">，</span>主要是学多<span class=\"mojikumi-line-start\">（</span></p>\n<section class=\"code-block relative my-6 shadow\" itemprop=\"hasPart\" itemscope itemtype=\"https://schema.org/SoftwareSourceCode\" data-v-c675dba6><div class=\"h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex\" style=\"display:none;\" data-v-c675dba6><h3 class=\"text-3 text-footer\" itemprop=\"programmingLanguage\" aria-label=\"Shell 代码块\" data-v-c675dba6>Shell</h3><ile-root id=\"ile-2\"><button title=\"复制到剪贴板\" class=\"copy-button b-footer text-footer\" data-v-9288569d><span class=\"i-mdi-content-copy\" data-v-9288569d></span><span class=\"sr-only\" role=\"status\" data-v-9288569d></span></button></ile-root><!--ISLAND_HYDRATION_PLACEHOLDER_ile-2--></div><div class=\"dark:hidden\" itemprop=\"text\" data-v-c675dba6><pre class=\"shiki light\" style=\"background-color: #FBFBFB\" tabindex=\"0\"><code><span><span style=\"color: #989FB1\">#!/bin/bash</span></span>\n<span></span>\n<span><span style=\"color: #989FB1\"># Fix &quot;Firefox is already running&quot; at startup when using profile-sync-daemon</span></span>\n<span></span>\n<span><span style=\"color: #4876D6\">set</span><span style=\"color: #403F53\"> </span><span style=\"color: #4876D6\">-euo</span><span style=\"color: #403F53\"> </span><span style=\"color: #4876D6\">pipefail</span></span>\n<span></span>\n<span><span style=\"color: #4876D6\">profile</span><span style=\"color: #994CC3\">=</span><span style=\"color: #111111\">&quot;</span><span style=\"color: #4876D6\">$(ls -d ~/.mozilla/firefox/</span><span style=\"color: #0C969B\">*</span><span style=\"color: #4876D6\">.default-release)</span><span style=\"color: #111111\">&quot;</span></span>\n<span></span>\n<span><span style=\"color: #994CC3\">while</span><span style=\"color: #403F53\"> [[ </span><span style=\"color: #111111\">&quot;</span><span style=\"color: #4876D6\">$(readlink -n </span><span style=\"color: #111111\">&quot;</span><span style=\"color: #4876D6\">$profile</span><span style=\"color: #111111\">&quot;</span><span style=\"color: #4876D6\">)</span><span style=\"color: #111111\">&quot;</span><span style=\"color: #403F53\"> </span><span style=\"color: #994CC3\">==</span><span style=\"color: #403F53\"> /dev/null ]]; </span><span style=\"color: #994CC3\">do</span></span>\n<span><span style=\"color: #403F53\">    </span><span style=\"color: #4876D6\">inotifywait</span><span style=\"color: #403F53\"> </span><span style=\"color: #4876D6\">-P</span><span style=\"color: #403F53\"> </span><span style=\"color: #111111\">&quot;</span><span style=\"color: #4876D6\">$profile</span><span style=\"color: #111111\">&quot;</span></span>\n<span><span style=\"color: #994CC3\">done</span></span>\n<span></span>\n<span><span style=\"color: #4876D6\">firefox</span><span style=\"color: #403F53\"> &amp;</span></span></code></pre></div><div class=\"dark:important-block\" style=\"display:none;\" data-v-c675dba6><pre class=\"shiki dark\" style=\"background-color: #011627\" tabindex=\"0\"><code><span><span style=\"color: #637777\">#!/bin/bash</span></span>\n<span></span>\n<span><span style=\"color: #637777\"># Fix &quot;Firefox is already running&quot; at startup when using profile-sync-daemon</span></span>\n<span></span>\n<span><span style=\"color: #C5E478\">set</span><span style=\"color: #D6DEEB\"> </span><span style=\"color: #82AAFF\">-euo</span><span style=\"color: #D6DEEB\"> </span><span style=\"color: #ECC48D\">pipefail</span></span>\n<span></span>\n<span><span style=\"color: #C5E478\">profile</span><span style=\"color: #C792EA\">=</span><span style=\"color: #D9F5DD\">&quot;</span><span style=\"color: #ECC48D\">$(</span><span style=\"color: #82AAFF\">ls</span><span style=\"color: #ECC48D\"> </span><span style=\"color: #82AAFF\">-d</span><span style=\"color: #ECC48D\"> ~/.mozilla/firefox/</span><span style=\"color: #7FDBCA\">*</span><span style=\"color: #ECC48D\">.default-release)</span><span style=\"color: #D9F5DD\">&quot;</span></span>\n<span></span>\n<span><span style=\"color: #C792EA\">while</span><span style=\"color: #D6DEEB\"> [[ </span><span style=\"color: #D9F5DD\">&quot;</span><span style=\"color: #ECC48D\">$(</span><span style=\"color: #82AAFF\">readlink</span><span style=\"color: #ECC48D\"> </span><span style=\"color: #82AAFF\">-n</span><span style=\"color: #ECC48D\"> </span><span style=\"color: #D9F5DD\">&quot;</span><span style=\"color: #C5E478\">$profile</span><span style=\"color: #D9F5DD\">&quot;</span><span style=\"color: #ECC48D\">)</span><span style=\"color: #D9F5DD\">&quot;</span><span style=\"color: #D6DEEB\"> </span><span style=\"color: #C792EA\">==</span><span style=\"color: #D6DEEB\"> /dev/null ]]; </span><span style=\"color: #C792EA\">do</span></span>\n<span><span style=\"color: #D6DEEB\">    </span><span style=\"color: #82AAFF\">inotifywait</span><span style=\"color: #D6DEEB\"> </span><span style=\"color: #82AAFF\">-P</span><span style=\"color: #D6DEEB\"> </span><span style=\"color: #D9F5DD\">&quot;</span><span style=\"color: #C5E478\">$profile</span><span style=\"color: #D9F5DD\">&quot;</span></span>\n<span><span style=\"color: #C792EA\">done</span></span>\n<span></span>\n<span><span style=\"color: #82AAFF\">firefox</span><span style=\"color: #D6DEEB\"> &amp;</span></span></code></pre></div></section>\n<p>我是开机时有一个启动脚本启动一堆东西<span class=\"mojikumi-line-end\">，</span>在那里面调用这个 Firefox 启动脚本<span class=\"mojikumi\">。</span><wbr><span class=\"mojikumi-line-start\">（</span>如果是手动启动可以写个 <code>~/.<wbr>local<wbr>/<wbr>share<wbr>/<wbr>applications<wbr>/<wbr>firefox<wbr>.<wbr>desktop</code><span class=\"mojikumi-line-end\">）</span></p>\n<h2 id=\"误导性的报错\" class=\"heading\"><a href=\"#误导性的报错\" class=\"heading-anchor\" aria-label=\"章节： 误导性的报错\" tabindex=\"-1\"></a><span>误导性的报错</span></h2>\n<p>后来去搜了一下<span class=\"mojikumi-line-end\">，</span>发现这个误导性的报错历史悠久<span class=\"mojikumi-line-end\">，</span>20 年前 profile directory 不存在就会报这个<span class=\"mojikumi-line-end\">：</span><a href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=278860\">Bugzilla #278860 - confusing \"profile in use\"/\"already running\" error when profile is missing (not found)</a><span class=\"mojikumi-line-end\">。</span>后来路径不存在的情况修了<span class=\"mojikumi-line-end\">，</span>但 read-only 等 permission error 还是没修<span class=\"mojikumi-line-end\">：</span><a href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=381139\">Bugzilla #381139 - Need different warning for profile RO, in use and missing……</a><span class=\"mojikumi-line-end\">。</span></p>",
            "url": "https://ouuan.moe/post/2024/05/psd-firefox-startup",
            "title": "解决使用 profile-sync-daemon 时 Firefox 开机启动报错",
            "summary": "\n<p>为了提升性能<span class=\"mojikumi-line-end\">，</span>更好地利用 RAM<span class=\"mojikumi-line-end\">，</span>我一直在使用 <a href=\"https://github.com/graysky2/profile-sync-daemon\">profile-sync-daemon</a><span class=\"mojikumi-line-end\">，</span>也经常在开机时遇到下面这个报错<span class=\"mojikumi-line-end\">：</span></p>\n<blockquote>\n<p>Firefox is already running, but is not responding. To use Firefox, you must first close the existing Firefox process, restart your device, or use a different profile.</p>\n</blockquote>\n<p>之前都是把弹窗关掉手动重启一下<span class=\"mojikumi-line-end\">，</span>最近终于去研究了一下把它修了<span class=\"mojikumi-line-end\">。</span></p>\n",
            "date_modified": "2024-05-24T18:31:28.000Z",
            "tags": [
                "firefox",
                "Arch Linux",
                "问题解决记录"
            ]
        }
    ]
}