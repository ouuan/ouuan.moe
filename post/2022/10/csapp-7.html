<!DOCTYPE html><html lang="zh-CN"><head>
    <meta charset="UTF-8">
<title>CS:APP 第七章学习笔记 - ouuan's blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="

CS:APP 第七章 “Linking” 的学习笔记。
这章的主要内容为程序的链接。学习链接有助于：理解链接报错，避免链接相关的 bug，理解变量（函数）的作用域，理解程序运行过程中与链接相关的步骤，了解如何使用共享库（动态链接库）。
">
<meta property="og:url" content="https://ouuan.moe/post/2022/10/csapp-7">
<meta property="og:site_name" content="ouuan's blog">
<meta property="og:title" content="CS:APP 第七章学习笔记 · ouuan's blog">
<meta property="og:description" content="

CS:APP 第七章 “Linking” 的学习笔记。
这章的主要内容为程序的链接。学习链接有助于：理解链接报错，避免链接相关的 bug，理解变量（函数）的作用域，理解程序运行过程中与链接相关的步骤，了解如何使用共享库（动态链接库）。
">
<meta property="twitter:domain" content="ouuan.moe">
<meta property="twitter:title" content="CS:APP 第七章学习笔记 · ouuan's blog">
<meta property="twitter:description" content="

CS:APP 第七章 “Linking” 的学习笔记。
这章的主要内容为程序的链接。学习链接有助于：理解链接报错，避免链接相关的 bug，理解变量（函数）的作用域，理解程序运行过程中与链接相关的步骤，了解如何使用共享库（动态链接库）。
">
<meta property="twitter:url" content="https://ouuan.moe/post/2022/10/csapp-7">
<style>html:not(.dark):not(.light) { visibility: hidden; } body { visibility: hidden; }</style>
<script>(() => { let dark; try { const theme = localStorage && localStorage.getItem('vueuse-color-scheme'); if (theme === 'dark') dark = true; else if (theme === 'light') dark = false; else dark = window.matchMedia('(prefers-color-scheme: dark)').matches; } catch (e) { dark = false; } document.documentElement.classList.add(dark ? 'dark' : 'light'); })()</script>
<noscript><style>@media (prefers-color-scheme: light) { :root:not(.dark):not(.light) { color-scheme: light; --text-color: #232637; --bg-color: #DEE6EE; --card-color: #EFF3F7; --link-color: #1E66B8; --hover-color: #2E80DD; --active-color: #164C89; --bghover-color: #D6E0EA; --popup-color: #F7F9FB; --footer-color: #5F627B; --area-color: #E1E2E8; --nested-color: #F0F0F3; } } @media (prefers-color-scheme: dark) { :root:not(.dark):not(.light) { color-scheme: dark; --text-color: #E6EDF2; --bg-color: #0D0E15; --card-color: #1F2130; --link-color: #8BB8EC; --hover-color: #A2C6F0; --active-color: #74AAE8; --bghover-color: #353853; --popup-color: #2C2F45; --footer-color: #9699AE; --area-color: #2F313D; --nested-color: #3C3E4E; } } html { visibility:visible !important; }</style></noscript>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#a07e5b">
<link rel="canonical" href="https://ouuan.moe/post/2022/10/csapp-7">
<link rel="alternate" type="application/rss+xml" href="/feed.xml" title="RSS Feed - ouuan's blog">
<link rel="alternate" type="application/atom+xml" href="/feed.atom" title="Atom Feed - ouuan's blog">
<link rel="alternate" type="application/json" href="/feed.json" title="JSON Feed - ouuan's blog">
<link rel="dns-prefetch" href="https://plausible.ouuan.moe">
<link rel="preconnect" href="https://blog-visitor-count.ouuan.moe">
<link rel="stylesheet" href="/vendors/katex/katex.css">
<link rel="sitemap" href="https://ouuan.moe/sitemap.xml">
<meta name="author" content="ouuan">
<meta name="twitter:creator" content="@ouuan">
<meta name="twitter:card" content="summary">
<meta property="og:image" content="https://ouuan.moe/images/2022/10/csapp-7.png">
<meta property="generator" content="îles">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-10-31T10:39:06.000Z">
<meta property="article:modified_time" content="2022-12-17T15:45:37.000Z">
<meta property="article:author" content="ouuan">
<meta property="article:tag" content="csapp">
<meta property="article:tag" content="学习笔记">
<link rel="preconnect" href="https://giscus.app">
<link rel="dns-prefetch" href="https://avatars.githubusercontent.com">
    <link rel="stylesheet" href="/assets/style-9a2e8f12.css">
    
  <link rel="modulepreload" href="/assets/iles.189ada06.js" crossorigin=""><link rel="modulepreload" href="/assets/vendor-vue.6a98ea6c.js" crossorigin=""><link rel="modulepreload" href="/assets/vite.5ce4fca4.js" crossorigin=""><link rel="modulepreload" href="/assets/SearchBar.b70cedca.js" crossorigin=""><link rel="modulepreload" href="/assets/TableOfContents.791508cd.js" crossorigin=""><link rel="modulepreload" href="/assets/PostHead.1b922d61.js" crossorigin=""><link rel="modulepreload" href="/assets/VisitorCount.af7e583c.js" crossorigin=""><link rel="modulepreload" href="/assets/site.b21fb919.js" crossorigin=""><link rel="modulepreload" href="/assets/GiscusCommentsInner.c0625d79.js" crossorigin=""><link rel="modulepreload" href="/assets/useTheme.70297bc5.js" crossorigin=""><style>@font-face { font-family: "Noto Serif SC Web Font"; font-weight: 400; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Regular.unique.97f14286.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Regular.unique.877b4ce6.woff') format('woff'); unicode-range: U+0-9f50; } @font-face { font-family: "Noto Serif SC Web Font"; font-weight: 400; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Regular.common.d1edef52.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Regular.common.8c63f142.woff') format('woff'); unicode-range: U+0-ff1b; } @font-face { font-family: "Noto Serif SC Web Font"; font-weight: 700; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Bold.common.f18d0ce7.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Bold.common.851761c1.woff') format('woff'); unicode-range: U+0-7684; }</style><link rel="preload" href="/assets/fonts/NotoSerifSC-Regular.unique.97f14286.woff2" as="font" type="font/woff2" crossorigin=""><link rel="preload" href="/assets/fonts/NotoSerifSC-Regular.common.d1edef52.woff2" as="font" type="font/woff2" crossorigin=""><link rel="preload" href="/assets/fonts/NotoSerifSC-Bold.common.f18d0ce7.woff2" as="font" type="font/woff2" crossorigin=""></head>
  <body itemscope="" itemtype="https://schema.org/ItemPage">
    <div id="app"><header class="bg-card shadow print:hidden" itemprop="hasPart" itemscope="" itemtype="https://schema.org/WPHeader"><div class="flex flex-wrap justify-center whitespace-nowrap px-4 page-container sm:flex-nowrap"><div class="flex basis-full items-stretch justify-center sm:mr-3 sm:basis-auto"><a class="flex items-center p-3 text-xl font-serif bghover" href="/"><span>ouuan<span class="mojikumi-narrow-left">’</span>s blog</span></a></div><nav class="flex"><ul class="flex"><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/"><span>首页</span></a></li><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/posts"><span>文章</span></a></li><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/tags"><span>标签</span></a></li><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/about"><span>关于</span></a></li></ul></nav><div class="sm:basis-full"></div><ul class="flex"><li class="flex"><ile-root id="ile-1"><div class="flex items-stretch lg:hidden"><a class="flex items-center p-2 bghover" href="/search" title="全站搜索"><span class="i-mdi-magnify text-xl"></span></a></div><form role="search" class="hidden items-stretch justify-center lg:flex"><div class="flex items-center"><input value="" class="w-48 rd-full bg-area px-3 py-1" type="search" placeholder="关键词" aria-label="全站搜索"></div><a class="flex items-center p-2 bghover" href="/search?q=" title="全站搜索"><span class="i-mdi-magnify text-xl"></span></a></form></ile-root><script></script><script type="module" async="">import{h as r,c as a}from"/assets/iles.189ada06.js";import{_ as m}from"/assets/SearchBar.b70cedca.js";import"/assets/vendor-vue.6a98ea6c.js";import"/assets/vite.5ce4fca4.js";r(a,m,"ile-1",{},{});
</script></li><li class="flex items-stretch"><a class="flex items-center p-2 bghover" href="/feed.xml" title="RSS 订阅"><span class="i-mdi-rss text-xl"></span></a></li><li class="flex"><ile-root id="ile-2"><div class="relative flex items-stretch"><button title="暗色模式设置" class="flex items-center p-2 bghover" aria-haspopup="menu" aria-controls="__theme-switcher" aria-expanded="false"><span class="i-mdi-theme-light-dark text-xl"></span></button><ul style="display:none;" id="__theme-switcher" class="absolute right-0 top-full z-20 whitespace-nowrap rd-1 bg-popup shadow-md" role="menu" aria-label="暗色模式选项"><li class="bghover" role="menuitemradio" aria-checked="true"><button class="flex items-center p-1 text-hover"><span class="i-mdi-cellphone md:i-mdi-tablet lg:i-mdi-monitor mr-1"></span><span>跟随系统</span></button></li><li class="bghover" role="menuitemradio" aria-checked="false"><button class="flex items-center p-1"><span class="i-mdi-white-balance-sunny mr-1"></span><span>总是亮色</span></button></li><li class="bghover" role="menuitemradio" aria-checked="false"><button class="flex items-center p-1"><span class="i-mdi-weather-night mr-1"></span><span>总是暗色</span></button></li></ul></div></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.189ada06.js";import"/assets/vendor-vue.6a98ea6c.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.189ada06.js").then(o=>o.v),["assets/iles.189ada06.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/ThemeSwitcher.287bb433.js"),["assets/ThemeSwitcher.287bb433.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js","assets/useTheme.70297bc5.js"])).default});s(u,v,"ile-2",{},{})});export default E();
</script></li></ul></div></header><main class="min-h-100vh py-6 page-container" itemprop="mainContentOfPage" itemscope="" itemtype="https://schema.org/WebPageElement"><div class="flex flex-row-reverse justify-center"><ile-root id="ile-3"><div class="flex print:hidden"><aside style="max-height:calc(100vh - 10rem);" id="__toc" class="sticky top-16 m-4 hidden w-72 rd-2 bg-card py-6 shadow xl:block 2xl:w-84 3xl:w-96" aria-label="文章目录" itemprop="hasPart" itemscope="" itemtype="https://schema.org/WPSideBar"><div class="mb-3 flex flex-wrap items-center justify-between gap-2 pl-8 pr-4"><div class="flex items-center"><h2 class="text-xl font-bold"> 文章目录 </h2><button id="__toc-close" class="flex items-center px-1 text-xl" title="关闭目录" aria-controls="__toc" aria-expanded="true"><span class="i-mdi-close"></span></button></div></div><div style="max-height:calc(100% - 2rem);" class="overflow-auto overscroll-contain pl-8 pr-4"><ol data-v-c5806953=""><li id="__toc-item-compiler-drivers" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#compiler-drivers" data-v-c5806953=""><span data-v-c5806953="">Compiler Drivers</span></a></li><li id="__toc-item-static-linking" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#static-linking" data-v-c5806953=""><span data-v-c5806953="">Static Linking</span></a></li><li id="__toc-item-object-files" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#object-files" data-v-c5806953=""><span data-v-c5806953="">Object Files</span></a></li><li id="__toc-item-relocatable-object-files" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#relocatable-object-files" data-v-c5806953=""><span data-v-c5806953="">Relocatable Object Files</span></a></li><li id="__toc-item-symbols-and-symbol-tables" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#symbols-and-symbol-tables" data-v-c5806953=""><span data-v-c5806953="">Symbols and Symbol Tables</span></a></li><li id="__toc-item-symbol-resolution" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#symbol-resolution" data-v-c5806953=""><span data-v-c5806953="">Symbol Resolution</span></a></li><li id="__toc-item-static-libraries" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#static-libraries" data-v-c5806953=""><span data-v-c5806953="">Static Libraries</span></a></li><li id="__toc-item-relocation" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#relocation" data-v-c5806953=""><span data-v-c5806953="">Relocation</span></a></li><li id="__toc-item-executable-object-files" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#executable-object-files" data-v-c5806953=""><span data-v-c5806953="">Executable Object Files</span></a></li><li id="__toc-item-loading-executable-object-files" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#loading-executable-object-files" data-v-c5806953=""><span data-v-c5806953="">Loading Executable Object Files</span></a></li><li id="__toc-item-dynamic-linking-with-shared-libraries" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#dynamic-linking-with-shared-libraries" data-v-c5806953=""><span data-v-c5806953="">Dynamic Linking with Shared Libraries</span></a></li><li id="__toc-item-loading-and-linking-shared-libraries-from-applications" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#loading-and-linking-shared-libraries-from-applications" data-v-c5806953=""><span data-v-c5806953="">Loading and Linking Shared Libraries from Applications</span></a></li><li id="__toc-item-position-independent-code-pic" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#position-independent-code-pic" data-v-c5806953=""><span data-v-c5806953="">Position-Independent Code (PIC)</span></a></li><li id="__toc-item-library-interpositioning" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#library-interpositioning" data-v-c5806953=""><span data-v-c5806953="">Library Interpositioning</span></a></li></ol></div></aside><button style="display:none;" id="__toc-open" title="显示文章目录" class="bottom-24 text-lg floating-button" aria-haspopup="dialog" aria-controls="__toc" aria-expanded="true"><span class="i-mdi-menu"></span></button></div></ile-root><script></script><script type="module" async="">import{h as l,c as i}from"/assets/iles.189ada06.js";import{_ as t}from"/assets/TableOfContents.791508cd.js";import"/assets/vendor-vue.6a98ea6c.js";import"/assets/vite.5ce4fca4.js";l(i,t,"ile-3",function(e){return{headings:[{level:e,title:"Compiler Drivers",slug:"compiler-drivers"},{level:e,title:"Static Linking",slug:"static-linking"},{level:e,title:"Object Files",slug:"object-files"},{level:e,title:"Relocatable Object Files",slug:"relocatable-object-files"},{level:e,title:"Symbols and Symbol Tables",slug:"symbols-and-symbol-tables"},{level:e,title:"Symbol Resolution",slug:"symbol-resolution"},{level:e,title:"Static Libraries",slug:"static-libraries"},{level:e,title:"Relocation",slug:"relocation"},{level:e,title:"Executable Object Files",slug:"executable-object-files"},{level:e,title:"Loading Executable Object Files",slug:"loading-executable-object-files"},{level:e,title:"Dynamic Linking with Shared Libraries",slug:"dynamic-linking-with-shared-libraries"},{level:e,title:"Loading and Linking Shared Libraries from Applications",slug:"loading-and-linking-shared-libraries-from-applications"},{level:e,title:"Position-Independent Code (PIC)",slug:"position-independent-code-pic"},{level:e,title:"Library Interpositioning",slug:"library-interpositioning"}]}}(2),{});
</script><div class="grow m-4 standard-card max-w-200"><article itemprop="mainEntity" itemscope="" itemtype="https://schema.org/BlogPosting"><div class="hidden" itemscope="" itemtype="https://schema.org/Person" itemprop="author"><meta itemprop="name" content="ouuan"><meta itemprop="givenName" content="Yufan"><meta itemprop="familyName" content="You"><meta itemprop="url" content="https://github.com/ouuan"><link itemprop="gender" href="https://schema.org/Male"><meta itemprop="image" content="/android-chrome-512x512.png"></div><meta itemprop="mainEntityOfPage" content="https://ouuan.moe/post/2022/10/csapp-7"><meta itemprop="image" content="https://ouuan.moe/images/2022/10/csapp-7.png"><ile-root id="ile-4" class="my-12"><header class="my-12" data-v-4039c18a=""><h1 class="mb-3 mt-6 text-center text-8" itemprop="headline" data-v-4039c18a=""><span class="inline-block font-serif break-anywhere" data-v-4039c18a="">CS:APP 第七章学习笔记</span></h1><div class="flex flex-wrap justify-center gap-x-4 gap-y-1 text-footer md:text-sm" data-v-4039c18a=""><span class="flex items-center" title="创建于 2022-10-17 10:56:55 GMT+8" data-v-4039c18a=""><span class="i-mdi-folder-plus-outline mr-1" data-v-4039c18a=""></span><span class="sr-only" data-v-4039c18a="">创建于</span><a class="hover:underline" href="https://github.com/ouuan/iles-blog/blob/master/src/pages/post/2022/10/csapp-7.mdx?plain=1" data-v-4039c18a=""><time datetime="2022-10-17T10:56:55+08:00" itemprop="dateCreated" data-v-4039c18a="">2022-10-17</time></a></span><span class="flex items-center" title="修改于 2022-12-17 23:45:37 GMT+8" data-v-4039c18a=""><span class="i-mdi-update mr-1" data-v-4039c18a=""></span><span class="sr-only" data-v-4039c18a="">修改于</span><a class="hover:underline" href="https://github.com/ouuan/iles-blog/commits/master/src/pages/post/2022/10/csapp-7.mdx" data-v-4039c18a=""><time datetime="2022-12-17T23:45:37+08:00" itemprop="dateModified" data-v-4039c18a="">2022-12-17</time></a></span><span class="flex items-center" title="访问量" data-v-4039c18a=""><span class="i-mdi-eye-outline mr-1" data-v-4039c18a=""></span><span class="sr-only" data-v-4039c18a="">访问量</span><span data-v-4039c18a="">80</span></span><span class="flex flex-wrap justify-center gap-x-2 gap-y-1" data-v-4039c18a=""><span title="标签: csapp" class="flex items-center" itemprop="keywords" data-v-4039c18a=""><span class="i-mdi-tag-outline mr-1" data-v-4039c18a=""></span><span class="sr-only" data-v-4039c18a="">标签</span><a href="/tag/csapp" class="hover:underline" data-v-4039c18a="">csapp</a></span><span title="标签: 学习笔记" class="flex items-center" itemprop="keywords" data-v-4039c18a=""><span class="i-mdi-tag-outline mr-1" data-v-4039c18a=""></span><span class="sr-only" data-v-4039c18a="">标签</span><a href="/tag/学习笔记" class="hover:underline" data-v-4039c18a="">学习笔记</a></span></span></div></header></ile-root><script></script><script type="module" async="">import{h as t,c as e}from"/assets/iles.189ada06.js";import p from"/assets/PostHead.1b922d61.js";import"/assets/vendor-vue.6a98ea6c.js";import"/assets/vite.5ce4fca4.js";import"/assets/VisitorCount.af7e583c.js";import"/assets/site.b21fb919.js";t(e,p,"ile-4",{class:"my-12",href:"/post/2022/10/csapp-7",filename:"src/pages/post/2022/10/csapp-7.mdx",frontmatter:{title:"CS:APP 第七章学习笔记",date:new Date(1665975415e3),image:"/images/2022/10/csapp-7.png",copyrightNotice:"本文包含少量直接从 CS:APP 中复制的代码、图片，本文作者对其不拥有版权。",tags:["csapp","学习笔记"],lastUpdated:new Date(1671291937e3),published:new Date(1667212746e3),visitor:80,description:`

CS:APP 第七章 “Linking” 的学习笔记。
这章的主要内容为程序的链接。学习链接有助于：理解链接报错，避免链接相关的 bug，理解变量（函数）的作用域，理解程序运行过程中与链接相关的步骤，了解如何使用共享库（动态链接库）。
`}},{});
</script><section class="article-style" itemprop="articleBody">

<p><a href="https://csapp.cs.cmu.edu/">CS:APP</a> 第七章 <span class="mojikumi">“</span>Linking<span class="mojikumi">”</span> 的学习笔记<span class="mojikumi-line-end">。</span></p>
<p>这章的主要内容为程序的链接<span class="mojikumi-line-end">。</span>学习链接有助于<span class="mojikumi-line-end">：</span>理解链接报错<span class="mojikumi-line-end">，</span>避免链接相关的 bug<span class="mojikumi-line-end">，</span>理解变量<span class="mojikumi-line-start">（</span>函数<span class="mojikumi-line-end">）</span>的作用域<span class="mojikumi-line-end">，</span>理解程序运行过程中与链接相关的步骤<span class="mojikumi-line-end">，</span>了解如何使用共享库<span class="mojikumi-line-start">（</span>动态链接库<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></p>

<h2 id="compiler-drivers" class="heading"><a href="#compiler-drivers" class="heading-anchor" aria-label="章节： Compiler Drivers" tabindex="-1"></a><span>Compiler Drivers</span></h2>
<p>编译源文件其实分成若干步骤<span class="mojikumi-line-end">，</span>compiler driver<span class="mojikumi-line-start">（</span>如 gcc<span class="mojikumi-line-end">）</span>会依次调用这些步骤<span class="mojikumi-line-end">，</span>可以用 <code>gcc -v</code> 来查看这些步骤的详细信息<span class="mojikumi-line-end">。</span></p>
<ol>
<li><code>cpp</code>: 预处理<span class="mojikumi-line-end">，</span>源代码 <code>.c</code> -&gt;  intermediate file <code>.i</code></li>
<li><code>cc1</code>: <code>.i</code> -&gt; 汇编代码 <code>.s</code></li>
<li><code>as</code>: <code>.s</code> -&gt; relocatable object file <code>.o</code></li>
<li><code>ld</code>: 链接<span class="mojikumi-line-end">，</span>多个 <code>.o</code> (或 library) -&gt; executable object file</li>
</ol>
<p>P.S. 中间步骤的文件也可以作为参数传递给 <code>gcc</code><span class="mojikumi-line-end">，</span>例如 <code>gcc a.s -o a</code><span class="mojikumi-line-end">。</span></p>
<h2 id="static-linking" class="heading"><a href="#static-linking" class="heading-anchor" aria-label="章节： Static Linking" tabindex="-1"></a><span>Static Linking</span></h2>
<p>静态链接主要有两个任务<span class="mojikumi-line-end">：</span></p>
<ol>
<li><i>Symbol resolution</i>: relocatable object file 中有很多 symbol<span class="mojikumi-line-end">，</span>包括函数<span class="mojikumi-line-end">、</span>全局变量<span class="mojikumi-line-end">、</span>静态变量等<span class="mojikumi-line-end">，</span>linker 需要将每个 symbol reference 对应到一个 symbol definition<span class="mojikumi-line-end">。</span></li>
<li><i>Relocation</i>: relocatable object file 中地址从 0 开始<span class="mojikumi-line-end">，</span>linker 需要将每个 symbol definition 重新分配到正确的地址<span class="mojikumi-line-end">，</span>并相应地修改每个 symbol reference<span class="mojikumi-line-end">。</span></li>
</ol>
<h2 id="object-files" class="heading"><a href="#object-files" class="heading-anchor" aria-label="章节： Object Files" tabindex="-1"></a><span>Object Files</span></h2>
<p>object file 分为三种<span class="mojikumi-line-end">：</span></p>
<ol>
<li>Relocatable object file</li>
<li>Executable object file</li>
<li>Shared object file: 一种特殊的 relocatable object file<span class="mojikumi-line-end">，</span>可以在 load time 或 run time 进行动态链接</li>
</ol>
<p>object file 有不同的格式<span class="mojikumi-line-end">，</span>Windows 使用 Portable Executable (PE) 格式<span class="mojikumi-line-end">，</span>macOS 使用 Mach-O 格式<span class="mojikumi-line-end">，</span>现代的 x86-64 Linux/Unix 系统使用 Executable and Linkable Format (ELF) 格式<span class="mojikumi-line-end">。</span>本章会基于 ELF-64<span class="mojikumi-line-end">。</span></p>
<h2 id="relocatable-object-files" class="heading"><a href="#relocatable-object-files" class="heading-anchor" aria-label="章节： Relocatable Object Files" tabindex="-1"></a><span>Relocatable Object Files</span></h2>
<p>ELF relocatable object file 通常包含以下 section<span class="mojikumi-line-end">：</span></p>
<ol>
<li><code>.text</code>: 程序的机器码</li>
<li><code>.rodata</code>: 只读的数据</li>
<li><code>.data</code>: 需要初始化的全局变量和静态变量</li>
<li><code>.bss</code>: 未初始化或初始化为零的全局变量和静态变量<span class="mojikumi-line-end">，</span>它们在运行时会以零为初值<span class="mojikumi-line-end">，</span>从而在 object file 中不占据文件大小</li>
<li><code>.symtab</code>: symbol table<span class="mojikumi-line-end">，</span>存储 symbol<span class="mojikumi-line-start">（</span>函数<span class="mojikumi-line-end">、</span>全局变量<span class="mojikumi-line-end">）</span>的信息<span class="mojikumi-line-end">，</span>不需要 <code>-g</code> 编译选项<span class="mojikumi-line-end">，</span>但不含局部变量的信息</li>
<li><code>.rel.text</code>: 列出了 <code>.text</code> 中在链接时需要修改的地方<span class="mojikumi-line-end">，</span>一般是调用外部函数或引用全局变量时需要修改<span class="mojikumi-line-end">，</span>而 <a href="/post/2022/09/csapp-3#jump-%E6%8C%87%E4%BB%A4%E7%BC%96%E7%A0%81">调用本地函数不需要修改</a></li>
<li><code>.rel.data</code>: 列出了 <code>.data</code> 中在链接时需要修改的地方<span class="mojikumi-line-end">，</span>一般是全局变量的值为其他全局变量或外部函数的地址时需要修改</li>
<li><code>.debug</code>: 调试信息<span class="mojikumi-line-end">，</span>包含局部变量的信息<span class="mojikumi-line-end">、</span>typedef 信息<span class="mojikumi-line-end">、</span>源代码等<span class="mojikumi-line-end">，</span>需要 <code>-g</code> 编译选项才有</li>
<li><code>.line</code>: 源代码与机器码行号间的对应关系<span class="mojikumi-line-end">，</span>需要 <code>-g</code> 编译选项才有</li>
<li><code>.strtab</code>: 一堆字符<span class="mojikumi-line-end">，</span>用于其它 section<span class="mojikumi-line-end">，</span>可以指向其中一个位置来表示一个字符串<span class="mojikumi-line-start">（</span>从这个位置起到 <code>\0</code> 为止<span class="mojikumi-line-end">）</span></li>
</ol>
<h2 id="symbols-and-symbol-tables" class="heading"><a href="#symbols-and-symbol-tables" class="heading-anchor" aria-label="章节： Symbols and Symbol Tables" tabindex="-1"></a><span>Symbols and Symbol Tables</span></h2>
<p>对 linker 来说<span class="mojikumi-line-end">，</span>symbol 有三种<span class="mojikumi-line-end">：</span></p>
<ol>
<li>本地定义<span class="mojikumi-line-end">，</span>可以被外部访问的: C 中非 <code>static</code> 的函数和全局变量</li>
<li>外部定义的<span class="mojikumi-line-end">，</span>例如 C 中 <code>extern</code> 的全局变量</li>
<li>本地定义<span class="mojikumi-line-end">，</span>外部不可访问的: C 中 <code>static</code> 的函数和变量</li>
</ol>
<p>一个 ELF64 symbol 包含如下信息<span class="mojikumi-line-start">（</span>CS:APP Figure 7.4<span class="mojikumi">）</span><span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h3 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="c 代码块" data-v-ad49d235="">c</h3><ile-root id="ile-5"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.189ada06.js";import"/assets/vendor-vue.6a98ea6c.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.189ada06.js").then(i=>i.v),["assets/iles.189ada06.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.fcf5587c.js"),["assets/CopyButton.fcf5587c.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-5",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #C792EA">typedef</span><span style="color: #D6DEEB"> </span><span style="color: #C792EA">struct</span></span>
<span><span style="color: #D6DEEB">{</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">int</span><span style="color: #D6DEEB">   name;</span><span style="color: #637777">      /* String table offset */</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">char</span><span style="color: #D6DEEB">  type:</span><span style="color: #F78C6C">4</span><span style="color: #D6DEEB">,</span><span style="color: #637777">    /* Function or data (4 bits) */</span></span>
<span><span style="color: #D6DEEB">          binding:</span><span style="color: #F78C6C">4</span><span style="color: #D6DEEB">;</span><span style="color: #637777"> /* Local or global (4 bits) */</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">char</span><span style="color: #D6DEEB">  reserved;</span><span style="color: #637777">  /* Unused */</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">short</span><span style="color: #D6DEEB"> section;</span><span style="color: #637777">   /* Section header index */</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">long</span><span style="color: #D6DEEB">  value;</span><span style="color: #637777">     /* Section offset or absolute address */</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">long</span><span style="color: #D6DEEB">  size;</span><span style="color: #637777">      /* Object size in bytes */</span></span>
<span><span style="color: #D6DEEB">} Elf64_Symbol;</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #994CC3">typedef</span><span style="color: #403F53"> </span><span style="color: #994CC3">struct</span></span>
<span><span style="color: #403F53">{</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">int</span><span style="color: #403F53">   name;</span><span style="color: #989FB1">      /* String table offset */</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">char</span><span style="color: #403F53">  type:</span><span style="color: #AA0982">4</span><span style="color: #403F53">,</span><span style="color: #989FB1">    /* Function or data (4 bits) */</span></span>
<span><span style="color: #403F53">          binding:</span><span style="color: #AA0982">4</span><span style="color: #403F53">;</span><span style="color: #989FB1"> /* Local or global (4 bits) */</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">char</span><span style="color: #403F53">  reserved;</span><span style="color: #989FB1">  /* Unused */</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">short</span><span style="color: #403F53"> section;</span><span style="color: #989FB1">   /* Section header index */</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">long</span><span style="color: #403F53">  value;</span><span style="color: #989FB1">     /* Section offset or absolute address */</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">long</span><span style="color: #403F53">  size;</span><span style="color: #989FB1">      /* Object size in bytes */</span></span>
<span><span style="color: #403F53">} Elf64_Symbol;</span></span></code></pre></div></section>
<p><code>value</code> 在 relocatable object file 中是 symbol 的地址相对于 section 开头的 offset<span class="mojikumi-line-end">，</span>在 executable object file 中是 symbol 的绝对地址<span class="mojikumi-line-end">。</span></p>
<p><code>section</code> 是 object file 的 section 之一<span class="mojikumi-line-start">（</span>的 index<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>在 relocatable object file 中还可以是一个 pseudosection:</p>
<ul>
<li>ABS: 不应被 relocate 的 symbol</li>
<li>UNDEF: 未定义<span class="mojikumi-line-start">（</span>在其他 module 中定义<span class="mojikumi-line-end">）</span>的 symbol</li>
<li>COMMON: 多个 module 共用的 symbol<span class="mojikumi-line-start">（</span>见 <a href="#symbol-resolution">Symbol Resolution</a><span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>此时 <code>value</code> 的值给出 data alignment 的要求<span class="mojikumi-line-end">，</span><code>size</code> 给出的是 minimum size</li>
</ul>
<p>未初始化的静态变量以及初始化为零的全局或静态变量会放在 <code>.bss</code><span class="mojikumi-line-end">。</span></p>
<p>未初始化的全局变量<span class="mojikumi-line-end">，</span>如果启用了 <code>-fcommon</code> 编译选项则会放在 COMMON<span class="mojikumi-line-end">，</span>否则放在 <code>.bss</code><span class="mojikumi-line-end">。</span>在 gcc 9 及之前默认选项是 <code>-fcommon</code><span class="mojikumi-line-end">，</span>而自 gcc 10 起默认选项是 <code>-<wbr>fno<wbr>-<wbr>common</code><span class="mojikumi-line-end">。</span>在 C++ 中 <code>-fcommon</code> 是无效的<span class="mojikumi-line-end">，</span>未初始化的全局变量总是放在 <code>.bss</code><span class="mojikumi-line-end">。</span></p>
<p>可以使用 <code>readelf -s a.o</code> 来查看 <code>a.o</code> 的 <code>.symtab</code><span class="mojikumi-line-end">。</span></p>
<h2 id="symbol-resolution" class="heading"><a href="#symbol-resolution" class="heading-anchor" aria-label="章节： Symbol Resolution" tabindex="-1"></a><span>Symbol Resolution</span></h2>
<p>Symbol resolution 即把每个 symbol reference 对应到一个 symbol definition<span class="mojikumi-line-end">。</span></p>
<p>local symbol 的 resolution 是容易的<span class="mojikumi-line-end">，</span>因为编译单个 module 时就保证了 local symbol 是唯一的<span class="mojikumi-line-end">。</span></p>
<p>global symbol 可能遇到几种情况<span class="mojikumi-line-end">：</span></p>
<ul>
<li>只有一个 module 里定义了这个 global symbol<span class="mojikumi-line-end">，</span>则使用这个 symbol</li>
<li>没有任何 module 里定义了这个 global symbol<span class="mojikumi-line-end">，</span>则报错 undefined reference</li>
<li>在多个 module 里定义了这个 global symbol<span class="mojikumi-line-end">，</span>则<span class="mojikumi-line-end">：</span>
<ul>
<li>如果其中有多个 symbol 不在 COMMON 段<span class="mojikumi-line-end">，</span>则报错 multiple definition</li>
<li>如果其中只有一个不在 COMMON 段<span class="mojikumi-line-end">，</span>则使用这个 symbol</li>
<li>如果这些 symbol 都在 COMMON 段<span class="mojikumi-line-end">，</span>则使用其中 <code>size</code> 最大的一个<span class="mojikumi-line-start">（</span>如果 <code>size</code> 相同则使用哪个是没有区别的<span class="mojikumi">）</span><span class="mojikumi-line-end">；</span>如果这些 symbol 有不一样的 <code>size</code><span class="mojikumi-line-end">，</span>linker 还会给出警告</li>
</ul>
</li>
</ul>
<p>也就是说<span class="mojikumi-line-end">，</span>若编译选项为 <code>-fcommon</code><span class="mojikumi-line-end">，</span>如果在多个 module 中定义了同一个全局变量且其中最多有一个初始化了<span class="mojikumi-line-end">，</span>则可能导致意外的结果<span class="mojikumi-line-end">。</span>可以理解为<span class="mojikumi-line-end">，</span>multiple definition 在本质上是 multiple initialization<span class="mojikumi-line-end">。</span></p>
<p>在 C++ 中<span class="mojikumi-line-end">，</span>函数重载<span class="mojikumi-line-end">、</span>类方法会通过 <i>mangling</i> 来使得函数的每种重载有独特的 symbol name<span class="mojikumi-line-end">。</span></p>
<h2 id="static-libraries" class="heading"><a href="#static-libraries" class="heading-anchor" aria-label="章节： Static Libraries" tabindex="-1"></a><span>Static Libraries</span></h2>
<p>Static library 其实就是一堆 object file 包装在一起<span class="mojikumi-line-end">，</span>它的好处是<span class="mojikumi-line-end">：</span></p>
<ol>
<li>不用每次重新编译<span class="mojikumi-line-start">（</span>比起提供源码<span class="mojikumi-line-end">）</span></li>
<li>使得库和编译器解耦<span class="mojikumi-line-start">（</span>比起将库函数内置到编译器中<span class="mojikumi-line-end">）</span></li>
<li>只需将用到的 object file 复制到最终的可执行文件中<span class="mojikumi-line-end">，</span>避免空间浪费<span class="mojikumi-line-start">（</span>比起提供单个 object file<span class="mojikumi-line-end">）</span></li>
<li>可以自动选择用到的 object file<span class="mojikumi-line-end">，</span>在编译命令中只需指定少量库的名称<span class="mojikumi-line-start">（</span>比起提供一堆 object file<span class="mojikumi-line-end">）</span></li>
</ol>
<p>可以使用类似 <code>ar rcs libabc.a a.o b.o c.o</code> 的命令来创建一个 static library<span class="mojikumi-line-end">。</span></p>
<p>在编译时<span class="mojikumi-line-end">，</span>有两种使用 static library 的方式<span class="mojikumi-line-end">：</span></p>
<ul>
<li>直接将 static library 的路径作为参数: <code>libabc.a</code></li>
<li>使用 <code>-lname</code> 来使用 <code>libname.a</code><span class="mojikumi-line-end">，</span>但需要使用 <code>-Ldir</code> 来将 <code>dir</code> 加入到 <code>-l</code> 的搜索路径之中: <code>-L. -labc</code></li>
</ul>
<p>特别地<span class="mojikumi-line-end">，</span>编译器会自动将 <code>libc.a</code> 提供给 linker<span class="mojikumi-line-end">，</span>不需要手动指定<span class="mojikumi-line-end">。</span></p>
<p>在链接时<span class="mojikumi-line-end">，</span>linker 会依次处理每个参数<span class="mojikumi-line-end">：</span></p>
<ul>
<li>如果一个参数是 object file 就一定会使用</li>
<li>如果是 static library<span class="mojikumi-line-end">，</span>则会依次查看其中包含的每一个 object file<span class="mojikumi-line-end">，</span>如果一个 object file 中定义了某个当前引用了但仍未定义的 symbol<span class="mojikumi-line-end">，</span>则会使用这个 object file<span class="mojikumi-line-end">，</span>而这样的过程会反复迭代进行直到没有新的 object file 被使用为止<span class="mojikumi-line-start">（</span>例如 <code>main.c</code> 引用了 <code>b.o</code> 而没有引用 <code>a.o</code><span class="mojikumi-line-end">，</span>而 <code>b.o</code> 中引用了 <code>a.o</code><span class="mojikumi-line-end">，</span>且在 <code>libabc.a</code> 中 <code>a.o</code> 位于 <code>b.o</code> 之前<span class="mojikumi-line-end">，</span>那么第一次迭代中只会使用 <code>b.o</code><span class="mojikumi-line-end">，</span>第二次迭代才会使用 <code>a.o</code><span class="mojikumi-line-end">，</span>而 <code>c.o</code> 不会被使用<span class="mojikumi-line-end">）</span></li>
</ul>
<p>这样的过程使得编译命令中参数的顺序以及 static library 中 object file 的顺序可能影响编译结果<span class="mojikumi-line-end">：</span></p>
<ul>
<li>一般来说需要将 library 放在编译命令的末尾<span class="mojikumi-line-end">，</span>否则处理一个 library 时还没有引用其中的 symbol<span class="mojikumi-line-end">，</span>就不会使用相应的 object file<span class="mojikumi-line-end">，</span>最后就会报错 undefined reference</li>
<li>如果多个 library 之间有依赖关系<span class="mojikumi-line-end">，</span>需要将被其他 library 依赖的 library 放在靠后的位置</li>
<li>如果多个 library 之间有循环依赖<span class="mojikumi-line-end">，</span>可能需要在编译命令中多次指定同一个 library<span class="mojikumi-line-start">（</span>或者也可以将这两个 library 合并成一个<span class="mojikumi-line-end">，</span>这样的话通过多次迭代就可以解决循环依赖<span class="mojikumi-line-end">）</span></li>
<li>library 的设计应当避免 multiple definition<span class="mojikumi-line-end">，</span>但理论上存在不同的参数顺序或 static library 中 object file 的顺序导致 multiple definition 的可能</li>
</ul>
<h2 id="relocation" class="heading"><a href="#relocation" class="heading-anchor" aria-label="章节： Relocation" tabindex="-1"></a><span>Relocation</span></h2>
<p>relocation 分为两步<span class="mojikumi-line-end">：</span></p>
<ol>
<li>给 symbol definition 重新分配内存地址</li>
<li>相应地修改 symbol reference</li>
</ol>
<p>第一步是简单的<span class="mojikumi-line-end">，</span>把各个 object file 中的各个 section 分别拼在一起即可<span class="mojikumi-line-end">。</span></p>
<p>为了让 linker 知道如何修改 symbol reference<span class="mojikumi-line-end">，</span>需要让 linker 知道<span class="mojikumi-line-end">：</span></p>
<ol>
<li>需要被修改的 symbol reference 在哪</li>
<li>需要修改成什么</li>
</ol>
<p>在 relocatable object file 的 <code>.rel.text</code> 和 <code>.rel.data</code> 中存放了相关的信息<span class="mojikumi-line-end">，</span>一条这样的信息称作一个 relocation entry<span class="mojikumi-line-end">，</span>包含的内容为<span class="mojikumi-line-end">：</span></p>
<ul>
<li><code>offset</code>: 这个 symbol reference 相对于其所在的 section 的偏移量<span class="mojikumi-line-end">。</span>也就是说<span class="mojikumi-line-end">，</span>在这个 reference 所在的 section 的地址的基础上加上 <code>offset</code> 就得到了这个 reference 的地址<span class="mojikumi-line-end">。</span></li>
<li><code>type</code>: 有很多种 relocation<span class="mojikumi-line-end">，</span>CS:APP 中只介绍其中的 <code>R_<wbr>X86_<wbr>64_<wbr>PC32</code> 和 <code>R_X86_64_32</code> 两种<span class="mojikumi-line-end">。</span></li>
<li><code>symbol</code>: 被 reference 的 symbol 在 symbol table 中的 index<span class="mojikumi-line-end">。</span></li>
<li><code>addend</code>: 计算 symbol 地址时加在最后的常数<span class="mojikumi-line-start">（</span>见后文<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></li>
</ul>
<p>简单来说<span class="mojikumi-line-end">，</span><code>R_X86_64_32</code> 使用绝对地址进行定位<span class="mojikumi-line-end">，</span><code>R_<wbr>X86_<wbr>64_<wbr>PC32</code> 使用相对于 PC 的地址进行定位<span class="mojikumi-line-end">，</span>且这两种类型的 relocation 都只支持 32 位的地址<span class="mojikumi-line-start">（</span>如果一个程序的大小超过 2GB<span class="mojikumi-line-end">，</span>就需要指定编译选项 <code>-<wbr>mcmodel<wbr>=<wbr>medium<wbr>/<wbr>large</code><span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>R_X86_64_32</code>: 修改后的 reference 为 symbol 的地址加上 <code>addend</code></li>
<li><code>R_<wbr>X86_<wbr>64_<wbr>PC32</code>: 修改后的 reference 为 symbol 的地址与 reference 的地址之差加上 <code>addend</code><span class="mojikumi-line-end">；</span>需要注意的是<span class="mojikumi-line-end">，</span>是与 reference 的地址之差<span class="mojikumi-line-end">，</span>而不是与执行到 reference 所在语句时的 PC 之差<span class="mojikumi-line-end">，</span>所以通常会需要通过 <code>addend</code> 来修正</li>
</ul>
<p>可以使用 <code>objdump -dx</code> 以在反汇编结果中显示 relocation entry<span class="mojikumi-line-end">，</span>或者使用 <code>readelf -r</code> 显示所有 relocation entry<span class="mojikumi-line-end">。</span></p>
<p>例如<span class="mojikumi-line-end">，</span>使用 GCC 8.5 编译</p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h3 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="c 代码块" data-v-ad49d235="">c</h3><ile-root id="ile-6"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.189ada06.js";import"/assets/vendor-vue.6a98ea6c.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.189ada06.js").then(i=>i.v),["assets/iles.189ada06.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.fcf5587c.js"),["assets/CopyButton.fcf5587c.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-6",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #C792EA">int</span><span style="color: #D6DEEB"> </span><span style="color: #82AAFF">foo</span><span style="color: #D6DEEB">(</span><span style="color: #C792EA">int</span><span style="color: #D6DEEB"> </span><span style="color: #7FDBCA">*</span><span style="color: #D7DBE0">arr</span><span style="color: #D6DEEB">);</span></span>
<span></span>
<span><span style="color: #C792EA">int</span><span style="color: #D6DEEB"> </span><span style="color: #C5E478">a</span><span style="color: #D6DEEB">[</span><span style="color: #F78C6C">3</span><span style="color: #D6DEEB">] </span><span style="color: #C792EA">=</span><span style="color: #D6DEEB"> {</span><span style="color: #F78C6C">1</span><span style="color: #D6DEEB">, </span><span style="color: #F78C6C">2</span><span style="color: #D6DEEB">, </span><span style="color: #F78C6C">3</span><span style="color: #D6DEEB">};</span></span>
<span><span style="color: #C792EA">int</span><span style="color: #D6DEEB"> </span><span style="color: #7FDBCA">*</span><span style="color: #D6DEEB">b </span><span style="color: #C792EA">=</span><span style="color: #D6DEEB"> </span><span style="color: #7FDBCA">&amp;</span><span style="color: #C5E478">a</span><span style="color: #D6DEEB">[</span><span style="color: #F78C6C">2</span><span style="color: #D6DEEB">];</span></span>
<span></span>
<span><span style="color: #C792EA">int</span><span style="color: #D6DEEB"> </span><span style="color: #82AAFF">bar</span><span style="color: #D6DEEB">()</span></span>
<span><span style="color: #D6DEEB">{</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">return</span><span style="color: #D6DEEB"> </span><span style="color: #82AAFF">foo(</span><span style="color: #7FDBCA">&amp;</span><span style="color: #C5E478">a</span><span style="color: #82AAFF">[</span><span style="color: #F78C6C">1</span><span style="color: #82AAFF">])</span><span style="color: #D6DEEB">;</span></span>
<span><span style="color: #D6DEEB">}</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #994CC3">int</span><span style="color: #403F53"> </span><span style="color: #4876D6">foo</span><span style="color: #403F53">(</span><span style="color: #994CC3">int</span><span style="color: #403F53"> </span><span style="color: #0C969B">*</span><span style="color: #403F53">arr);</span></span>
<span></span>
<span><span style="color: #994CC3">int</span><span style="color: #403F53"> </span><span style="color: #4876D6">a</span><span style="color: #403F53">[</span><span style="color: #AA0982">3</span><span style="color: #403F53">] </span><span style="color: #994CC3">=</span><span style="color: #403F53"> {</span><span style="color: #AA0982">1</span><span style="color: #403F53">, </span><span style="color: #AA0982">2</span><span style="color: #403F53">, </span><span style="color: #AA0982">3</span><span style="color: #403F53">};</span></span>
<span><span style="color: #994CC3">int</span><span style="color: #403F53"> </span><span style="color: #0C969B">*</span><span style="color: #403F53">b </span><span style="color: #994CC3">=</span><span style="color: #403F53"> </span><span style="color: #0C969B">&amp;</span><span style="color: #4876D6">a</span><span style="color: #403F53">[</span><span style="color: #AA0982">2</span><span style="color: #403F53">];</span></span>
<span></span>
<span><span style="color: #994CC3">int</span><span style="color: #403F53"> </span><span style="color: #4876D6">bar</span><span style="color: #403F53">()</span></span>
<span><span style="color: #403F53">{</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">return</span><span style="color: #403F53"> </span><span style="color: #4876D6">foo(</span><span style="color: #0C969B">&amp;</span><span style="color: #4876D6">a[</span><span style="color: #AA0982">1</span><span style="color: #4876D6">])</span><span style="color: #403F53">;</span></span>
<span><span style="color: #403F53">}</span></span></code></pre></div></section>
<p><code>readelf -r</code>:</p>
<section class="code-block relative my-6 shadow" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h3 class="text-3 text-footer" aria-label="plain text 代码块" data-v-ad49d235="">plain text</h3><ile-root id="ile-7"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.189ada06.js";import"/assets/vendor-vue.6a98ea6c.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.189ada06.js").then(i=>i.v),["assets/iles.189ada06.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.fcf5587c.js"),["assets/CopyButton.fcf5587c.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-7",{},{})});export default E();
</script></div><div class="light:hidden" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><samp><span><span style="color: #d6deeb">Relocation section '.rela.text' at offset 0x250 contains 2 entries:</span></span>
<span><span style="color: #d6deeb">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span></span>
<span><span style="color: #d6deeb">000000000001  000a0000000a R_X86_64_32       0000000000000008 a + 4</span></span>
<span><span style="color: #d6deeb">000000000006  000b00000002 R_X86_64_PC32     0000000000000000 foo - 4</span></span>
<span><span style="color: #d6deeb"></span></span>
<span><span style="color: #d6deeb">Relocation section '.rela.data' at offset 0x280 contains 1 entry:</span></span>
<span><span style="color: #d6deeb">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span></span>
<span><span style="color: #d6deeb">000000000000  000a00000001 R_X86_64_64       0000000000000008 a + 8</span></span></samp></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><samp><span><span style="color: #403f53">Relocation section '.rela.text' at offset 0x250 contains 2 entries:</span></span>
<span><span style="color: #403f53">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span></span>
<span><span style="color: #403f53">000000000001  000a0000000a R_X86_64_32       0000000000000008 a + 4</span></span>
<span><span style="color: #403f53">000000000006  000b00000002 R_X86_64_PC32     0000000000000000 foo - 4</span></span>
<span><span style="color: #403f53"></span></span>
<span><span style="color: #403f53">Relocation section '.rela.data' at offset 0x280 contains 1 entry:</span></span>
<span><span style="color: #403f53">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span></span>
<span><span style="color: #403f53">000000000000  000a00000001 R_X86_64_64       0000000000000008 a + 8</span></span></samp></pre></div></section>
<p>在 <code>.rela.text</code> 中<span class="mojikumi-line-end">，</span><code>a</code> 的 <code>addend</code> 是 <code>4</code><span class="mojikumi-line-end">，</span>是直接得到 <code>a[1]</code> 而非 <code>a[0]</code> 的地址<span class="mojikumi-line-end">；</span><code>foo</code> 的 <code>addend</code> 是 <code>-4</code><span class="mojikumi-line-end">，</span>是因为 reference 的地址是 reference 所在的 <code>jmp</code> 指令的下一条指令的地址减 4<span class="mojikumi-line-end">，</span>导致 PC 的地址加上 <code>foo</code> 的地址减去 reference 的地址得到的是 <code>foo</code> 的地址加 4<span class="mojikumi-line-end">，</span>需要 <code>addend</code> 来修正<span class="mojikumi-line-end">。</span></p>
<h2 id="executable-object-files" class="heading"><a href="#executable-object-files" class="heading-anchor" aria-label="章节： Executable Object Files" tabindex="-1"></a><span>Executable Object Files</span></h2>
<p>可执行文件的内容大体上和 relocatable object file 类似<span class="mojikumi-line-end">，</span>主要的区别是<span class="mojikumi-line-end">：</span></p>
<ul>
<li>在 ELF header 中指定了程序的 entry point</li>
<li>有一个 <code>.init</code> section<span class="mojikumi-line-end">，</span>定义了一个简单的函数<span class="mojikumi-line-end">，</span>用来初始化程序</li>
<li>有一个 program header table<span class="mojikumi-line-end">，</span>描述了程序文件与内存的对应关系<span class="mojikumi-line-end">，</span>即要把文件的哪一段映射到内存的哪一段<span class="mojikumi-line-end">，</span>地址如何对齐<span class="mojikumi-line-end">，</span>以及每一段的权限<span class="mojikumi-line-start">（</span><code>.init</code><span class="mojikumi-line-end">、</span><code>.text</code><span class="mojikumi-line-end">、</span><code>.rodata</code> 的权限为 <code>r-x</code><span class="mojikumi-line-end">，</span><code>.data</code> 和 <code>.bss</code> 的权限为 <code>rw-</code><span class="mojikumi-line-end">）</span></li>
<li><code>.symtab</code><span class="mojikumi-line-end">、</span><code>.debug</code><span class="mojikumi-line-end">、</span><code>.line</code><span class="mojikumi-line-end">、</span><code>.strtab</code> 在执行时不会加载到内存中</li>
<li>如果 fully linked<span class="mojikumi-line-end">，</span>则没有 <code>.rel</code> section</li>
</ul>
<h2 id="loading-executable-object-files" class="heading"><a href="#loading-executable-object-files" class="heading-anchor" aria-label="章节： Loading Executable Object Files" tabindex="-1"></a><span>Loading Executable Object Files</span></h2>
<p>在程序运行时<span class="mojikumi-line-end">，</span>run-time memory image 大致如下图<span class="mojikumi-line-start">（</span>CS:APP Figure 7.15<span class="mojikumi-line-end">）</span>所示<span class="mojikumi-line-end">：</span></p>
<p><picture><source type="image/webp" srcset="/assets/csapp-fig7.15.ce83adc4.webp"><img srcset="/assets/csapp-fig7.15.b489ac10.png" loading="lazy" src="/assets/csapp-fig7.15.b489ac10.png" width="648" height="619" alt="Linux x86-64 run-time memory image"></picture></p>
<p><span class="mojikumi-line-start">（</span><a href="https://csapp.cs.cmu.edu/3e/errata.html">errata</a> 中指出<span class="mojikumi-line-end">，</span>栈的起始地址并不是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>48</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{48}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">48</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span><span class="mojikumi">。</span><span class="mojikumi-line-end">）</span></p>
<p>因为地址对齐<span class="mojikumi-line-end">、</span>address-space layout randomization 等原因<span class="mojikumi-line-end">，</span>实际上的内存结构会与上图有一定的差异<span class="mojikumi-line-end">，</span>但每一段的相对位置是和图中一致的<span class="mojikumi-line-end">。</span></p>
<p>loader 加载可执行文件时<span class="mojikumi-line-end">，</span>首先创建 memory image<span class="mojikumi-line-end">，</span>然后根据 program header table 将可执行文件的内容映射到内存中<span class="mojikumi-line-end">，</span>最后跳转到程序的 entry point<span class="mojikumi-line-end">。</span>C 语言程序的 entry point 是 <code>_start</code> 函数<span class="mojikumi-line-start">（</span>在 <code>crt1.o</code> 中定义<span class="mojikumi-line-end">）</span>的地址<span class="mojikumi-line-end">，</span><code>_start</code> 又会调用 <code>_<wbr>_<wbr>libc_<wbr>start_<wbr>main</code> 函数<span class="mojikumi-line-start">（</span>在 <code>libc.so</code> 中定义<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>进行运行环境的初始化<span class="mojikumi-line-end">，</span>然后调用 <code>main</code> 函数<span class="mojikumi-line-end">，</span>最后对返回值进行处理<span class="mojikumi-line-end">。</span></p>
<h2 id="dynamic-linking-with-shared-libraries" class="heading"><a href="#dynamic-linking-with-shared-libraries" class="heading-anchor" aria-label="章节： Dynamic Linking with Shared Libraries" tabindex="-1"></a><span>Dynamic Linking with Shared Libraries</span></h2>
<p>静态库有一些问题<span class="mojikumi-line-end">：</span></p>
<ol>
<li>更新静态库需要重新链接</li>
<li>每个程序都有一份库的拷贝<span class="mojikumi-line-end">，</span>会造成空间的浪费</li>
</ol>
<p>共享库 (shared library) 可以解决这些问题<span class="mojikumi-line-end">。</span>共享库可以在 run time 或者 load time 被动态链接<span class="mojikumi-line-end">。</span>动态链接由 dynamic linker 完成<span class="mojikumi-line-end">。</span>共享库也被称作 shared object<span class="mojikumi-line-end">，</span>在 Linux 中后缀名为 <code>.so</code><span class="mojikumi-line-end">，</span>在 Windows 中被叫做 DLL<span class="mojikumi-line-end">。</span></p>
<p>共享库在两个层面上被共享<span class="mojikumi-line-end">：</span></p>
<ol>
<li>在文件系统上只有一份 <code>.so</code> 文件<span class="mojikumi-line-end">，</span>而在可执行文件中没有库的拷贝</li>
<li>在内存中共享库的 <code>.text</code> section 的单份拷贝可以被多个进程同时使用</li>
</ol>
<p>可以用类似于 <code>gcc -shared -fpic a.c b.c c.c -o libabc.so</code> 的命令构建共享库<span class="mojikumi-line-end">。</span>编译选项中 <code>-shared</code> 告诉编译器要生成 shared object<span class="mojikumi-line-end">，</span><code>-fpic</code> 用来生成 <a href="#position-independent-code-pic">position-independent code</a><span class="mojikumi-line-end">。</span></p>
<p>可以用类似 <code>gcc<wbr> <wbr>main<wbr>.<wbr>c<wbr> ./<wbr>libabc<wbr>.<wbr>so<wbr> -<wbr>o<wbr> <wbr>main</code> 的命令来使用共享库<span class="mojikumi-line-end">。</span></p>
<p>运行 <code>main</code> 时<span class="mojikumi-line-end">，</span>loader 会在进入 entry point 前在 <code>.interp</code> section 中发现 dynamic linker <code>ld<wbr>-<wbr>linux<wbr>.<wbr>so</code><span class="mojikumi-line-end">，</span>于是让 dynamic linker 完成共享库的 relocation 并修改程序中的 symbol reference<span class="mojikumi-line-end">，</span>最后将控制权交还给程序<span class="mojikumi-line-end">。</span></p>
<h2 id="loading-and-linking-shared-libraries-from-applications" class="heading"><a href="#loading-and-linking-shared-libraries-from-applications" class="heading-anchor" aria-label="章节： Loading and Linking Shared Libraries from Applications" tabindex="-1"></a><span>Loading and Linking Shared Libraries from Applications</span></h2>
<p>除了在编译时指定要链接到的共享库并在 load time 链接<span class="mojikumi-line-end">，</span>也可以在 run time 加载并使用共享库<span class="mojikumi-line-end">。</span></p>
<p>C 语言中的相关函数放在 <code>dlfcn.h</code> 头文件中<span class="mojikumi-line-end">，</span>编译时需要 <code>-ldl</code> 来使用这些函数<span class="mojikumi-line-end">：</span></p>
<ul>
<li>
<p><code>void<wbr> *<wbr>dlopen<wbr>(<wbr>const<wbr> <wbr>char<wbr> *<wbr>filename<wbr>, <wbr>int<wbr> <wbr>flag<wbr>)</code>: 加载共享库</p>
<ul>
<li>
<p>返回值: 成功加载则返回 handle<span class="mojikumi-line-end">，</span>否则返回 <code>NULL</code></p>
</li>
<li>
<p><code>filename</code>: 共享库文件名</p>
</li>
<li>
<p><code>flag</code>: 影响如何处理共享库中引用的 external symbol<span class="mojikumi-line-end">，</span>必须包含 <code>RTLD_NOW</code> 和 <code>RTLD_LAZY</code> 两者之一</p>
<ul>
<li><code>RTLD_NOW</code>: 立即 resolve 所有 external symbol</li>
<li><code>RTLD_LAZY</code>: 等到运行共享库中的代码时再 resolve external symbol</li>
<li><code>RTLD_GLOBAL</code>: 之后给其他共享库 resolve external symbol 时可以使用当前这个共享库</li>
</ul>
<p>如果编译程序时启用了 <code>-rdynamic</code> 选项<span class="mojikumi-line-end">，</span>在 resolve external symbol 时<span class="mojikumi-line-end">，</span>除了使用其他加载时启用了 <code>RTLD_GLOBAL</code> 选项的共享库<span class="mojikumi-line-end">，</span>也可以使用程序自身的 global symbol<span class="mojikumi-line-end">。</span></p>
</li>
</ul>
</li>
<li>
<p><code>void<wbr> *<wbr>dlsym<wbr>(<wbr>void<wbr> *<wbr>handle<wbr>, <wbr>char<wbr> *<wbr>symbol<wbr>)</code>: 获得共享库中某个 symbol 的地址</p>
<ul>
<li>
<p><code>symbol</code>: symbol 名称</p>
</li>
<li>
<p>返回值: 成功获取则返回 symbol 地址<span class="mojikumi-line-end">，</span>否则返回 <code>NULL</code></p>
</li>
</ul>
</li>
<li>
<p><code>int<wbr> <wbr>dlclose<wbr>(<wbr>void<wbr> *<wbr>handle<wbr>)</code>: 关闭共享库</p>
<ul>
<li>返回值: 成功关闭则返回 <code>0</code><span class="mojikumi-line-end">，</span>出错则返回 <code>-1</code></li>
</ul>
</li>
<li>
<p><code>const<wbr> <wbr>char<wbr> *<wbr>dlerror<wbr>(<wbr>void<wbr>)</code>: 获取最后一次调用 <code>dlopen</code> / <code>dlsym</code> / <code>dlclose</code> 的报错信息<span class="mojikumi-line-end">，</span>如果最后一次调用没有出错则返回 <code>NULL</code></p>
</li>
</ul>
<p>CS:APP 给出了一份参考代码 <a href="https://csapp.cs.cmu.edu/3e/ics3/code/link/dll.c">code/link/dll.c</a><span class="mojikumi-line-end">。</span></p>
<h2 id="position-independent-code-pic" class="heading"><a href="#position-independent-code-pic" class="heading-anchor" aria-label="章节： Position-Independent Code (PIC)" tabindex="-1"></a><span>Position-Independent Code (PIC)</span></h2>
<p>共享库的一条重要性质是它的代码段在内存中只有一份<span class="mojikumi-line-end">，</span>而可以被多个进程共享<span class="mojikumi-line-end">，</span>这就使得它的代码中的 symbol reference 不能在动态链接时被修改<span class="mojikumi-line-end">，</span>适用于静态链接的 relocation 无法完成<span class="mojikumi-line-end">，</span>所以共享库的代码需要是 position-independent 的<span class="mojikumi-line-end">。</span></p>
<p>PIC 的主要思路基于以下两点<span class="mojikumi-line-end">：</span></p>
<ol>
<li>虽然共享库的代码段是共享的<span class="mojikumi-line-end">，</span>但数据段是每个进程各有一份的</li>
<li>无论整个共享库被放到内存的哪个位置<span class="mojikumi-line-end">，</span>代码段和数据段地址的距离是固定的<span class="mojikumi-line-start">（</span>这与上一条不矛盾<span class="mojikumi-line-end">，</span>应该是因为虚存<span class="mojikumi-line-end">）</span></li>
</ol>
<p>因此<span class="mojikumi-line-end">，</span>可以在数据段中存放效果相当于 relocation 的信息<span class="mojikumi-line-end">，</span>来间接达到 relocation 的效果<span class="mojikumi-line-end">。</span>说白了就是<span class="mojikumi-line-end">，</span>因为没法修改代码段<span class="mojikumi-line-end">，</span>所以把 symbol 的地址放到数据段里<span class="mojikumi-line-end">。</span>具体实现中<span class="mojikumi-line-end">，</span>数据段的开头有一个 <i>global offset table</i> (GOT)<span class="mojikumi-line-end">，</span>表中每一项都是一个地址<span class="mojikumi-line-end">，</span>可以由 dynamic linker 进行修改<span class="mojikumi-line-end">，</span>而由于代码段和数据段的地址距离固定<span class="mojikumi-line-end">，</span>就可以用 PC-relative 的方式寻址到表中的项<span class="mojikumi-line-end">。</span></p>
<p>PIC data reference 是简单的<span class="mojikumi-line-end">，</span>只要在 GOT 中为每个 data symbol (全局或 static 变量) 创建一个表项<span class="mojikumi-line-end">，</span>在动态链接时由 dynamic linker 修改这些项<span class="mojikumi-line-end">，</span>而在代码中通过这个表项来间接地进行 data reference<span class="mojikumi-line-end">，</span>例如 (CS:APP Figure 7.18<span class="mojikumi-line-end">，</span><code>GOT[3]</code> 中存放了全局变量 <code>x</code> 的地址)<span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h3 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="asm 代码块" data-v-ad49d235="">asm</h3><ile-root id="ile-8"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.189ada06.js";import"/assets/vendor-vue.6a98ea6c.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.189ada06.js").then(i=>i.v),["assets/iles.189ada06.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.fcf5587c.js"),["assets/CopyButton.fcf5587c.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-8",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">movq</span><span style="color: #D6DEEB"> Ox2OO8b9(%</span><span style="color: #82AAFF">rip</span><span style="color: #D6DEEB">), %</span><span style="color: #82AAFF">rax</span><span style="color: #D6DEEB">  </span><span style="color: #637777"> # %rax = *GOT[3] = &amp;x</span></span>
<span><span style="color: #D6DEEB">    addl $0x1, (%</span><span style="color: #82AAFF">rax</span><span style="color: #D6DEEB">)          </span><span style="color: #637777"> # ++x</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #403F53">    </span><span style="color: #0C969B">movq</span><span style="color: #403F53"> Ox2OO8b9(%</span><span style="color: #4876D6">rip</span><span style="color: #403F53">), %</span><span style="color: #4876D6">rax</span><span style="color: #403F53">  </span><span style="color: #989FB1"> # %rax = *GOT[3] = &amp;x</span></span>
<span><span style="color: #403F53">    addl $0x1, (%</span><span style="color: #4876D6">rax</span><span style="color: #403F53">)          </span><span style="color: #989FB1"> # ++x</span></span></code></pre></div></section>
<p>如果是本地定义的变量<span class="mojikumi-line-end">，</span>也可以使用 PC-relative 的定位方式直接引用<span class="mojikumi-line-end">，</span>而只对外部定义的变量使用 GOT<span class="mojikumi-line-end">，</span>但编译器也可能选择不做这样的区分而是使用统一的方法来处理<span class="mojikumi-line-end">。</span></p>
<p>PIC procedure call 也可以和 data reference 一样处理<span class="mojikumi-line-start">（</span>可以用 <code>-fno-plt</code> 编译选项来这样做<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>但实际上会使用名为 <i>lazy binding</i> 的技术进行优化<span class="mojikumi-line-end">。</span></p>
<p>这是因为<span class="mojikumi-line-end">，</span>链接到一个共享库时<span class="mojikumi-line-end">，</span>往往最终会调用的只是它提供的大量函数中的一小部分<span class="mojikumi-line-end">，</span>如果对整个共享库用到的外部函数都在动态链接时计算出相应的 offset<span class="mojikumi-line-end">，</span>就可能造成浪费<span class="mojikumi-line-end">。</span>而 lazy binding 则是在第一次调用某个外部函数时绑定这个函数的地址<span class="mojikumi-line-end">。</span></p>
<p>lazy binding 基于一个名为 <i>procedure linkage table</i> (PLT) 的结构<span class="mojikumi-line-end">。</span>PLT 位于代码段中<span class="mojikumi-line-end">，</span>表中的每一项其实是三条指令<span class="mojikumi-line-end">，</span>如 CS:APP Figure 7.19 所示<span class="mojikumi-line-end">：</span></p>
<p><picture><source type="image/webp" srcset="/assets/csapp-fig7.19.389efa4c.webp"><img srcset="/assets/csapp-fig7.19.44dfb261.png" loading="lazy" src="/assets/csapp-fig7.19.44dfb261.png" width="995" height="602" alt="PLT 原理示意图"></picture></p>
<p>整个流程就是<span class="mojikumi-line-end">：</span></p>
<ol>
<li>调用 <code>addvec</code> 时<span class="mojikumi-line-end">，</span>实际上调用的是 <code>PLT[2]</code> 的地址</li>
<li><code>PLT[2]</code> 的第一条指令会跳转到 <code>GOT[4]</code><span class="mojikumi-line-end">，</span><code>GOT[4]</code> 里一开始放的是 <code>PLT[2]</code> 的第二条指令<span class="mojikumi-line-end">，</span>所以首次调用 <code>PLT[2]</code> 时就从第一条指令跳到第二条指令</li>
<li>第二条指令是往栈里压入 <code>addvec</code> 的 ID<span class="mojikumi-line-end">，</span>是用来告诉 dynamic linker 这是哪个函数</li>
<li>第三条指令会跳转到 <code>PLT[0]</code></li>
<li><code>PLT[0]</code> 的第一条指令是往栈里压入 relocation entries 的地址<span class="mojikumi-line-end">，</span>第二条指令是跳转到 dynamic linker</li>
<li>dynamic linker 通过放在栈中的函数的 ID 以及 relocation entries 计算出 <code>addvec</code> 的地址<span class="mojikumi-line-end">，</span>放在 <code>GOT[4]</code><span class="mojikumi-line-end">，</span>然后跳转到 <code>addvec</code></li>
<li>因为一路上都是 <code>jmp</code><span class="mojikumi-line-end">，</span>跳转到 <code>addvec</code> 后可以正常返回到调用 <code>PLT[2]</code> 的位置</li>
<li>第二次调用 <code>PLT[2]</code> 时<span class="mojikumi-line-end">，</span><code>GOT[4]</code> 里已经是 <code>addvec</code> 的地址<span class="mojikumi-line-end">，</span>所以就在 <code>PLT[2]</code> 的第一条指令处跳转到了 <code>addvec</code></li>
</ol>
<h2 id="library-interpositioning" class="heading"><a href="#library-interpositioning" class="heading-anchor" aria-label="章节： Library Interpositioning" tabindex="-1"></a><span>Library Interpositioning</span></h2>
<p>Linux 的链接器支持一个名为 <i>library interpositioning</i> 的技术<span class="mojikumi-line-end">，</span>可以用来把共享库的函数替换掉<span class="mojikumi-line-end">，</span>一般会换成一个 wrapper function 用来 trace<span class="mojikumi-line-end">，</span>但也可以换成完全不同的东西<span class="mojikumi-line-end">。</span></p>
<p>看了下中文版 CS:APP<span class="mojikumi-line-end">，</span>这个东西竟然叫<span class="mojikumi-line-start">“</span>库打桩<span class="mojikumi">”</span><wbr><span class="mojikumi-line-start">（</span></p>
<p>编译时的 library interpositioning 就是用 <code>#define</code> 换掉某个函数 <s><span class="mojikumi-line-end">，</span>在机房里被 <code>#<wbr>define<wbr> <wbr>sort<wbr> <wbr>random_<wbr>shuffle</code> 过的大家想必对此非常熟悉</s><span class="mojikumi-line-end">。</span></p>
<p>链接时的 library interpositioning 是给 linker 传参 <code>--wrap foo</code><span class="mojikumi-line-end">，</span>然后调用 <code>foo</code> 就会实际上调用 <code>__wrap_foo</code><span class="mojikumi-line-end">，</span>而调用 <code>__real_foo</code> 则会调用原本的 <code>foo</code><span class="mojikumi-line-end">。</span>一般会给 <code>gcc</code> 而非 <code>ld</code> 传参<span class="mojikumi-line-end">，</span>就是用 <code>gcc<wbr> -<wbr>Wl<wbr>,--<wbr>wrap<wbr>,<wbr>foo</code> 代替 <code>ld --wrap foo</code><span class="mojikumi-line-end">，</span>其中 <code>-Wl</code> 表示给 linker 传参<span class="mojikumi-line-end">，</span>后面的逗号会被换成空格<span class="mojikumi-line-end">。</span></p>
<p>运行时的 library interpositioning 是在运行程序时设置环境变量 <code>LD_<wbr>PRELOAD<wbr>="/<wbr>path<wbr>/<wbr>to<wbr>/<wbr>wrapper<wbr>.<wbr>so<wbr> /<wbr>path<wbr>/<wbr>to<wbr>/<wbr>anotherwrapper<wbr>.<wbr>so<wbr>"</code><span class="mojikumi-line-end">，</span>然后在使用任意共享库中的函数之前就会优先尝试使用 <code>wrapper.so</code> 和 <code>anotherwrapper<wbr>.<wbr>so</code><span class="mojikumi-line-end">。</span>这时<span class="mojikumi-line-end">，</span>为了能在 wrapper function 中调用原本的函数<span class="mojikumi-line-end">，</span>就需要 <a href="#loading-and-linking-shared-libraries-from-applications">在运行时加载共享库</a><span class="mojikumi-line-end">。</span></p>
<p>如果想看具体实现<span class="mojikumi-line-end">，</span>可以参考 CS:APP<span class="mojikumi-line-end">。</span></p>
<p>编译时的 library interpositioning 需要修改源代码<span class="mojikumi-line-end">，</span>链接时的 library interpositioning 需要获取到 object file 并重新链接得到可执行文件<span class="mojikumi-line-end">，</span>而运行时 library interpositioning 只需要设置环境变量<span class="mojikumi-line-end">，</span>不需要对可执行文件进行任何修改<span class="mojikumi-line-end">，</span>可以方便地对很多不同程序的某个函数调用进行跟踪<span class="mojikumi-line-end">。</span></p></section><div class="article-style my-9"><hr></div><footer><div class="my-6 b-l-6 b-gray-4 bg-area p-6 shadow dark:b-gray-11" itemprop="copyrightNotice"><ul class="flex flex-col gap-1"><li class="flex gap-1"><span class="shrink-0">文章作者:</span><a href="https://github.com/ouuan" rel="author">ouuan</a></li><li class="flex gap-1"><span class="shrink-0">原文链接:</span><a href="https://ouuan.moe/post/2022/10/csapp-7" rel="canonical" class="break-all">https://ouuan.moe/post/2022/10/csapp-7</a></li><li class="flex gap-1"><span class="shrink-0">许可协议:</span><span> 本文采用 <span class="article-style"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.zh" class="font-sans" itemprop="license">CC BY-SA 4.0</a></span> 许可协议进行授权，未满足 <span class="underline decoration-dotted" title="简而言之，转载时必须标明出处（本文的链接），标明是转载而非原创，标明作了哪些修改，并使用相同的许可协议，但无需私信征求许可">许可协议要求</span> 不得转载。 </span></li><li class="flex gap-1"><span class="shrink-0">额外说明:</span><span>本文包含少量直接从 CS:APP 中复制的代码、图片，本文作者对其不拥有版权。</span></li></ul></div></footer></article><div class="my-6 print:hidden" itemprop="comment" itemscope="" itemtype="https://schema.org/Comment"><ile-root id="ile-9"></ile-root><script></script><script type="module" async="">import{h as r,c as m}from"/assets/iles.189ada06.js";import{_ as o}from"/assets/GiscusCommentsInner.c0625d79.js";import"/assets/vendor-vue.6a98ea6c.js";import"/assets/vite.5ce4fca4.js";import"/assets/useTheme.70297bc5.js";import"/assets/site.b21fb919.js";r(m,o,"ile-9",{term:"CS:APP 第七章学习笔记"},{});
</script></div><nav class="my-6 flex justify-between gap-6 print:hidden lg:text-justify"><div class="flex flex-1"><a class="flex items-center gap-1 hover:text-hover" href="/post/2022/10/csapp-4"><span class="i-mdi-chevron-left"></span><span class="sr-only">上一篇</span><span class="break-anywhere">CS:APP 第四章学习笔记</span></a></div><div class="flex flex-1 justify-end"><a class="flex flex-row-reverse items-center gap-1 hover:text-hover" href="/post/2022/10/gcc-use_vector_fp_converts"><span class="i-mdi-chevron-right"></span><span class="sr-only">下一篇</span><span class="break-anywhere">探究 gcc 浮点数精度转换所使用的指令 —— use_vector_fp_converts 优化</span></a></div></nav></div></div></main><footer class="flex flex-col gap-1 bg-card p-6 text-footer" itemprop="hasPart" itemscope="" itemtype="https://schema.org/WPFooter"><div class="flex flex-wrap items-center justify-center gap-x-1"><span>Copyright ©</span><span>2022 - 2023</span><a class="flex items-center" href="/sponsor" title="赞赏支持"><span class="i-mdi-heart text-red dark:text-red-7"></span></a><span>ouuan</span><span class="i-mdi-circle-small"></span><span title="实际上，为了保护用户隐私，同一用户的多次访问只有在同一天内使用同一浏览器在同一ip下才会被算作同一人"> 共有 <ile-root id="ile-10"><span><span class="i-mdi-loading motion-safe:animate-spin"></span><span class="sr-only">加载中</span></span></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.189ada06.js";import"/assets/vendor-vue.6a98ea6c.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.189ada06.js").then(o=>o.v),["assets/iles.189ada06.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/VisitorCount.8df5b149.js"),["assets/VisitorCount.8df5b149.js","assets/VisitorCount.af7e583c.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default});s(u,v,"ile-10",{},{})});export default E();
</script> 人到访过这里 </span></div><div class="flex flex-wrap items-center justify-center gap-x-1"> 基于 <a class="underline" href="https://github.com/ElMassimo/iles">îles</a> 及 <a class="underline" href="https://github.com/ouuan/iles-blog/blob/master/package.json">很多其他项目</a><span class="i-mdi-circle-small"></span><span>由 ouuan 设计/制作</span><span class="i-mdi-circle-small"></span><a class="underline" href="https://github.com/ouuan/iles-blog">源代码</a><span class="i-mdi-circle-small"></span><a class="underline" href="https://github.com/ouuan/iles-blog/discussions">Discussions</a></div></footer><meta itemprop="copyrightYear" content="2022 - 2023"><div class="hidden" itemscope="" itemtype="https://schema.org/Person" itemprop="copyrightHolder"><meta itemprop="name" content="ouuan"><meta itemprop="givenName" content="Yufan"><meta itemprop="familyName" content="You"><meta itemprop="url" content="https://github.com/ouuan"><link itemprop="gender" href="https://schema.org/Male"><meta itemprop="image" content="/android-chrome-512x512.png"></div><ile-root id="ile-11"><button class="group bottom-10 flex-col floating-button" title="前往底部"><div aria-hidden="true" class="flex justify-center"><span class="i-mdi-chevron-double-up motion-safe:transition-font-size text-0"></span></div><div aria-hidden="true" class="text-0 group-hover:text-3.5 motion-safe:transition-font-size"></div><div aria-hidden="false" class="flex justify-center"><span class="i-mdi-chevron-double-down motion-safe:transition-font-size text-5 group-hover:text-3"></span></div></button></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.189ada06.js";import"/assets/vendor-vue.6a98ea6c.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.189ada06.js").then(o=>o.v),["assets/iles.189ada06.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/BackToTop.fa309e4b.js"),["assets/BackToTop.fa309e4b.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default});s(u,v,"ile-11",{},{})});export default E();
</script><div class="hidden"></div><ile-root id="ile-12"></ile-root><script></script><script type="module" async="">var p=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports);var e=(t,a,_)=>new Promise((c,n)=>{var f=o=>{try{i(_.next(o))}catch(r){n(r)}},l=o=>{try{i(_.throw(o))}catch(r){n(r)}},i=o=>o.done?c(o.value):Promise.resolve(o.value).then(f,l);i((_=_.apply(t,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.189ada06.js";import"/assets/vendor-vue.6a98ea6c.js";var u=p(m=>{const E=()=>e(m,null,function*(){return(yield d(()=>import("/assets/iles.189ada06.js").then(t=>t.d),["assets/iles.189ada06.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default}),h=()=>e(m,null,function*(){return(yield d(()=>import("/assets/PlausibleTrigger.34fb708e.js"),["assets/PlausibleTrigger.34fb708e.js","assets/plausible.57150b22.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).onLoad});s(E,h,"ile-12",{},{})});export default u();
</script><div></div><ile-root id="ile-13"></ile-root><script></script><script type="module" async="">var p=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports);var e=(t,a,_)=>new Promise((c,n)=>{var f=o=>{try{i(_.next(o))}catch(r){n(r)}},l=o=>{try{i(_.throw(o))}catch(r){n(r)}},i=o=>o.done?c(o.value):Promise.resolve(o.value).then(f,l);i((_=_.apply(t,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.189ada06.js";import"/assets/vendor-vue.6a98ea6c.js";var u=p(m=>{const E=()=>e(m,null,function*(){return(yield d(()=>import("/assets/iles.189ada06.js").then(t=>t.d),["assets/iles.189ada06.js","assets/vendor-vue.6a98ea6c.js","assets/vite.5ce4fca4.js"])).default}),h=()=>e(m,null,function*(){return(yield d(()=>import("/assets/TextJustifyFix.4fa5e997.js"),[])).onLoad});s(E,h,"ile-13",{},{})});export default u();
</script><meta itemprop="inLanguage" content="zh-CN"></div>
  
</body></html>