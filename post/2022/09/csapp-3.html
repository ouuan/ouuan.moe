<!DOCTYPE html><html lang="zh-CN"><head>
    <meta charset="UTF-8">
<title>CS:APP 第三章学习笔记 - ouuan's blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="CS:APP 第三章 “Machine-Level Representation of Programs” 的学习笔记。
这章的主要内容为汇编（machine-level programming）。
">
<meta property="og:url" content="https://ouuan.moe/post/2022/09/csapp-3">
<meta property="og:site_name" content="ouuan's blog">
<meta property="og:title" content="CS:APP 第三章学习笔记 · ouuan's blog">
<meta property="og:description" content="CS:APP 第三章 “Machine-Level Representation of Programs” 的学习笔记。
这章的主要内容为汇编（machine-level programming）。
">
<meta property="twitter:domain" content="ouuan.moe">
<meta property="twitter:title" content="CS:APP 第三章学习笔记 · ouuan's blog">
<meta property="twitter:description" content="CS:APP 第三章 “Machine-Level Representation of Programs” 的学习笔记。
这章的主要内容为汇编（machine-level programming）。
">
<meta property="twitter:url" content="https://ouuan.moe/post/2022/09/csapp-3">
<style>html:not(.dark):not(.light) { visibility: hidden; } body { visibility: hidden; }</style>
<script>(() => { let dark; try { const theme = localStorage && localStorage.getItem('vueuse-color-scheme'); if (theme === 'dark') dark = true; else if (theme === 'light') dark = false; else dark = window.matchMedia('(prefers-color-scheme: dark)').matches; } catch (e) { dark = false; } document.documentElement.classList.add(dark ? 'dark' : 'light'); })()</script>
<noscript><style>@media (prefers-color-scheme: light) { :root:not(.dark):not(.light) { color-scheme: light; --text-color: #232637; --bg-color: #DEE6EE; --card-color: #EFF3F7; --link-color: #1E66B8; --hover-color: #2E80DD; --active-color: #164C89; --bghover-color: #D6E0EA; --popup-color: #F7F9FB; --footer-color: #5F627B; --area-color: #E1E2E8; --nested-color: #F0F0F3; } } @media (prefers-color-scheme: dark) { :root:not(.dark):not(.light) { color-scheme: dark; --text-color: #E6EDF2; --bg-color: #0D0E15; --card-color: #1F2130; --link-color: #8BB8EC; --hover-color: #A2C6F0; --active-color: #74AAE8; --bghover-color: #353853; --popup-color: #2C2F45; --footer-color: #9699AE; --area-color: #2F313D; --nested-color: #3C3E4E; } } html { visibility:visible !important; }</style></noscript>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="canonical" href="https://ouuan.moe/post/2022/09/csapp-3">
<link rel="alternate" type="application/rss+xml" href="/feed.xml" title="RSS Feed - ouuan's blog">
<link rel="alternate" type="application/atom+xml" href="/feed.atom" title="Atom Feed - ouuan's blog">
<link rel="alternate" type="application/json" href="/feed.json" title="JSON Feed - ouuan's blog">
<link rel="dns-prefetch" href="https://plausible.ouuan.moe">
<link rel="preconnect" href="https://blog-visitor-count.ouuan.moe">
<link rel="stylesheet" href="/vendors/katex/katex.css">
<link rel="sitemap" href="https://ouuan.moe/sitemap.xml">
<meta name="author" content="ouuan">
<meta name="twitter:creator" content="@ouuan">
<meta name="twitter:card" content="summary">
<meta property="og:image" content="https://ouuan.moe/images/2022/09/csapp-3.png">
<meta property="generator" content="îles">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-09-24T06:02:50.000Z">
<meta property="article:modified_time" content="2023-01-09T13:06:23.000Z">
<meta property="article:author" content="ouuan">
<meta property="article:tag" content="csapp">
<meta property="article:tag" content="学习笔记">
<link rel="preconnect" href="https://giscus.app">
<link rel="dns-prefetch" href="https://avatars.githubusercontent.com">
    <link rel="stylesheet" href="/assets/style-78a6e887.css">
    
  <link rel="modulepreload" href="/assets/iles.0aa4bab4.js" crossorigin=""><link rel="modulepreload" href="/assets/vendor-vue.8e27fa9d.js" crossorigin=""><link rel="modulepreload" href="/assets/vite.5ce4fca4.js" crossorigin=""><link rel="modulepreload" href="/assets/SearchBar.5b56dc28.js" crossorigin=""><link rel="modulepreload" href="/assets/PostHead.bcf3d97a.js" crossorigin=""><link rel="modulepreload" href="/assets/VisitorCount.15186388.js" crossorigin=""><link rel="modulepreload" href="/assets/site.0440d0dc.js" crossorigin=""><link rel="modulepreload" href="/assets/GiscusCommentsInner.ce9f27a5.js" crossorigin=""><link rel="modulepreload" href="/assets/useTheme.060d9991.js" crossorigin=""><link rel="modulepreload" href="/assets/TableOfContents.0efa4f7e.js" crossorigin=""><style>@font-face { font-family: "Noto Serif SC Web Font"; font-weight: 400; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Regular.unique.56715923.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Regular.unique.494ea511.woff') format('woff'); unicode-range: U+0-1f914; } @font-face { font-family: "Noto Serif SC Web Font"; font-weight: 400; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Regular.common.79ca374e.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Regular.common.2a06c596.woff') format('woff'); unicode-range: U+0-ff1b; } @font-face { font-family: "Noto Serif SC Web Font"; font-weight: 700; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Bold.unique.4e722ce6.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Bold.unique.f8f9d85d.woff') format('woff'); unicode-range: U+0-1f914; } @font-face { font-family: "Noto Serif SC Web Font"; font-weight: 700; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Bold.common.8d2c4ede.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Bold.common.7f011ba7.woff') format('woff'); unicode-range: U+0-7684; }</style><link rel="preload" href="/assets/fonts/NotoSerifSC-Regular.unique.56715923.woff2" as="font" type="font/woff2" crossorigin=""><link rel="preload" href="/assets/fonts/NotoSerifSC-Regular.common.79ca374e.woff2" as="font" type="font/woff2" crossorigin=""><link rel="preload" href="/assets/fonts/NotoSerifSC-Bold.unique.4e722ce6.woff2" as="font" type="font/woff2" crossorigin=""><link rel="preload" href="/assets/fonts/NotoSerifSC-Bold.common.8d2c4ede.woff2" as="font" type="font/woff2" crossorigin=""></head>
  <body itemscope="" itemtype="https://schema.org/ItemPage">
    <div id="app"><header class="bg-card shadow print:hidden" itemprop="hasPart" itemscope="" itemtype="https://schema.org/WPHeader"><div class="flex flex-wrap justify-center whitespace-nowrap px-4 page-container sm:flex-nowrap"><div class="flex basis-full items-stretch justify-center sm:mr-3 sm:basis-auto"><a class="flex items-center p-3 text-xl font-serif bghover" href="/"><span>ouuan<span class="mojikumi-narrow-left">’</span>s blog</span></a></div><nav class="flex"><ul class="flex"><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/"><span>首页</span></a></li><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/posts"><span>文章</span></a></li><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/tags"><span>标签</span></a></li><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/about"><span>关于</span></a></li></ul></nav><div class="sm:basis-full"></div><ul class="flex"><li class="flex"><ile-root id="ile-1"><div class="flex items-stretch lg:hidden"><a class="flex items-center p-2 bghover" href="/search" title="全站搜索"><span class="i-mdi-magnify text-xl"></span></a></div><form role="search" class="hidden items-stretch justify-center lg:flex"><div class="flex items-center"><input value="" class="w-48 rd-full bg-area px-3 py-1" type="search" placeholder="关键词" aria-label="全站搜索"></div><a class="flex items-center p-2 bghover" href="/search?q=" title="全站搜索"><span class="i-mdi-magnify text-xl"></span></a></form></ile-root><script></script><script type="module" async="">import{h as r,c as a}from"/assets/iles.0aa4bab4.js";import{_ as m}from"/assets/SearchBar.5b56dc28.js";import"/assets/vendor-vue.8e27fa9d.js";import"/assets/vite.5ce4fca4.js";r(a,m,"ile-1",{},{});
</script></li><li class="flex items-stretch"><a class="flex items-center p-2 bghover" href="/feed.xml" title="RSS 订阅"><span class="i-mdi-rss text-xl"></span></a></li><li class="flex"><ile-root id="ile-2"><div class="relative flex items-stretch"><button title="暗色模式设置" class="flex items-center p-2 bghover" aria-haspopup="menu" aria-controls="__theme-switcher" aria-expanded="false"><span class="i-mdi-theme-light-dark text-xl"></span></button><ul style="display:none;" id="__theme-switcher" class="absolute right-0 top-full z-20 whitespace-nowrap rd-1 bg-popup shadow-md" role="menu" aria-label="暗色模式选项"><li class="bghover" role="menuitemradio" aria-checked="true"><button class="flex items-center p-1 text-hover"><span class="i-mdi-cellphone md:i-mdi-tablet lg:i-mdi-monitor mr-1"></span><span>跟随系统</span></button></li><li class="bghover" role="menuitemradio" aria-checked="false"><button class="flex items-center p-1"><span class="i-mdi-white-balance-sunny mr-1"></span><span>总是亮色</span></button></li><li class="bghover" role="menuitemradio" aria-checked="false"><button class="flex items-center p-1"><span class="i-mdi-weather-night mr-1"></span><span>总是暗色</span></button></li></ul></div></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(o=>o.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/ThemeSwitcher.9e602591.js"),["assets/ThemeSwitcher.9e602591.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js","assets/useTheme.060d9991.js"])).default});s(u,v,"ile-2",{},{})});export default E();
</script></li></ul></div></header><main class="min-h-100vh py-6 page-container" itemprop="mainContentOfPage" itemscope="" itemtype="https://schema.org/WebPageElement"><div class="flex justify-center"><div class="grow m-4 standard-card max-w-200"><article itemprop="mainEntity" itemscope="" itemtype="https://schema.org/BlogPosting"><div class="hidden" itemscope="" itemtype="https://schema.org/Person" itemprop="author"><meta itemprop="name" content="ouuan"><meta itemprop="givenName" content="Yufan"><meta itemprop="familyName" content="You"><meta itemprop="url" content="https://github.com/ouuan"><link itemprop="gender" href="https://schema.org/Male"><meta itemprop="image" content="/android-chrome-512x512.png"></div><meta itemprop="mainEntityOfPage" content="https://ouuan.moe/post/2022/09/csapp-3"><meta itemprop="image" content="https://ouuan.moe/images/2022/09/csapp-3.png"><ile-root id="ile-3" class="my-12"><header class="my-12" data-v-e17b8ba7=""><h1 class="mb-3 mt-6 text-center text-8" itemprop="headline" data-v-e17b8ba7=""><span class="inline-block font-serif break-anywhere" data-v-e17b8ba7=""><span data-v-e17b8ba7="" data-v-6544d8e8="">CS:APP 第三章学习笔记</span></span></h1><div class="flex flex-wrap justify-center gap-x-4 gap-y-1 text-footer md:text-sm" data-v-e17b8ba7=""><span class="flex items-center" title="创建于 2022-09-19 10:13:08 GMT+8" data-v-e17b8ba7=""><span class="i-mdi-folder-plus-outline mr-1" data-v-e17b8ba7=""></span><span class="sr-only" data-v-e17b8ba7="">创建于</span><a class="hover:underline" href="https://github.com/ouuan/iles-blog/blob/master/src/pages/post/2022/09/csapp-3.mdx?plain=1" data-v-e17b8ba7=""><time datetime="2022-09-19T10:13:08+08:00" itemprop="dateCreated" data-v-e17b8ba7="">2022-09-19</time></a></span><span class="flex items-center" title="修改于 2023-01-09 21:06:23 GMT+8" data-v-e17b8ba7=""><span class="i-mdi-update mr-1" data-v-e17b8ba7=""></span><span class="sr-only" data-v-e17b8ba7="">修改于</span><a class="hover:underline" href="https://github.com/ouuan/iles-blog/commits/master/src/pages/post/2022/09/csapp-3.mdx" data-v-e17b8ba7=""><time datetime="2023-01-09T21:06:23+08:00" itemprop="dateModified" data-v-e17b8ba7="">2023-01-09</time></a></span><span class="flex items-center" title="访问量" data-v-e17b8ba7=""><span class="i-mdi-eye-outline mr-1" data-v-e17b8ba7=""></span><span class="sr-only" data-v-e17b8ba7="">访问量</span><span data-v-e17b8ba7="">192</span></span><span class="flex flex-wrap justify-center gap-x-2 gap-y-1" data-v-e17b8ba7=""><span title="标签: csapp" class="flex items-center" itemprop="keywords" data-v-e17b8ba7=""><span class="i-mdi-tag-outline mr-1" data-v-e17b8ba7=""></span><span class="sr-only" data-v-e17b8ba7="">标签</span><a href="/tag/csapp" class="hover:underline" data-v-e17b8ba7=""><span data-v-e17b8ba7="" data-v-6544d8e8="">csapp</span></a></span><span title="标签: 学习笔记" class="flex items-center" itemprop="keywords" data-v-e17b8ba7=""><span class="i-mdi-tag-outline mr-1" data-v-e17b8ba7=""></span><span class="sr-only" data-v-e17b8ba7="">标签</span><a href="/tag/学习笔记" class="hover:underline" data-v-e17b8ba7=""><span data-v-e17b8ba7="" data-v-6544d8e8="">学习笔记</span></a></span></span></div></header></ile-root><script></script><script type="module" async="">import{h as e,c as a}from"/assets/iles.0aa4bab4.js";import{c as t}from"/assets/PostHead.bcf3d97a.js";import"/assets/vendor-vue.8e27fa9d.js";import"/assets/vite.5ce4fca4.js";import"/assets/VisitorCount.15186388.js";import"/assets/site.0440d0dc.js";e(a,t,"ile-3",{class:"my-12",href:"/post/2022/09/csapp-3",filename:"src/pages/post/2022/09/csapp-3.mdx",frontmatter:{title:"CS:APP 第三章学习笔记",date:new Date(1663553588e3),image:"/images/2022/09/csapp-3.png",tags:["csapp","学习笔记"],lastUpdated:new Date(1673269583e3),published:new Date(166399937e4),visitor:192,description:`CS:APP 第三章 “Machine-Level Representation of Programs” 的学习笔记。
这章的主要内容为汇编（machine-level programming）。
`}},{});
</script><section class="article-style" itemprop="articleBody"><p><a href="https://csapp.cs.cmu.edu/">CS:APP</a> 第三章 <span class="mojikumi">“</span>Machine-Level Representation of Programs<span class="mojikumi">”</span> 的学习笔记<span class="mojikumi-line-end">。</span></p>
<p>这章的主要内容为汇编<span class="mojikumi-line-start">（</span>machine-level programming<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></p>

<p>近年来<span class="mojikumi-line-end">，</span>随着编译器和高级语言的发展<span class="mojikumi-line-end">，</span>手写汇编<span class="mojikumi-line-end">、</span>机器码的需求越来越低<span class="mojikumi-line-end">，</span>但阅读<span class="mojikumi-line-end">、</span>理解编译器的输出在优化程序性能<span class="mojikumi-line-end">、</span>避免安全漏洞等方面依然重要<span class="mojikumi-line-end">。</span></p>
<h2 id="program-encodings" class="heading"><a href="#program-encodings" class="heading-anchor" aria-label="章节： Program Encodings" tabindex="-1"></a><span>Program Encodings</span></h2>
<h3 id="汇编机器码中的程序状态" class="heading"><a href="#汇编机器码中的程序状态" class="heading-anchor" aria-label="章节： 汇编/机器码中的程序状态" tabindex="-1"></a><span>汇编/机器码中的程序状态</span></h3>
<p>x86-64 的程序状态包含<span class="mojikumi-line-end">：</span></p>
<ul>
<li>program counter<span class="mojikumi-line-end">，</span>表示待执行的下一条指令的地址<span class="mojikumi-line-end">，</span>用 <code>%rip</code> 表示</li>
<li><a href="#%E5%AF%84%E5%AD%98%E5%99%A8">register file</a><span class="mojikumi-line-end">，</span>16 个用来存储整型的寄存器</li>
<li><a href="#status-flags">status flags</a><span class="mojikumi-line-end">，</span>用来存储最近执行的运算的状态</li>
<li><a href="#ymm-%E5%AF%84%E5%AD%98%E5%99%A8">vector registers</a><span class="mojikumi-line-end">，</span>用来存储多个整型或浮点数</li>
</ul>
<h3 id="将-c-代码编译为汇编代码" class="heading"><a href="#将-c-代码编译为汇编代码" class="heading-anchor" aria-label="章节： 将 C 代码编译为汇编代码" tabindex="-1"></a><span>将 C 代码编译为汇编代码</span></h3>
<p>可以通过 <code>gcc -S</code> 生成汇编代码<span class="mojikumi-line-end">，</span>通过 <code>gcc -Og</code> 来启用<span class="mojikumi-line-start">“</span>以调试体验为目标的优化<span class="mojikumi">”</span><wbr><span class="mojikumi-line-start">（</span>后文中叙述的很多编译行为都是需要一些基本的优化的<span class="mojikumi-line-end">，</span>如果完全不启用任何优化<span class="mojikumi-line-end">，</span>可能编译结果会有很大的差别<span class="mojikumi-line-end">；</span>也就是说<span class="mojikumi-line-end">，</span>完全不优化和过度优化都会降低汇编代码的可读性<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></p>
<p>为了方便<span class="mojikumi-line-end">，</span>可以用一条命令编译并不留文件地查看汇编代码: <code>gcc a.c -Og -S -o - | bat -l asm</code><span class="mojikumi-line-end">。</span></p>
<p>例如<span class="mojikumi-line-end">，</span>下面的代码<span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h4 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="C 代码块" data-v-ad49d235="">C</h4><ile-root id="ile-4"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-4",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> </span><span style="color: #82AAFF">mult2</span><span style="color: #D6DEEB">(</span><span style="color: #C792EA">long</span><span style="color: #D6DEEB">, </span><span style="color: #C792EA">long</span><span style="color: #D6DEEB">);</span></span>
<span></span>
<span><span style="color: #C792EA">void</span><span style="color: #D6DEEB"> </span><span style="color: #82AAFF">multstore</span><span style="color: #D6DEEB">(</span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> </span><span style="color: #D7DBE0">x</span><span style="color: #D6DEEB">, </span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> </span><span style="color: #D7DBE0">y</span><span style="color: #D6DEEB">, </span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> </span><span style="color: #7FDBCA">*</span><span style="color: #D7DBE0">dest</span><span style="color: #D6DEEB">)</span></span>
<span><span style="color: #D6DEEB">{</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> t </span><span style="color: #C792EA">=</span><span style="color: #D6DEEB"> </span><span style="color: #82AAFF">mult2(x, y)</span><span style="color: #D6DEEB">;</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">*</span><span style="color: #D6DEEB">dest </span><span style="color: #C792EA">=</span><span style="color: #D6DEEB"> t;</span></span>
<span><span style="color: #D6DEEB">}</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #994CC3">long</span><span style="color: #403F53"> </span><span style="color: #4876D6">mult2</span><span style="color: #403F53">(</span><span style="color: #994CC3">long</span><span style="color: #403F53">, </span><span style="color: #994CC3">long</span><span style="color: #403F53">);</span></span>
<span></span>
<span><span style="color: #994CC3">void</span><span style="color: #403F53"> </span><span style="color: #4876D6">multstore</span><span style="color: #403F53">(</span><span style="color: #994CC3">long</span><span style="color: #403F53"> x, </span><span style="color: #994CC3">long</span><span style="color: #403F53"> y, </span><span style="color: #994CC3">long</span><span style="color: #403F53"> </span><span style="color: #0C969B">*</span><span style="color: #403F53">dest)</span></span>
<span><span style="color: #403F53">{</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">long</span><span style="color: #403F53"> t </span><span style="color: #994CC3">=</span><span style="color: #403F53"> </span><span style="color: #4876D6">mult2(x, y)</span><span style="color: #403F53">;</span></span>
<span><span style="color: #403F53">    </span><span style="color: #0C969B">*</span><span style="color: #403F53">dest </span><span style="color: #994CC3">=</span><span style="color: #403F53"> t;</span></span>
<span><span style="color: #403F53">}</span></span></code></pre></div></section>
<p>编译为如下的汇编代码<span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h4 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="Assembly 代码块" data-v-ad49d235="">Assembly</h4><ile-root id="ile-5"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-5",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #D6DEEB">	.file	"a.c"</span></span>
<span><span style="color: #D6DEEB">	.text</span></span>
<span><span style="color: #D6DEEB">	.globl	multstore</span></span>
<span><span style="color: #D6DEEB">	.type	multstore, @function</span></span>
<span><span style="color: #82AAFF">multstore:</span></span>
<span><span style="color: #C792EA">.</span><span style="color: #82AAFF">LFB0:</span></span>
<span><span style="color: #D6DEEB">	.cfi_startproc</span></span>
<span><span style="color: #D6DEEB">	pushq	%</span><span style="color: #82AAFF">rbx</span></span>
<span><span style="color: #D6DEEB">	.cfi_def_cfa_offset </span><span style="color: #F78C6C">16</span></span>
<span><span style="color: #D6DEEB">	.cfi_offset </span><span style="color: #F78C6C">3</span><span style="color: #D6DEEB">, -</span><span style="color: #F78C6C">16</span></span>
<span><span style="color: #D6DEEB">	</span><span style="color: #7FDBCA">movq</span><span style="color: #D6DEEB">	%</span><span style="color: #82AAFF">rdx</span><span style="color: #D6DEEB">, %</span><span style="color: #82AAFF">rbx</span></span>
<span><span style="color: #D6DEEB">	</span><span style="color: #7FDBCA">call</span><span style="color: #D6DEEB">	mult2@PLT</span></span>
<span><span style="color: #D6DEEB">	</span><span style="color: #7FDBCA">movq</span><span style="color: #D6DEEB">	%</span><span style="color: #82AAFF">rax</span><span style="color: #D6DEEB">, (%</span><span style="color: #82AAFF">rbx</span><span style="color: #D6DEEB">)</span></span>
<span><span style="color: #D6DEEB">	popq	%</span><span style="color: #82AAFF">rbx</span></span>
<span><span style="color: #D6DEEB">	.cfi_def_cfa_offset </span><span style="color: #F78C6C">8</span></span>
<span><span style="color: #D6DEEB">	</span><span style="color: #7FDBCA">ret</span></span>
<span><span style="color: #D6DEEB">	.cfi_endproc</span></span>
<span><span style="color: #C792EA">.</span><span style="color: #82AAFF">LFE0:</span></span>
<span><span style="color: #D6DEEB">	.size	multstore, .-multstore</span></span>
<span><span style="color: #D6DEEB">	.ident	"</span><span style="color: #82AAFF">GCC:</span><span style="color: #D6DEEB"> (GNU) </span><span style="color: #F78C6C">12.2</span><span style="color: #C792EA">.</span><span style="color: #82AAFF">0</span><span style="color: #D6DEEB">"</span></span>
<span><span style="color: #D6DEEB">	.section	.note.GNU-stack,"",@progbits</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #403F53">	.file	"a.c"</span></span>
<span><span style="color: #403F53">	.text</span></span>
<span><span style="color: #403F53">	.globl	multstore</span></span>
<span><span style="color: #403F53">	.type	multstore, @function</span></span>
<span><span style="color: #4876D6">multstore:</span></span>
<span><span style="color: #994CC3">.</span><span style="color: #4876D6">LFB0:</span></span>
<span><span style="color: #403F53">	.cfi_startproc</span></span>
<span><span style="color: #403F53">	pushq	%</span><span style="color: #4876D6">rbx</span></span>
<span><span style="color: #403F53">	.cfi_def_cfa_offset </span><span style="color: #AA0982">16</span></span>
<span><span style="color: #403F53">	.cfi_offset </span><span style="color: #AA0982">3</span><span style="color: #403F53">, -</span><span style="color: #AA0982">16</span></span>
<span><span style="color: #403F53">	</span><span style="color: #0C969B">movq</span><span style="color: #403F53">	%</span><span style="color: #4876D6">rdx</span><span style="color: #403F53">, %</span><span style="color: #4876D6">rbx</span></span>
<span><span style="color: #403F53">	</span><span style="color: #0C969B">call</span><span style="color: #403F53">	mult2@PLT</span></span>
<span><span style="color: #403F53">	</span><span style="color: #0C969B">movq</span><span style="color: #403F53">	%</span><span style="color: #4876D6">rax</span><span style="color: #403F53">, (%</span><span style="color: #4876D6">rbx</span><span style="color: #403F53">)</span></span>
<span><span style="color: #403F53">	popq	%</span><span style="color: #4876D6">rbx</span></span>
<span><span style="color: #403F53">	.cfi_def_cfa_offset </span><span style="color: #AA0982">8</span></span>
<span><span style="color: #403F53">	</span><span style="color: #0C969B">ret</span></span>
<span><span style="color: #403F53">	.cfi_endproc</span></span>
<span><span style="color: #994CC3">.</span><span style="color: #4876D6">LFE0:</span></span>
<span><span style="color: #403F53">	.size	multstore, .-multstore</span></span>
<span><span style="color: #403F53">	.ident	"</span><span style="color: #4876D6">GCC:</span><span style="color: #403F53"> (GNU) </span><span style="color: #AA0982">12.2</span><span style="color: #994CC3">.</span><span style="color: #4876D6">0</span><span style="color: #403F53">"</span></span>
<span><span style="color: #403F53">	.section	.note.GNU-stack,"",@progbits</span></span></code></pre></div></section>
<h3 id="反汇编与机器码" class="heading"><a href="#反汇编与机器码" class="heading-anchor" aria-label="章节： 反汇编与机器码" tabindex="-1"></a><span>反汇编与机器码</span></h3>
<p>可以通过 <code>objdump</code> 反汇编<span class="mojikumi-line-end">，</span>例如 <code>gcc a.c -Og -c &amp;&amp; objdump -d a.o</code> 得到<span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h4 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="Assembly 代码块" data-v-ad49d235="">Assembly</h4><ile-root id="ile-6"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-6",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #D6DEEB">a.o：     文件格式 elf64-x86-</span><span style="color: #F78C6C">64</span></span>
<span></span>
<span></span>
<span><span style="color: #D6DEEB">Disassembly of section .text:</span></span>
<span></span>
<span><span style="color: #F78C6C">0000000000000000</span><span style="color: #D6DEEB"> &lt;multstore&gt;:</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #F78C6C">0</span><span style="color: #D6DEEB">:	</span><span style="color: #F78C6C">53</span><span style="color: #D6DEEB">                   	</span><span style="color: #7FDBCA">push</span><span style="color: #D6DEEB">   %</span><span style="color: #82AAFF">rbx</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #F78C6C">1</span><span style="color: #D6DEEB">:	</span><span style="color: #F78C6C">48</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">89</span><span style="color: #D6DEEB"> d3             	</span><span style="color: #7FDBCA">mov</span><span style="color: #D6DEEB">    %</span><span style="color: #82AAFF">rdx</span><span style="color: #D6DEEB">,%</span><span style="color: #82AAFF">rbx</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #F78C6C">4</span><span style="color: #D6DEEB">:	e8 </span><span style="color: #F78C6C">00</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">00</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">00</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">00</span><span style="color: #D6DEEB">       	</span><span style="color: #7FDBCA">call</span><span style="color: #D6DEEB">   </span><span style="color: #F78C6C">9</span><span style="color: #D6DEEB"> &lt;multstore+</span><span style="color: #F78C6C">0x9</span><span style="color: #D6DEEB">&gt;</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #F78C6C">9</span><span style="color: #D6DEEB">:	</span><span style="color: #F78C6C">48</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">89</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">03</span><span style="color: #D6DEEB">             	</span><span style="color: #7FDBCA">mov</span><span style="color: #D6DEEB">    %</span><span style="color: #82AAFF">rax</span><span style="color: #D6DEEB">,(%</span><span style="color: #82AAFF">rbx</span><span style="color: #D6DEEB">)</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #82AAFF">c:</span><span style="color: #D6DEEB">	5b                   	</span><span style="color: #7FDBCA">pop</span><span style="color: #D6DEEB">    %</span><span style="color: #82AAFF">rbx</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #82AAFF">d:</span><span style="color: #D6DEEB">	c3                   	</span><span style="color: #7FDBCA">ret</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #403F53">a.o：     文件格式 elf64-x86-</span><span style="color: #AA0982">64</span></span>
<span></span>
<span></span>
<span><span style="color: #403F53">Disassembly of section .text:</span></span>
<span></span>
<span><span style="color: #AA0982">0000000000000000</span><span style="color: #403F53"> &lt;multstore&gt;:</span></span>
<span><span style="color: #403F53">   </span><span style="color: #AA0982">0</span><span style="color: #403F53">:	</span><span style="color: #AA0982">53</span><span style="color: #403F53">                   	</span><span style="color: #0C969B">push</span><span style="color: #403F53">   %</span><span style="color: #4876D6">rbx</span></span>
<span><span style="color: #403F53">   </span><span style="color: #AA0982">1</span><span style="color: #403F53">:	</span><span style="color: #AA0982">48</span><span style="color: #403F53"> </span><span style="color: #AA0982">89</span><span style="color: #403F53"> d3             	</span><span style="color: #0C969B">mov</span><span style="color: #403F53">    %</span><span style="color: #4876D6">rdx</span><span style="color: #403F53">,%</span><span style="color: #4876D6">rbx</span></span>
<span><span style="color: #403F53">   </span><span style="color: #AA0982">4</span><span style="color: #403F53">:	e8 </span><span style="color: #AA0982">00</span><span style="color: #403F53"> </span><span style="color: #AA0982">00</span><span style="color: #403F53"> </span><span style="color: #AA0982">00</span><span style="color: #403F53"> </span><span style="color: #AA0982">00</span><span style="color: #403F53">       	</span><span style="color: #0C969B">call</span><span style="color: #403F53">   </span><span style="color: #AA0982">9</span><span style="color: #403F53"> &lt;multstore+</span><span style="color: #AA0982">0x9</span><span style="color: #403F53">&gt;</span></span>
<span><span style="color: #403F53">   </span><span style="color: #AA0982">9</span><span style="color: #403F53">:	</span><span style="color: #AA0982">48</span><span style="color: #403F53"> </span><span style="color: #AA0982">89</span><span style="color: #403F53"> </span><span style="color: #AA0982">03</span><span style="color: #403F53">             	</span><span style="color: #0C969B">mov</span><span style="color: #403F53">    %</span><span style="color: #4876D6">rax</span><span style="color: #403F53">,(%</span><span style="color: #4876D6">rbx</span><span style="color: #403F53">)</span></span>
<span><span style="color: #403F53">   </span><span style="color: #4876D6">c:</span><span style="color: #403F53">	5b                   	</span><span style="color: #0C969B">pop</span><span style="color: #403F53">    %</span><span style="color: #4876D6">rbx</span></span>
<span><span style="color: #403F53">   </span><span style="color: #4876D6">d:</span><span style="color: #403F53">	c3                   	</span><span style="color: #0C969B">ret</span></span></code></pre></div></section>
<p>可以看出<span class="mojikumi-line-end">，</span>机器码就是一串 bytes<span class="mojikumi-line-end">，</span>若干个 bytes 合在一起表示一条指令<span class="mojikumi-line-end">。</span>而每条指令对应的 bytes 数量不同<span class="mojikumi-line-end">，</span>与 operands 个数以及指令的常用程度相关<span class="mojikumi-line-start">（</span>类似摩斯电码<span class="mojikumi-line-end">、</span>UTF-8<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></p>
<a id="指令集的-reference；att-格式-vs-intel-格式" name="指令集的-reference；att-格式-vs-intel-格式" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-blue-1 dark:bg-blue-9 b-blue" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-pencil text-blue" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Note: </span><span data-v-a2ab257f="">指令集的 reference；ATT 格式 vs Intel 格式</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>CS:APP 以及 gcc 默认使用的是 ATT 格式的汇编<span class="mojikumi-line-end">，</span>可以在 <a href="https://docs.oracle.com/cd/E19253-01/817-5477/enmzx/index.html">Instruction Set Mapping - Oracle x86 Assembly Language Reference Manual</a> 查看 ATT 格式汇编和实际指令之间的对应关系<span class="mojikumi-line-end">，</span>在 <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html">Intel® 64 and IA-32 Architectures Software Developer Manuals</a><span class="mojikumi-line-start">（</span>下文中以 <span class="mojikumi">“</span>Intel Manual<span class="mojikumi">”</span> 指代<span class="mojikumi">）</span><wbr><span class="mojikumi-line-start">（</span>主要是第 2 卷<span class="mojikumi-line-end">）</span>查看具体指令的 reference<span class="mojikumi-line-end">。</span></p><p>ATT 格式与 Intel 格式有一些差别<span class="mojikumi-line-end">，</span>其中在查看 reference 时需要注意的是<span class="mojikumi-line-end">，</span>Intel 格式的指令没有 <code>b/w/l/q</code> 的类型后缀<span class="mojikumi-line-end">，</span>并且 operands 的顺序和 ATT 格式恰好相反<span class="mojikumi-line-end">。</span></p></div></div></aside>
<h2 id="data-formats" class="heading"><a href="#data-formats" class="heading-anchor" aria-label="章节： Data Formats" tabindex="-1"></a><span>Data Formats</span></h2>
<p>由于历史原因<span class="mojikumi-line-end">，</span>Intel 使用 <span class="mojikumi">“</span>word<span class="mojikumi">”</span> 表示 16 bits<span class="mojikumi-line-end">，</span>而用 <span class="mojikumi">“</span>double word<span class="mojikumi">”</span> 表示 32 bits<span class="mojikumi-line-end">，</span>用 <span class="mojikumi">“</span>quad word<span class="mojikumi">”</span> 表示 64 bits<span class="mojikumi-line-end">。</span></p>
<p>C 语言类型在 x86-64 中的大小<span class="mojikumi-line-end">：</span></p>
<div class="overflow-auto my-6"><table>
<thead>
<tr>
<th align="center">C 语言类型</th>
<th align="center">Intel 数据类型</th>
<th align="center">汇编后缀</th>
<th align="center">bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>char</code></td>
<td align="center">byte</td>
<td align="center"><code>b</code></td>
<td align="center">1</td>
</tr>
<tr>
<td align="center"><code>short</code></td>
<td align="center">word</td>
<td align="center"><code>w</code></td>
<td align="center">2</td>
</tr>
<tr>
<td align="center"><code>int</code></td>
<td align="center">double word</td>
<td align="center"><code>l</code> (long)</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center"><code>long</code></td>
<td align="center">quad word</td>
<td align="center"><code>q</code></td>
<td align="center">8</td>
</tr>
<tr>
<td align="center">指针</td>
<td align="center">quad word</td>
<td align="center"><code>q</code></td>
<td align="center">8</td>
</tr>
<tr>
<td align="center"><code>float</code></td>
<td align="center">single precision</td>
<td align="center"><code>s</code> (short)</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center"><code>double</code></td>
<td align="center">double precision</td>
<td align="center"><code>l</code> (long)</td>
<td align="center">8</td>
</tr>
</tbody>
</table></div>
<p>每种类型都有一个用在汇编指令中的后缀<span class="mojikumi-line-end">，</span>表示 operand 的类型<span class="mojikumi-line-end">，</span>例如 <code>movb</code><span class="mojikumi-line-end">、</span><code>movw</code><span class="mojikumi-line-end">、</span><code>movl</code><span class="mojikumi-line-end">、</span><code>movq</code><span class="mojikumi-line-end">。</span><code>l</code> 既用于 double word 也用于 double precision<span class="mojikumi-line-end">，</span>但整数和浮点数涉及的指令不同<span class="mojikumi-line-end">，</span>所以不会有歧义<span class="mojikumi">。</span><wbr><span class="mojikumi-line-start">（</span>后文中 <a href="#floating-point-code">Floating-Point Code</a> 用的 AVX2 指令并不使用 <code>s</code>/<code>l</code> 的浮点数类型后缀<span class="mojikumi">。</span><span class="mojikumi-line-end">）</span></p>
<h2 id="accessing-information" class="heading"><a href="#accessing-information" class="heading-anchor" aria-label="章节： Accessing Information" tabindex="-1"></a><span>Accessing Information</span></h2>
<h3 id="寄存器" class="heading"><a href="#寄存器" class="heading-anchor" aria-label="章节： 寄存器" tabindex="-1"></a><span>寄存器</span></h3>
<p>x86-64 CPU 有 16 个 general-purpose register<span class="mojikumi-line-end">，</span>可以用来存整数或指针<span class="mojikumi-line-end">：</span></p>
<div class="overflow-auto my-6"><table>
<thead>
<tr>
<th align="center">quad word</th>
<th align="center">double word</th>
<th align="center">word</th>
<th align="center">byte</th>
<th align="center">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>%rax</code></td>
<td align="center"><code>%eax</code></td>
<td align="center"><code>%ax</code></td>
<td align="center"><code>%al</code></td>
<td align="center">return value</td>
</tr>
<tr>
<td align="center"><code>%rbx</code></td>
<td align="center"><code>%ebx</code></td>
<td align="center"><code>%bx</code></td>
<td align="center"><code>%bl</code></td>
<td align="center">callee saved</td>
</tr>
<tr>
<td align="center"><code>%rcx</code></td>
<td align="center"><code>%ecx</code></td>
<td align="center"><code>%cx</code></td>
<td align="center"><code>%cl</code></td>
<td align="center">4th argument</td>
</tr>
<tr>
<td align="center"><code>%rdx</code></td>
<td align="center"><code>%edx</code></td>
<td align="center"><code>%dx</code></td>
<td align="center"><code>%dl</code></td>
<td align="center">3rd argument</td>
</tr>
<tr>
<td align="center"><code>%rsi</code></td>
<td align="center"><code>%esi</code></td>
<td align="center"><code>%si</code></td>
<td align="center"><code>%sil</code></td>
<td align="center">2nd argument</td>
</tr>
<tr>
<td align="center"><code>%rdi</code></td>
<td align="center"><code>%edi</code></td>
<td align="center"><code>%di</code></td>
<td align="center"><code>%dil</code></td>
<td align="center">1st argument</td>
</tr>
<tr>
<td align="center"><code>%rbp</code></td>
<td align="center"><code>%ebp</code></td>
<td align="center"><code>%bp</code></td>
<td align="center"><code>%bpl</code></td>
<td align="center">callee saved</td>
</tr>
<tr>
<td align="center"><code>%rsp</code></td>
<td align="center"><code>%esp</code></td>
<td align="center"><code>%sp</code></td>
<td align="center"><code>%spl</code></td>
<td align="center">stack pointer</td>
</tr>
<tr>
<td align="center"><code>%r8</code></td>
<td align="center"><code>%r8d</code></td>
<td align="center"><code>%r8w</code></td>
<td align="center"><code>%r8b</code></td>
<td align="center">5th argument</td>
</tr>
<tr>
<td align="center"><code>%r9</code></td>
<td align="center"><code>%r9d</code></td>
<td align="center"><code>%r9w</code></td>
<td align="center"><code>%r9b</code></td>
<td align="center">6th argument</td>
</tr>
<tr>
<td align="center"><code>%r10</code></td>
<td align="center"><code>%r10d</code></td>
<td align="center"><code>%r10w</code></td>
<td align="center"><code>%r10b</code></td>
<td align="center">caller saved</td>
</tr>
<tr>
<td align="center"><code>%r11</code></td>
<td align="center"><code>%r11d</code></td>
<td align="center"><code>%r11w</code></td>
<td align="center"><code>%r11b</code></td>
<td align="center">caller saved</td>
</tr>
<tr>
<td align="center"><code>%r12</code></td>
<td align="center"><code>%r12d</code></td>
<td align="center"><code>%r12w</code></td>
<td align="center"><code>%r12b</code></td>
<td align="center">callee saved</td>
</tr>
<tr>
<td align="center"><code>%r13</code></td>
<td align="center"><code>%r13d</code></td>
<td align="center"><code>%r13w</code></td>
<td align="center"><code>%r13b</code></td>
<td align="center">callee saved</td>
</tr>
<tr>
<td align="center"><code>%r14</code></td>
<td align="center"><code>%r14d</code></td>
<td align="center"><code>%r14w</code></td>
<td align="center"><code>%r14b</code></td>
<td align="center">callee saved</td>
</tr>
<tr>
<td align="center"><code>%r15</code></td>
<td align="center"><code>%r15d</code></td>
<td align="center"><code>%r15w</code></td>
<td align="center"><code>%r15b</code></td>
<td align="center">callee saved</td>
</tr>
</tbody>
</table></div>
<p>每个 register 可以用四种不同的长度访问<span class="mojikumi-line-end">，</span>其中短的是长的的低位<span class="mojikumi-line-end">。</span>修改 byte 或 word 的值时高位不变<span class="mojikumi-line-end">，</span>修改 double word 的值则会将高位清零<span class="mojikumi-line-end">。</span></p>
<p>不同寄存器的用途将在后文说明<span class="mojikumi-line-start">（</span>主要是在 <a href="#procedures">Procedures</a> 这一节<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></p>
<h3 id="operand-格式" class="heading"><a href="#operand-格式" class="heading-anchor" aria-label="章节： Operand 格式" tabindex="-1"></a><span>Operand 格式</span></h3>
<p>指令的 operand 有三种指定方式<span class="mojikumi-line-end">：</span></p>
<ol>
<li>Immediate<span class="mojikumi-line-end">，</span>即字面值<span class="mojikumi-line-end">，</span>代码为 <code>$Imm</code><span class="mojikumi-line-end">，</span>例如 <code>$123</code> 表示 123<span class="mojikumi-line-end">，</span><code>$0x123</code> 表示 0x123</li>
<li>Register<span class="mojikumi-line-end">，</span>代码为寄存器的名称<span class="mojikumi-line-end">，</span>例如 <code>%rax</code></li>
<li>Memory<span class="mojikumi-line-end">，</span>完整形态的代码为 <code>Imm(rb, ri, s)</code><span class="mojikumi-line-end">，</span>表示 <code>M[Imm + R[rb] + R[ri] * s]</code><span class="mojikumi-line-start">（</span>其中 <code>ri</code> 不为 <code>%rsp</code><span class="mojikumi-line-end">，</span><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>∈</mo><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>4</mn><mo separator="true">,</mo><mn>8</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">s \in \{1, 2, 4, 8\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">8</span><span class="mclose">}</span></span></span></span></span><span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>例如 <code>2(%rax, %rbx, 4)</code> 表示 memory 中地址为 <code>2 + %rax + 4 * %rbx</code> 的值<span class="mojikumi-line-end">；</span><code>Imm</code><span class="mojikumi-line-end">、</span><code>rb</code><span class="mojikumi-line-end">、</span><code>, ri, s</code> 分别可以省略<span class="mojikumi-line-end">，</span>例如 <code>Imm</code><span class="mojikumi-line-end">、</span><code>(rb)</code><span class="mojikumi-line-end">、</span><code>Imm(, ri, s)</code><span class="mojikumi-line-end">；</span>指定了 <code>ri</code> 时也可以省略 <code>s</code> 表示 <code>s</code> 为 1<span class="mojikumi-line-end">。</span></li>
</ol>
<p>在下文中<span class="mojikumi-line-end">，</span>用 <code>imm32</code><span class="mojikumi-line-end">、</span><code>r64</code><span class="mojikumi-line-end">、</span><code>m16</code><span class="mojikumi-line-end">、</span><code>r/m64</code> 等方式表示指令 operand 的类型<span class="mojikumi-line-end">。</span></p>
<p><span class="mojikumi-line-start">（</span>在 ATT 格式中<span class="mojikumi-line-end">）</span>有两个 operand 时<span class="mojikumi-line-end">，</span>第一个是 source<span class="mojikumi-line-end">，</span>第二个是 destination<span class="mojikumi-line-end">。</span></p>
<h3 id="move-类指令" class="heading"><a href="#move-类指令" class="heading-anchor" aria-label="章节： move 类指令" tabindex="-1"></a><span>move 类指令</span></h3>
<p>虽然叫 <span class="mojikumi">“</span>move<span class="mojikumi">”</span><span class="mojikumi-line-end">，</span>但实际上是复制<span class="mojikumi-line-end">。</span></p>
<h4 id="mov-指令" class="heading"><a href="#mov-指令" class="heading-anchor" aria-label="章节： MOV 指令" tabindex="-1"></a><span>MOV 指令</span></h4>
<p>source 和 destination 类型相同<span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>movb imm/r8, r/m8</code></li>
<li><code>movb m8, r8</code></li>
<li><code>movw imm/r16, r/m16</code></li>
<li><code>movw m16, r16</code></li>
<li><code>movl imm/r32, r/m32</code></li>
<li><code>movl m32, r32</code></li>
<li><code>movq imm32/r64, r/m64</code></li>
<li><code>movq m64, r64</code></li>
<li><code>movabsq imm64, r64</code></li>
</ul>
<p>其中<span class="mojikumi-line-end">，</span>source 和 destination 不能同时是 memory<span class="mojikumi-line-end">。</span></p>
<p>特别地<span class="mojikumi-line-end">，</span><code>movq</code> 不接受 imm64<span class="mojikumi-line-end">，</span>复制时会在 imm32 的高位补符号位<span class="mojikumi-line-end">；</span><code>movabsq</code> 可以接受 imm64<span class="mojikumi-line-end">，</span>但 destination 只能是寄存器<span class="mojikumi-line-end">。</span>这样设计的原因可以参考 <a href="https://stackoverflow.com/questions/62771323/why-we-cant-move-a-64-bit-immediate-value-to-memory">assembly - why we can't move a 64-bit immediate value to memory? - Stack Overflow</a><span class="mojikumi-line-end">。</span>实际上<span class="mojikumi-line-end">，</span>支持 imm64 作为 operand 的指令是少数<span class="mojikumi-line-end">，</span>后面还会看到很多不接受 imm64 的指令<span class="mojikumi-line-end">，</span>一般都是高位补符号位<span class="mojikumi-line-end">。</span></p>
<h4 id="movz-指令" class="heading"><a href="#movz-指令" class="heading-anchor" aria-label="章节： MOVZ 指令" tabindex="-1"></a><span>MOVZ 指令</span></h4>
<p>将高位补零后复制<span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>movzbw r/m8, r16</code></li>
<li><code>movzbl r/m8, r32</code></li>
<li><code>movzwl r/m16, r32</code></li>
<li><code>movzbq r/m8, r64</code></li>
<li><code>movzwq r/m16, r64</code></li>
</ul>
<p>没有 <code>movzlq</code> 这条指令<span class="mojikumi-line-end">，</span>因为将寄存器的值修改为一个 double word 时就会将高位清零<span class="mojikumi-line-end">，</span>所以使用 <code>movl</code> 就可以了<span class="mojikumi-line-end">。</span></p>
<a id="没用的-movzbq-和-movzwq-？" name="没用的-movzbq-和-movzwq-？" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-purple-2 dark:bg-purple-9 b-purple-5" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h5 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-help-circle-outline text-purple" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Question: </span><span data-v-a2ab257f="">没用的 <code>movzbq</code> 和 <code>movzwq</code> 🤔？</span></h5><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>虽然有 <code>movzbq</code> 和 <code>movzwq</code><span class="mojikumi-line-end">，</span>但一般会用 <code>movzbl</code> 和 <code>movzwl</code>
实现相应的功能<span class="mojikumi-line-end">。</span>没搜到为什么会有这两条指令...</p></div></div></aside>
<h4 id="movs-指令" class="heading"><a href="#movs-指令" class="heading-anchor" aria-label="章节： MOVS 指令" tabindex="-1"></a><span>MOVS 指令</span></h4>
<p>将高位补符号位后复制<span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>movsbw r/m8, r16</code></li>
<li><code>movsbl r/m8, r32</code></li>
<li><code>movsbq r/m8, r64</code></li>
<li><code>movswl r/m16, r32</code></li>
<li><code>movswq r/m16, r64</code></li>
<li><code>movslq r/m32, r64</code></li>
<li><code>cltq</code>: 和 <code>movslq %eax, %rax</code> 效果相同<span class="mojikumi-line-start">（</span>但编码更短<span class="mojikumi-line-end">）</span></li>
</ul>
<h3 id="pushpop-stack" class="heading"><a href="#pushpop-stack" class="heading-anchor" aria-label="章节： push/pop stack" tabindex="-1"></a><span>push/pop stack</span></h3>
<ul>
<li><code>pushq<wbr> <wbr>imm32<wbr>/<wbr>r<wbr>/<wbr>m64</code>: 将 <code>R[%rsp]</code> 减八<span class="mojikumi-line-end">，</span>然后将 operand 复制到 <code>M[R[%rsp]]</code><span class="mojikumi-line-start">（</span><code>PUSH</code> 指令不支持 imm64<span class="mojikumi-line-end">，</span>会将 imm32 高位补符号位<span class="mojikumi-line-end">）</span></li>
<li><code>popq r/m64</code>: 将 <code>M[R[%rsp]]</code> 复制到 operand<span class="mojikumi-line-end">，</span>然后将 <code>R[%rsp]</code> 加八</li>
</ul>
<p>可以看出<span class="mojikumi-line-end">，</span>program stack 是 memory 中连续的一段<span class="mojikumi-line-end">，</span>每个元素是一个 quad word<span class="mojikumi-line-end">，</span>top 的地址比 bottom 低<span class="mojikumi-line-end">，</span>push 时 stack pointer 减小<span class="mojikumi-line-end">。</span></p>
<p>由于 stack 不过是由 <code>%rsp</code> 标记栈顶的一段 memory<span class="mojikumi-line-end">，</span>可以通过给 <code>%rsp</code> 加上一个 offset 访问非栈顶元素<span class="mojikumi-line-end">，</span>例如 <code>8(%rsp)</code> 为栈顶下面的第一个元素<span class="mojikumi-line-end">。</span></p>
<a id="为什么-top-位于低地址？" name="为什么-top-位于低地址？" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-blue-1 dark:bg-blue-9 b-blue" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-pencil text-blue" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Note: </span><span data-v-a2ab257f="">为什么 top 位于低地址？</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>top 位于低地址可能看起来很怪<span class="mojikumi-line-end">，</span>可以参考 <a href="https://stackoverflow.com/questions/4560720/why-does-the-stack-address-grow-towards-decreasing-memory-addresses">Why does the stack address grow
towards decreasing memory addresses? - Stack
Overflow</a><span class="mojikumi-line-end">。</span>简单来说<span class="mojikumi-line-end">，</span>由于
memory layout 和 memory 曾经很小的历史原因<span class="mojikumi-line-end">，</span>stack 和 heap
会往不同的方向增长<span class="mojikumi-line-end">，</span>总会有一个在增长时减小地址<span class="mojikumi-line-end">，</span>而 x86-64 选择了 push stack
时减小地址<span class="mojikumi-line-end">，</span>这也使得访问非栈顶元素不需要给 offset 加负号<span class="mojikumi-line-end">。</span></p></div></div></aside>
<a id="pushqpopq-vs-直接修改-rsp" name="pushqpopq-vs-直接修改-rsp" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-blue-1 dark:bg-blue-9 b-blue" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-pencil text-blue" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Note: </span><span data-v-a2ab257f=""><code>pushq</code>/<code>popq</code> vs 直接修改 <code>%rsp</code></span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>除了 <code>pushq</code>/<code>popq</code><span class="mojikumi-line-end">，</span>也可以减小 <code>%rsp</code> 来向栈顶压入未初始化的数据<span class="mojikumi-line-end">，</span>或者增大
<code>%rsp</code> 来释放栈空间<span class="mojikumi-line-end">，</span>但这样做和 <code>pushq</code>/<code>popq</code>
相比哪个性能更好是比较复杂的<span class="mojikumi-line-end">，</span>可以参考 <a href="https://stackoverflow.com/questions/49485395/what-c-c-compiler-can-use-push-pop-instructions-for-creating-local-variables">assembly - What C/C++ compiler can
use push pop instructions for creating local variables, instead of just
increasing esp once? - Stack
Overflow</a><span class="mojikumi-line-end">。</span></p></div></div></aside>
<h2 id="arithmetic-and-logical-operations" class="heading"><a href="#arithmetic-and-logical-operations" class="heading-anchor" aria-label="章节： Arithmetic and Logical Operations" tabindex="-1"></a><span>Arithmetic and Logical Operations</span></h2>
<h3 id="load-effective-address" class="heading"><a href="#load-effective-address" class="heading-anchor" aria-label="章节： Load Effective Address" tabindex="-1"></a><span>Load Effective Address</span></h3>
<p><code>leaq m, r64</code>: 将 source operand 的地址复制到 destination operand<span class="mojikumi-line-start">（</span>只计算 source operand 的地址<span class="mojikumi-line-end">，</span>与其指向的 memory 中存储的值无关<span class="mojikumi-line-end">）</span></p>
<p>LEA 可以用来优化一些简单的算术<span class="mojikumi-line-end">，</span>例如<span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h4 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="C 代码块" data-v-ad49d235="">C</h4><ile-root id="ile-7"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-7",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> </span><span style="color: #82AAFF">scale</span><span style="color: #D6DEEB">(</span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> </span><span style="color: #D7DBE0">x</span><span style="color: #D6DEEB">, </span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> </span><span style="color: #D7DBE0">y</span><span style="color: #D6DEEB">, </span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> </span><span style="color: #D7DBE0">z</span><span style="color: #D6DEEB">)</span></span>
<span><span style="color: #D6DEEB">{</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">long</span><span style="color: #D6DEEB"> t </span><span style="color: #C792EA">=</span><span style="color: #D6DEEB"> x </span><span style="color: #7FDBCA">+</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">4</span><span style="color: #D6DEEB"> </span><span style="color: #7FDBCA">*</span><span style="color: #D6DEEB"> y </span><span style="color: #7FDBCA">+</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">12</span><span style="color: #D6DEEB"> </span><span style="color: #7FDBCA">*</span><span style="color: #D6DEEB"> z;</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #C792EA">return</span><span style="color: #D6DEEB"> t;</span></span>
<span><span style="color: #D6DEEB">}</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #994CC3">long</span><span style="color: #403F53"> </span><span style="color: #4876D6">scale</span><span style="color: #403F53">(</span><span style="color: #994CC3">long</span><span style="color: #403F53"> x, </span><span style="color: #994CC3">long</span><span style="color: #403F53"> y, </span><span style="color: #994CC3">long</span><span style="color: #403F53"> z)</span></span>
<span><span style="color: #403F53">{</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">long</span><span style="color: #403F53"> t </span><span style="color: #994CC3">=</span><span style="color: #403F53"> x </span><span style="color: #0C969B">+</span><span style="color: #403F53"> </span><span style="color: #AA0982">4</span><span style="color: #403F53"> </span><span style="color: #0C969B">*</span><span style="color: #403F53"> y </span><span style="color: #0C969B">+</span><span style="color: #403F53"> </span><span style="color: #AA0982">12</span><span style="color: #403F53"> </span><span style="color: #0C969B">*</span><span style="color: #403F53"> z;</span></span>
<span><span style="color: #403F53">    </span><span style="color: #994CC3">return</span><span style="color: #403F53"> t;</span></span>
<span><span style="color: #403F53">}</span></span></code></pre></div></section>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h4 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="Assembly 代码块" data-v-ad49d235="">Assembly</h4><ile-root id="ile-8"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-8",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #82AAFF">scale:</span></span>
<span><span style="color: #D6DEEB">	leaq	(%</span><span style="color: #82AAFF">rdi</span><span style="color: #D6DEEB">,%</span><span style="color: #82AAFF">rsi</span><span style="color: #D6DEEB">,</span><span style="color: #F78C6C">4</span><span style="color: #D6DEEB">), %</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">	leaq	(%</span><span style="color: #82AAFF">rdx</span><span style="color: #D6DEEB">,%</span><span style="color: #82AAFF">rdx</span><span style="color: #D6DEEB">,</span><span style="color: #F78C6C">2</span><span style="color: #D6DEEB">), %</span><span style="color: #82AAFF">rdx</span></span>
<span><span style="color: #D6DEEB">	leaq	(%</span><span style="color: #82AAFF">rax</span><span style="color: #D6DEEB">,%</span><span style="color: #82AAFF">rdx</span><span style="color: #D6DEEB">,</span><span style="color: #F78C6C">4</span><span style="color: #D6DEEB">), %</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">	</span><span style="color: #7FDBCA">ret</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #4876D6">scale:</span></span>
<span><span style="color: #403F53">	leaq	(%</span><span style="color: #4876D6">rdi</span><span style="color: #403F53">,%</span><span style="color: #4876D6">rsi</span><span style="color: #403F53">,</span><span style="color: #AA0982">4</span><span style="color: #403F53">), %</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">	leaq	(%</span><span style="color: #4876D6">rdx</span><span style="color: #403F53">,%</span><span style="color: #4876D6">rdx</span><span style="color: #403F53">,</span><span style="color: #AA0982">2</span><span style="color: #403F53">), %</span><span style="color: #4876D6">rdx</span></span>
<span><span style="color: #403F53">	leaq	(%</span><span style="color: #4876D6">rax</span><span style="color: #403F53">,%</span><span style="color: #4876D6">rdx</span><span style="color: #403F53">,</span><span style="color: #AA0982">4</span><span style="color: #403F53">), %</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">	</span><span style="color: #0C969B">ret</span></span></code></pre></div></section>
<p>这里三个 LEA 分别计算了 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>+</mo><mn>4</mn><mi>y</mi></mrow><annotation encoding="application/x-tex">x + 4y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">4</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>+</mo><mn>2</mn><mi>z</mi></mrow><annotation encoding="application/x-tex">z + 2z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mn>4</mn><mi>y</mi><mo stretchy="false">)</mo><mo>+</mo><mn>4</mn><mo stretchy="false">(</mo><mi>z</mi><mo>+</mo><mn>2</mn><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x + 4y) + 4 (z + 2z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span></span><span class="mojikumi-line-end">。</span></p>
<h3 id="一元运算" class="heading"><a href="#一元运算" class="heading-anchor" aria-label="章节： 一元运算" tabindex="-1"></a><span>一元运算</span></h3>
<p>每种一元运算都有 b/w/l/q 四个类型<span class="mojikumi-line-end">，</span>接受一个相应类型的 r/m<span class="mojikumi-line-end">，</span>将这个 operand 计算后的结果存入这个 operand<span class="mojikumi-line-end">：</span></p>
<ul>
<li><code>INC</code>: 加一</li>
<li><code>DEC</code>: 减一</li>
<li><code>NEG</code>: 取反 (negate)</li>
<li><code>NOT</code>: 按位取反 (complement)</li>
</ul>
<h3 id="二元运算" class="heading"><a href="#二元运算" class="heading-anchor" aria-label="章节： 二元运算" tabindex="-1"></a><span>二元运算</span></h3>
<p>每种二元运算都有 b/w/l/q 四个类型<span class="mojikumi-line-end">，</span>接受相应类型的 imm/r/m 作为 source<span class="mojikumi-line-start">（</span>除了 imm64<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>相应类型的 r/m 作为 destination<span class="mojikumi-line-start">（</span>source 和 destination 不能同时为 memory<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>效果为将 source<span class="mojikumi-line-start">“</span>作用于<span class="mojikumi-line-end">”</span>destination<span class="mojikumi-line-end">，</span>将运算结果存入 destination<span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>ADD</code>: 加</li>
<li><code>SUB</code>: destination 减去 source</li>
<li><code>IMUL</code>: 乘</li>
<li><code>XOR</code>: 按位异或</li>
<li><code>OR</code>: 按位或</li>
<li><code>AND</code>: 按位与</li>
</ul>
<p>特别地<span class="mojikumi-line-end">，</span>类似 <code>xorl %rdx, %rdx</code> 的代码可以用来优化 <code>movl $0, %rdx</code><span class="mojikumi-line-end">，</span>参见 Practice Problem 3.11 以及 <a href="https://stackoverflow.com/questions/33666617/what-is-the-best-way-to-set-a-register-to-zero-in-x86-assembly-xor-mov-or-and">performance - What is the best way to set a register to zero in x86 assembly: xor, mov or and? - Stack Overflow</a><span class="mojikumi-line-end">。</span></p>
<h3 id="位移" class="heading"><a href="#位移" class="heading-anchor" aria-label="章节： 位移" tabindex="-1"></a><span>位移</span></h3>
<p>位移有 b/w/l/q 四个类型<span class="mojikumi-line-end">，</span>source 只能是 imm8 或者 <code>%cl</code><span class="mojikumi-line-end">，</span>destination 是相应类型的 r/m<span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>SAL</code>/<code>SHL</code>: 左移</li>
<li><code>SAR</code>: 算术右移</li>
<li><code>SHR</code>: 逻辑右移</li>
</ul>
<a id="对过大位移位数的处理" name="对过大位移位数的处理" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-purple-2 dark:bg-purple-9 b-purple-5" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-help-circle-outline text-purple" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Question: </span><span data-v-a2ab257f="">对过大位移位数的处理</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>CS:APP 上说位移的位数会对 operand size 取模<span class="mojikumi-line-end">，</span>但根据 Intel Manual
以及我自己实验的结果<span class="mojikumi-line-end">，</span>应该是 b/w/l 对 32 取模<span class="mojikumi-line-end">，</span>q 对 64 取模<span class="mojikumi-line-end">；</span>errata
也没看到这一条<span class="mojikumi-line-end">，</span>不知道是怎么回事<span class="mojikumi-line-end">。</span></p></div></div></aside>
<h3 id="结果是-operand-两倍长度的运算" class="heading"><a href="#结果是-operand-两倍长度的运算" class="heading-anchor" aria-label="章节： 结果是 operand 两倍长度的运算" tabindex="-1"></a><span>结果是 operand 两倍长度的运算</span></h3>
<p>128 位的整数叫做 oct word<span class="mojikumi-line-end">，</span>需要存在两个寄存器中<span class="mojikumi-line-end">，</span>在指令中一般高位放在 <code>R[%rdx]</code> 低位放在 <code>R[%rax]</code><span class="mojikumi-line-end">。</span></p>
<p>虽然截去高位时是否有符号对编码层面的乘法没有影响<span class="mojikumi-line-end">，</span>不截去高位时就需要对 signed 和 unsigned 使用不同的指令了<span class="mojikumi-line-end">：</span></p>
<ul>
<li><code>imulq r/m64</code>: 计算 operand 和 <code>R[%rax]</code> 作为 signed integer 相乘而不截去高位的结果<span class="mojikumi-line-end">，</span>存在 <code>R<wbr>[%<wbr>rdx<wbr>]:<wbr>R<wbr>[%<wbr>rax<wbr>]</code> 中<span class="mojikumi">。</span><wbr><span class="mojikumi-line-start">（</span>如果有两个 operand 就是上面的 <a href="#%E4%BA%8C%E5%85%83%E8%BF%90%E7%AE%97">二元运算</a> 了<span class="mojikumi">。</span><span class="mojikumi-line-end">）</span></li>
<li><code>mulq r/m64</code>: 计算 operand 和 <code>R[%rax]</code> 作为 unsigned integer 相乘而不截去高位的结果<span class="mojikumi-line-end">，</span>存在 <code>R<wbr>[%<wbr>rdx<wbr>]:<wbr>R<wbr>[%<wbr>rax<wbr>]</code> 中<span class="mojikumi-line-end">。</span></li>
</ul>
<p>除法以及取模<span class="mojikumi-line-end">：</span></p>
<ul>
<li><code>cqto</code>/<code>cqtd</code>: 将 <code>R[%rax]</code> 高位填符号位放在 <code>R<wbr>[%<wbr>rdx<wbr>]:<wbr>R<wbr>[%<wbr>rax<wbr>]</code><span class="mojikumi-line-start">（</span>也就是用 <code>R[%rax]</code> 的符号位填满 <code>R[%rdx]</code><span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></li>
<li><code>idivq</code>: 计算 <code>R<wbr>[%<wbr>rdx<wbr>]:<wbr>R<wbr>[%<wbr>rax<wbr>]</code> 有符号地除以 operand<span class="mojikumi-line-end">，</span>商放在 <code>R[%rax]</code><span class="mojikumi-line-end">，</span>余数放在 <code>R[%rdx]</code><span class="mojikumi-line-end">。</span></li>
<li><code>divq</code>: 计算 <code>R<wbr>[%<wbr>rdx<wbr>]:<wbr>R<wbr>[%<wbr>rax<wbr>]</code> 无符号地除以 operand<span class="mojikumi-line-end">，</span>商放在 <code>R[%rax]</code><span class="mojikumi-line-end">，</span>余数放在 <code>R[%rdx]</code><span class="mojikumi-line-end">。</span></li>
</ul>
<p>得到的商都是向 0 取整<span class="mojikumi-line-end">，</span>所以被除数为负时余数非正<span class="mojikumi-line-end">。</span></p>
<p>若商溢出了<span class="mojikumi-line-end">，</span>则会触发 divide error 异常<span class="mojikumi-line-end">。</span>所以被除数一般会是 64 位整数<span class="mojikumi-line-start">（</span>在 <code>idivq</code> 之前用 <code>cqto</code> 来设置 <code>R[%rdx]</code><span class="mojikumi-line-end">，</span>在 <code>divq</code> 之前将 <code>R[%rdx]</code> 置为全零<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>否则很可能溢出而触发异常<span class="mojikumi-line-end">。</span></p>
<p>这些运算也有 operand 为 32 位<span class="mojikumi-line-end">，</span>结果为 64 位的版本<span class="mojikumi-line-end">：</span><code>imull</code><span class="mojikumi-line-end">、</span><code>mull</code><span class="mojikumi-line-end">、</span><code>cltd</code><span class="mojikumi-line-end">、</span><code>idivl</code><span class="mojikumi-line-end">、</span><code>divl</code><span class="mojikumi-line-end">。</span>它们以 <code>%edx</code> 和 <code>%eax</code> 来代替 128 位运算中的 <code>%rdx</code> 和 <code>%rax</code><span class="mojikumi-line-end">。</span></p>
<h2 id="control" class="heading"><a href="#control" class="heading-anchor" aria-label="章节： Control" tabindex="-1"></a><span>Control</span></h2>
<a id="“status-flag”-vs-“condition-code”" name="“status-flag”-vs-“condition-code”" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-green-2 dark:bg-green-9 b-green-5" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h3 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-lightbulb-outline text-green" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Hint: </span><span data-v-a2ab257f=""><span class="mojikumi">“</span>status flag<span class="mojikumi">”</span> vs <span class="mojikumi">“</span>condition code<span class="mojikumi">”</span></span></h3><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>在 CS:APP 中 <code>CF</code>/<code>ZF</code>/<code>SF</code>/<code>OF</code> 等被叫做 <span class="mojikumi">“</span>condition code<span class="mojikumi">”</span><span class="mojikumi-line-end">；</span>而在 Intel Manual
中<span class="mojikumi-line-end">，</span><code>CF</code>/<code>ZF</code>/<code>SF</code>/<code>OF</code> 等被叫做 <span class="mojikumi">“</span>status flag<span class="mojikumi">”</span><span class="mojikumi">，</span><wbr><span class="mojikumi-line-start">“</span>condition code<span class="mojikumi">”</span> 指的是 status
flags 的组合<span class="mojikumi-line-end">。</span>下文采用 Intel 的叫法<span class="mojikumi-line-end">。</span></p></div></div></aside>
<h3 id="status-flags" class="heading"><a href="#status-flags" class="heading-anchor" aria-label="章节： Status Flags" tabindex="-1"></a><span>Status Flags</span></h3>
<p>status flags 中存储了最近一次运算的状态<span class="mojikumi-line-end">，</span>常用的 status flag 有四个<span class="mojikumi-line-end">：</span></p>
<ul>
<li><code>CF</code>: Carry Flag<span class="mojikumi-line-end">，</span>表示运算过程中发生了超出 operand 长度的进位或借位<span class="mojikumi-line-end">，</span>即将运算视作 unsigned 发生了溢出<span class="mojikumi-line-end">。</span></li>
<li><code>ZF</code>: Zero Flag<span class="mojikumi-line-end">，</span>表示运算结果为零<span class="mojikumi-line-end">。</span></li>
<li><code>SF</code>: Sign Flag<span class="mojikumi-line-end">，</span>表示运算结果<span class="mojikumi-line-start">（</span>看作补码<span class="mojikumi-line-end">）</span>为负<span class="mojikumi-line-end">，</span>即运算结果的符号位<span class="mojikumi-line-end">。</span></li>
<li><code>OF</code>: Overflow Flag<span class="mojikumi-line-end">，</span>表示若将运算视作 signed 发生了溢出<span class="mojikumi-line-end">。</span></li>
</ul>
<a id="arm-中的-carry-flag------carry-flag-vs-borrow-flag" name="arm-中的-carry-flag------carry-flag-vs-borrow-flag" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><details class="shadow-md rd-1 b-l-6 my-6 bg-blue-1 dark:bg-blue-9 b-blue" data-v-a2ab257f=""><summary class="p-3 flex justify-between items-center cursor-pointer" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-pencil text-blue" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Note: </span><span data-v-a2ab257f="">ARM 中的 carry flag —— carry flag vs borrow flag</span></h4><span class="details-icon text-5" data-v-a2ab257f=""></span></summary><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>在 ARM 中<span class="mojikumi-line-end">，</span>计算减法时<span class="mojikumi-line-end">，</span>与 x86 相反<span class="mojikumi-line-end">，</span>carry flag 为 0 表示溢出<span class="mojikumi-line-end">，</span>为 1 表示没有溢出<span class="mojikumi-line-end">。</span></p><p>这是因为<span class="mojikumi-line-end">，</span>计算减法有两种方式<span class="mojikumi-line-end">，</span><a href="https://en.wikipedia.org/wiki/Carry_flag#Vs._borrow_flag">subtract with borrow 和 subtract with carry</a><span class="mojikumi-line-end">：</span></p><ul>
<li>subtract with borrow 相当于普通的减法竖式计算<span class="mojikumi-line-end">，</span>计算过程中记录 borrow flag<span class="mojikumi-line-end">，</span>最后存储在 carry flag 中<span class="mojikumi-line-end">，</span>表现为若最后发生借位则 carry flag 为 1<span class="mojikumi-line-end">。</span></li>
<li>subtract with carry 利用了 <code>-x = ~x + 1</code> 的性质<span class="mojikumi-line-end">，</span>通过 <code>a + ~b + 1</code> 来计算 <code>a - b</code><span class="mojikumi-line-end">，</span>而和普通加法一样计算 carry flag<span class="mojikumi-line-end">；</span>而在 subtract with borrow 最后发生借位时<span class="mojikumi-line-end">，</span>subtract with carry 反而 carry flag 是 0<span class="mojikumi-line-end">。</span></li>
</ul><p>可以这么理解这两者间的差异<span class="mojikumi-line-end">：</span>设计算是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span></span> 位的<span class="mojikumi-line-end">，</span>最后计算完成时<span class="mojikumi-line-end">，</span>borrow flag 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">w+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> 位上是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">1</span></span></span></span></span><span class="mojikumi-line-end">，</span>carry flag 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">w+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> 位上是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span><span class="mojikumi-line-end">，</span>而 subtract with carry 相当于先加上了 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mi>w</mi></msup></mrow><annotation encoding="application/x-tex">2^w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6644em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span></span></span></span></span></span></span></span> 再进行减法<span class="mojikumi-line-end">，</span>就会将第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">w+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> 位从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">1</span></span></span></span></span> 变成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span><span class="mojikumi-line-end">，</span>从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span> 变成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span><span class="mojikumi-line-end">。</span></p></div></details></aside>
<p>LEA 不会改变 status flags<span class="mojikumi-line-end">。</span></p>
<p><a href="#%E4%B8%80%E5%85%83%E8%BF%90%E7%AE%97">一元运算</a> 和 <a href="#%E4%BA%8C%E5%85%83%E8%BF%90%E7%AE%97">二元运算</a> 都会改变 status flags<span class="mojikumi-line-end">。</span>特别地<span class="mojikumi-line-end">，</span><code>INC</code> 和 <code>DEC</code> 不会改变 <code>CF</code><span class="mojikumi-line-end">。</span></p>
<p>位移对 status flags 的影响比较复杂<span class="mojikumi-line-start">（</span>可以参考 Intel Manual<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>简单来说 <code>CF</code> 会被设为最后一个移出的位<span class="mojikumi-line-end">，</span>只有位移位数为 1 时才会改变 <code>OF</code><span class="mojikumi-line-end">。</span></p>
<h3 id="condition-codes" class="heading"><a href="#condition-codes" class="heading-anchor" aria-label="章节： Condition Codes" tabindex="-1"></a><span>Condition Codes</span></h3>
<p>condition code 是 status flags 的组合<span class="mojikumi-line-end">，</span>常用的有<span class="mojikumi-line-end">：</span></p>
<div class="overflow-auto my-6"><table>
<thead>
<tr>
<th align="center">condition code</th>
<th align="center">名称 (意义)</th>
<th align="center">取值</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>e</code>/<code>z</code></td>
<td align="center">equal / zero</td>
<td align="center"><code>ZF</code></td>
</tr>
<tr>
<td align="center"><code>ne</code>/<code>nz</code></td>
<td align="center">not equal / not zero</td>
<td align="center"><code>~ZF</code></td>
</tr>
<tr>
<td align="center"><code>s</code></td>
<td align="center">sign (negative)</td>
<td align="center"><code>SF</code></td>
</tr>
<tr>
<td align="center"><code>ns</code></td>
<td align="center">not sign (non-negative)</td>
<td align="center"><code>~SF</code></td>
</tr>
<tr>
<td align="center"><code>g</code>/<code>nle</code></td>
<td align="center">greater / not less equal (signed <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&gt;</span></span></span></span></span>)</td>
<td align="center"><code>~(SF ^ OF) &amp; ~ZF</code></td>
</tr>
<tr>
<td align="center"><code>ge</code>/<code>nl</code></td>
<td align="center">greater equal / not less (signed <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≥</mo></mrow><annotation encoding="application/x-tex">\ge</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mrel">≥</span></span></span></span></span>)</td>
<td align="center"><code>~(SF ^ OF)</code></td>
</tr>
<tr>
<td align="center"><code>l</code>/<code>nge</code></td>
<td align="center">less / not greater equal (signed <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo></mrow><annotation encoding="application/x-tex">&lt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span></span></span></span></span>)</td>
<td align="center"><code>SF ^ OF</code></td>
</tr>
<tr>
<td align="center"><code>le</code>/<code>ng</code></td>
<td align="center">less equal / not greater (signed <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≤</mo></mrow><annotation encoding="application/x-tex">\le</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mrel">≤</span></span></span></span></span>)</td>
<td align="center"><code>(SF ^ OF) | ZF</code></td>
</tr>
<tr>
<td align="center"><code>a</code>/<code>nbe</code></td>
<td align="center">above / not below equal (unsigned <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&gt;</span></span></span></span></span>)</td>
<td align="center"><code>~CF &amp; ~ZF</code></td>
</tr>
<tr>
<td align="center"><code>ae</code>/<code>nb</code></td>
<td align="center">above equal / not below (unsigned <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≥</mo></mrow><annotation encoding="application/x-tex">\ge</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mrel">≥</span></span></span></span></span>)</td>
<td align="center"><code>~CF</code></td>
</tr>
<tr>
<td align="center"><code>b</code>/<code>nae</code></td>
<td align="center">below / not above equal (unsigned <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo></mrow><annotation encoding="application/x-tex">&lt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span></span></span></span></span>)</td>
<td align="center"><code>CF</code></td>
</tr>
<tr>
<td align="center"><code>be</code>/<code>na</code></td>
<td align="center">below equal / not above (unsigned <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≤</mo></mrow><annotation encoding="application/x-tex">\le</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mrel">≤</span></span></span></span></span>)</td>
<td align="center"><code>CF | ZF</code></td>
</tr>
</tbody>
</table></div>
<p>这些 condition code 都是按照减法的结果来命名的<span class="mojikumi-line-end">，</span>在使用 <code>CMP</code> 指令时这些名称是自然的<span class="mojikumi-line-end">，</span>但如果不是 <code>CMP</code>/<code>SUB</code> 则要考虑进行的运算是什么以及每个 condition code 实际的取值<span class="mojikumi-line-end">。</span></p>
<p><code>l</code>/<code>nge</code> 可以理解为<span class="mojikumi-line-end">，</span>溢出后会变号<span class="mojikumi-line-end">，</span>所以 <code>SF ^ OF</code> 就是如果不溢出的符号<span class="mojikumi-line-end">；</span><code>b</code>/<code>nae</code> 是因为减法发生借位时会标记 <code>CF</code><span class="mojikumi-line-end">。</span></p>
<h3 id="cmp-和-test-指令" class="heading"><a href="#cmp-和-test-指令" class="heading-anchor" aria-label="章节： CMP 和 TEST 指令" tabindex="-1"></a><span>CMP 和 TEST 指令</span></h3>
<p>如果真的进行运算<span class="mojikumi-line-end">，</span>destination 的值会被覆盖<span class="mojikumi-line-end">，</span>所以<span class="mojikumi-line-end">，</span>如果计算结果是不需要的<span class="mojikumi-line-end">，</span>一般会用 <code>CMP</code> 和 <code>TEST</code> 来获取 status flags<span class="mojikumi-line-end">。</span></p>
<p><code>CMP</code> 和 <code>TEST</code> 的 operands 和 <a href="#%E4%BA%8C%E5%85%83%E8%BF%90%E7%AE%97">二元运算</a> 相同<span class="mojikumi-line-end">。</span></p>
<p><code>CMP</code> 相当于执行 <code>SUB</code> 但只更新 status flags 不更新 destination<span class="mojikumi-line-end">。</span>常用于比较两个数的大小<span class="mojikumi-line-end">。</span></p>
<a id="cmp-的比较顺序" name="cmp-的比较顺序" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-orange-1 dark:bg-orange-9 b-orange" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-alert-circle-outline text-orange" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Warning: </span><span data-v-a2ab257f="">CMP 的比较顺序</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>由于 ATT 格式的汇编是 source 在前 destination 在后<span class="mojikumi">，</span> <code>CMP</code> 的减法是
destination 减去 source<span class="mojikumi">，</span> 所以比较是看起来是反的<span class="mojikumi-line-end">，</span>例如 <code>l</code> 其实是第二个
operand 小于第一个 operand<span class="mojikumi-line-end">。</span></p></div></div></aside>
<p><code>TEST</code> 相当于执行 <code>AND</code> 但只更新 status flags 不更新 destination<span class="mojikumi-line-end">。</span>常见的用法有两种<span class="mojikumi-line-end">，</span>一种是两个 operand 为同一个寄存器以判断其符号<span class="mojikumi-line-end">，</span>另一种是 source 为 bit mask<span class="mojikumi-line-end">。</span></p>
<h3 id="setcc-指令" class="heading"><a href="#setcc-指令" class="heading-anchor" aria-label="章节： SETcc 指令" tabindex="-1"></a><span>SETcc 指令</span></h3>
<p><code>SETcc r/m8</code>: 将 <code>cc</code> 复制到 operand 处<span class="mojikumi-line-end">。</span>其后缀不是 operand 的长度<span class="mojikumi-line-end">，</span>而是 condition code<span class="mojikumi-line-end">，</span>例如 <code>sete r/m8</code><span class="mojikumi-line-end">、</span><code>setne r/m8</code><span class="mojikumi-line-end">、</span><code>sets r/m8</code>...</p>
<h3 id="jump-类指令" class="heading"><a href="#jump-类指令" class="heading-anchor" aria-label="章节： Jump 类指令" tabindex="-1"></a><span>Jump 类指令</span></h3>
<h4 id="label" class="heading"><a href="#label" class="heading-anchor" aria-label="章节： Label" tabindex="-1"></a><span>Label</span></h4>
<p>在汇编中 jump 通常会使用 label 作为 jump target<span class="mojikumi-line-end">，</span>例如<span class="mojikumi-line-start">（</span>CS:APP P205<span class="mojikumi">）</span><span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h5 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="Assembly 代码块" data-v-ad49d235="">Assembly</h5><ile-root id="ile-9"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-9",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">movq</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">$0</span><span style="color: #D6DEEB">, %</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">jmp</span><span style="color: #D6DEEB">  .L1</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">movq</span><span style="color: #D6DEEB"> (%</span><span style="color: #82AAFF">rax</span><span style="color: #D6DEEB">), %</span><span style="color: #82AAFF">rdx</span></span>
<span><span style="color: #C792EA">.</span><span style="color: #82AAFF">L1:</span></span>
<span><span style="color: #D6DEEB">    popq %</span><span style="color: #82AAFF">rdx</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #403F53">    </span><span style="color: #0C969B">movq</span><span style="color: #403F53"> </span><span style="color: #AA0982">$0</span><span style="color: #403F53">, %</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">    </span><span style="color: #0C969B">jmp</span><span style="color: #403F53">  .L1</span></span>
<span><span style="color: #403F53">    </span><span style="color: #0C969B">movq</span><span style="color: #403F53"> (%</span><span style="color: #4876D6">rax</span><span style="color: #403F53">), %</span><span style="color: #4876D6">rdx</span></span>
<span><span style="color: #994CC3">.</span><span style="color: #4876D6">L1:</span></span>
<span><span style="color: #403F53">    popq %</span><span style="color: #4876D6">rdx</span></span></code></pre></div></section>
<p>这里的 <code>.L1</code> 就是一个 label<span class="mojikumi-line-end">。</span></p>
<h4 id="无条件跳转" class="heading"><a href="#无条件跳转" class="heading-anchor" aria-label="章节： 无条件跳转" tabindex="-1"></a><span>无条件跳转</span></h4>
<ul>
<li><code>jmp Label</code>: 跳转到 <code>Label</code> 处</li>
<li><code>jmp *r/m64</code>: 跳转到 operand 存储的 jump target 处<span class="mojikumi-line-end">，</span>例如 <code>jmp *%rax</code><span class="mojikumi-line-end">、</span><code>jmp *(%rax)</code><span class="mojikumi-line-end">。</span></li>
</ul>
<h4 id="条件跳转" class="heading"><a href="#条件跳转" class="heading-anchor" aria-label="章节： 条件跳转" tabindex="-1"></a><span>条件跳转</span></h4>
<p><code>Jcc Label</code>: 如果满足 <code>cc</code><span class="mojikumi-line-end">，</span>则跳转到 <code>Label</code> 处<span class="mojikumi-line-end">。</span></p>
<h4 id="rep-ret" class="heading"><a href="#rep-ret" class="heading-anchor" aria-label="章节： rep; ret" tabindex="-1"></a><span>rep; ret</span></h4>
<p>如果 <code>ret</code> 会作为某个分支的第一条指令<span class="mojikumi-line-start">（</span>即 jump 指令的下一条指令或 jump target<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>一般会把 <code>ret</code> 换成 <code>rep; ret</code><span class="mojikumi-line-end">，</span>效果和 <code>ret</code> 一样<span class="mojikumi-line-end">，</span>但可以避免错误的分支预测<span class="mojikumi-line-end">，</span>从而优化性能<span class="mojikumi-line-end">。</span>具体可以参考 <a href="https://repzret.org/p/repzret/">repz ret - repz ret</a><span class="mojikumi-line-end">。</span></p>
<h4 id="jump-指令编码" class="heading"><a href="#jump-指令编码" class="heading-anchor" aria-label="章节： jump 指令编码" tabindex="-1"></a><span>jump 指令编码</span></h4>
<p>在进行汇编时<span class="mojikumi-line-end">，</span>label 会被替换为 <i>jump 指令的<strong>下一条</strong>指令<span class="mojikumi-line-start">（</span>其实就是 program counter 的值<span class="mojikumi-line-end">）</span>到 jump target 的地址差</i><span class="mojikumi-line-end">。</span>而在链接时<span class="mojikumi-line-end">，</span>虽然指令的地址变了<span class="mojikumi-line-end">，</span>但指令之间相对的地址差不变<span class="mojikumi-line-end">，</span>则 jump 指令不用改变<span class="mojikumi-line-end">。</span></p>
<p>例如<span class="mojikumi-line-start">（</span>CS:APP P207<span class="mojikumi">）</span><span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h5 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="Assembly 代码块" data-v-ad49d235="">Assembly</h5><ile-root id="ile-10"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-10",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">movq</span><span style="color: #D6DEEB"> %</span><span style="color: #82AAFF">rdi</span><span style="color: #D6DEEB">, %</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">jmp</span><span style="color: #D6DEEB"> .L2</span></span>
<span><span style="color: #C792EA">.</span><span style="color: #82AAFF">L3:</span></span>
<span><span style="color: #D6DEEB">    sarq %</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #C792EA">.</span><span style="color: #82AAFF">L2:</span></span>
<span><span style="color: #D6DEEB">    testq %</span><span style="color: #82AAFF">rax</span><span style="color: #D6DEEB">, %</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">jg</span><span style="color: #D6DEEB"> .L3</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">rep</span><span style="color: #637777">; ret</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #403F53">    </span><span style="color: #0C969B">movq</span><span style="color: #403F53"> %</span><span style="color: #4876D6">rdi</span><span style="color: #403F53">, %</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">    </span><span style="color: #0C969B">jmp</span><span style="color: #403F53"> .L2</span></span>
<span><span style="color: #994CC3">.</span><span style="color: #4876D6">L3:</span></span>
<span><span style="color: #403F53">    sarq %</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #994CC3">.</span><span style="color: #4876D6">L2:</span></span>
<span><span style="color: #403F53">    testq %</span><span style="color: #4876D6">rax</span><span style="color: #403F53">, %</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">    </span><span style="color: #0C969B">jg</span><span style="color: #403F53"> .L3</span></span>
<span><span style="color: #403F53">    </span><span style="color: #0C969B">rep</span><span style="color: #989FB1">; ret</span></span></code></pre></div></section>
<p>汇编后<span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h5 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="Assembly 代码块" data-v-ad49d235="">Assembly</h5><ile-root id="ile-11"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-11",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #D6DEEB">   </span><span style="color: #F78C6C">0</span><span style="color: #D6DEEB">:	</span><span style="color: #F78C6C">48</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">89</span><span style="color: #D6DEEB"> f8             	</span><span style="color: #7FDBCA">mov</span><span style="color: #D6DEEB">    %</span><span style="color: #82AAFF">rdi</span><span style="color: #D6DEEB">,%</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #F78C6C">3</span><span style="color: #D6DEEB">:	eb </span><span style="color: #F78C6C">03</span><span style="color: #D6DEEB">                	</span><span style="color: #7FDBCA">jmp</span><span style="color: #D6DEEB">    </span><span style="color: #F78C6C">0x8</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #F78C6C">5</span><span style="color: #D6DEEB">:	</span><span style="color: #F78C6C">48</span><span style="color: #D6DEEB"> d1 f8             	</span><span style="color: #7FDBCA">sar</span><span style="color: #D6DEEB">    %</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #F78C6C">8</span><span style="color: #D6DEEB">:	</span><span style="color: #F78C6C">48</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">85</span><span style="color: #D6DEEB"> c0             	</span><span style="color: #7FDBCA">test</span><span style="color: #D6DEEB">   %</span><span style="color: #82AAFF">rax</span><span style="color: #D6DEEB">,%</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #82AAFF">b:</span><span style="color: #D6DEEB">	7f f8                	</span><span style="color: #7FDBCA">jg</span><span style="color: #D6DEEB">     </span><span style="color: #F78C6C">0x5</span></span>
<span><span style="color: #D6DEEB">   </span><span style="color: #82AAFF">d:</span><span style="color: #D6DEEB">	f3 c3                	</span><span style="color: #7FDBCA">repz</span><span style="color: #D6DEEB"> </span><span style="color: #7FDBCA">ret</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #403F53">   </span><span style="color: #AA0982">0</span><span style="color: #403F53">:	</span><span style="color: #AA0982">48</span><span style="color: #403F53"> </span><span style="color: #AA0982">89</span><span style="color: #403F53"> f8             	</span><span style="color: #0C969B">mov</span><span style="color: #403F53">    %</span><span style="color: #4876D6">rdi</span><span style="color: #403F53">,%</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">   </span><span style="color: #AA0982">3</span><span style="color: #403F53">:	eb </span><span style="color: #AA0982">03</span><span style="color: #403F53">                	</span><span style="color: #0C969B">jmp</span><span style="color: #403F53">    </span><span style="color: #AA0982">0x8</span></span>
<span><span style="color: #403F53">   </span><span style="color: #AA0982">5</span><span style="color: #403F53">:	</span><span style="color: #AA0982">48</span><span style="color: #403F53"> d1 f8             	</span><span style="color: #0C969B">sar</span><span style="color: #403F53">    %</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">   </span><span style="color: #AA0982">8</span><span style="color: #403F53">:	</span><span style="color: #AA0982">48</span><span style="color: #403F53"> </span><span style="color: #AA0982">85</span><span style="color: #403F53"> c0             	</span><span style="color: #0C969B">test</span><span style="color: #403F53">   %</span><span style="color: #4876D6">rax</span><span style="color: #403F53">,%</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">   </span><span style="color: #4876D6">b:</span><span style="color: #403F53">	7f f8                	</span><span style="color: #0C969B">jg</span><span style="color: #403F53">     </span><span style="color: #AA0982">0x5</span></span>
<span><span style="color: #403F53">   </span><span style="color: #4876D6">d:</span><span style="color: #403F53">	f3 c3                	</span><span style="color: #0C969B">repz</span><span style="color: #403F53"> </span><span style="color: #0C969B">ret</span></span></code></pre></div></section>
<p>这里 <code>jmp .L2</code> 的 operand 编码为 <code>0x03</code><span class="mojikumi-line-end">，</span>即其下一条指令的地址 <code>0x5</code> 到 jump target <code>0x8</code> 的距离<span class="mojikumi-line-end">；</span><code>jg .L3</code> 的 operand 编码为 <code>0xf8</code> 即 -8<span class="mojikumi-line-end">，</span>也就是其下一条指令的地址 <code>0xd</code> 到 jump target <code>0x5</code> 的距离<span class="mojikumi-line-end">。</span></p>
<p>链接后<span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h5 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="Assembly 代码块" data-v-ad49d235="">Assembly</h5><ile-root id="ile-12"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-12",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #D6DEEB">000000000000112e &lt;foo&gt;:</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #FFFFFF">112e:</span><span style="color: #D6DEEB">       </span><span style="color: #F78C6C">48</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">89</span><span style="color: #D6DEEB"> f8                </span><span style="color: #7FDBCA">mov</span><span style="color: #D6DEEB">    %</span><span style="color: #82AAFF">rdi</span><span style="color: #D6DEEB">,%</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #F78C6C">1131</span><span style="color: #D6DEEB">:       eb </span><span style="color: #F78C6C">03</span><span style="color: #D6DEEB">                   </span><span style="color: #7FDBCA">jmp</span><span style="color: #D6DEEB">    </span><span style="color: #F78C6C">1136</span><span style="color: #D6DEEB"> &lt;foo+</span><span style="color: #F78C6C">0x8</span><span style="color: #D6DEEB">&gt;</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #F78C6C">1133</span><span style="color: #D6DEEB">:       </span><span style="color: #F78C6C">48</span><span style="color: #D6DEEB"> d1 f8                </span><span style="color: #7FDBCA">sar</span><span style="color: #D6DEEB">    %</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #F78C6C">1136</span><span style="color: #D6DEEB">:       </span><span style="color: #F78C6C">48</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">85</span><span style="color: #D6DEEB"> c0                </span><span style="color: #7FDBCA">test</span><span style="color: #D6DEEB">   %</span><span style="color: #82AAFF">rax</span><span style="color: #D6DEEB">,%</span><span style="color: #82AAFF">rax</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #F78C6C">1139</span><span style="color: #D6DEEB">:       7f f8                   </span><span style="color: #7FDBCA">jg</span><span style="color: #D6DEEB">     </span><span style="color: #F78C6C">1133</span><span style="color: #D6DEEB"> &lt;foo+</span><span style="color: #F78C6C">0x5</span><span style="color: #D6DEEB">&gt;</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #FFFFFF">113b:</span><span style="color: #D6DEEB">       f3 c3                   </span><span style="color: #7FDBCA">repz</span><span style="color: #D6DEEB"> </span><span style="color: #7FDBCA">ret</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #403F53">000000000000112e &lt;foo&gt;:</span></span>
<span><span style="color: #403F53">    </span><span style="color: #C96765">112e:</span><span style="color: #403F53">       </span><span style="color: #AA0982">48</span><span style="color: #403F53"> </span><span style="color: #AA0982">89</span><span style="color: #403F53"> f8                </span><span style="color: #0C969B">mov</span><span style="color: #403F53">    %</span><span style="color: #4876D6">rdi</span><span style="color: #403F53">,%</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">    </span><span style="color: #AA0982">1131</span><span style="color: #403F53">:       eb </span><span style="color: #AA0982">03</span><span style="color: #403F53">                   </span><span style="color: #0C969B">jmp</span><span style="color: #403F53">    </span><span style="color: #AA0982">1136</span><span style="color: #403F53"> &lt;foo+</span><span style="color: #AA0982">0x8</span><span style="color: #403F53">&gt;</span></span>
<span><span style="color: #403F53">    </span><span style="color: #AA0982">1133</span><span style="color: #403F53">:       </span><span style="color: #AA0982">48</span><span style="color: #403F53"> d1 f8                </span><span style="color: #0C969B">sar</span><span style="color: #403F53">    %</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">    </span><span style="color: #AA0982">1136</span><span style="color: #403F53">:       </span><span style="color: #AA0982">48</span><span style="color: #403F53"> </span><span style="color: #AA0982">85</span><span style="color: #403F53"> c0                </span><span style="color: #0C969B">test</span><span style="color: #403F53">   %</span><span style="color: #4876D6">rax</span><span style="color: #403F53">,%</span><span style="color: #4876D6">rax</span></span>
<span><span style="color: #403F53">    </span><span style="color: #AA0982">1139</span><span style="color: #403F53">:       7f f8                   </span><span style="color: #0C969B">jg</span><span style="color: #403F53">     </span><span style="color: #AA0982">1133</span><span style="color: #403F53"> &lt;foo+</span><span style="color: #AA0982">0x5</span><span style="color: #403F53">&gt;</span></span>
<span><span style="color: #403F53">    </span><span style="color: #C96765">113b:</span><span style="color: #403F53">       f3 c3                   </span><span style="color: #0C969B">repz</span><span style="color: #403F53"> </span><span style="color: #0C969B">ret</span></span></code></pre></div></section>
<h3 id="cmovcc-指令" class="heading"><a href="#cmovcc-指令" class="heading-anchor" aria-label="章节： CMOVcc 指令" tabindex="-1"></a><span>CMOVcc 指令</span></h3>
<p><code>CMOVcc</code> 可以在满足 <code>cc</code> 时将 source 复制到 destination<span class="mojikumi-line-end">。</span>这条指令在 ATT 格式中没有长度类型后缀<span class="mojikumi-line-end">，</span>通过 destination register 的长度来推断类型<span class="mojikumi-line-end">。</span>不接受 byte 作为 operand<span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>CMOVcc r/m16, r16</code></li>
<li><code>CMOVcc r/m32, r32</code></li>
<li><code>CMOVcc r/m64, r64</code></li>
</ul>
<h3 id="实现-if-else-语句" class="heading"><a href="#实现-if-else-语句" class="heading-anchor" aria-label="章节： 实现 if-else 语句" tabindex="-1"></a><span>实现 if-else 语句</span></h3>
<p>实现 if-else 语句主要有两种方式<span class="mojikumi-line-end">：</span></p>
<ol>
<li>Conditional control: 即通过 jump 指令更改指令执行的顺序<span class="mojikumi-line-end">。</span></li>
<li>Conditional moves: 即通过 <code>CMOVcc</code> 等指令<span class="mojikumi-line-end">，</span>根据条件决定是否执行这一条指令<span class="mojikumi-line-end">，</span>但不改变指令执行的顺序<span class="mojikumi-line-end">。</span></li>
</ol>
<p><span class="mojikumi-line-start">（</span>具体实现方式可以参考 CS:APP 中的例子<span class="mojikumi">。</span><span class="mojikumi-line-end">）</span></p>
<p>conditonal control 是通用的<span class="mojikumi-line-end">，</span>但 conditonal moves 只在有限的情况下可以使用<span class="mojikumi-line-end">。</span>一般来说<span class="mojikumi-line-end">，</span>使用 conditional moves 时需要先将两个分支都算出来<span class="mojikumi-line-end">，</span>然后根据条件来进行 move<span class="mojikumi-line-end">，</span>所以要求分支中没有副作用<span class="mojikumi-line-end">。</span></p>
<p>conditional moves 有时可以用来优化性能<span class="mojikumi-line-end">，</span>主要是因为现代处理器的 <i>pipelining</i><span class="mojikumi-line-end">，</span>即在物理上同时执行多条指令<span class="mojikumi-line-start">（</span>但在效果上和按顺序执行一致<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span>条件跳转使得处理器不能确定未来要执行哪些指令<span class="mojikumi-line-end">，</span>而只能进行分支预测<span class="mojikumi-line-end">，</span>如果预测失败 pipelining 就白费了<span class="mojikumi-line-end">。</span>而 conditional move 不会破坏指令执行的顺序<span class="mojikumi-line-end">，</span>也就不影响 pipelining<span class="mojikumi-line-end">，</span>所以可以起到优化的效果<span class="mojikumi-line-end">。</span>但是<span class="mojikumi-line-end">，</span>conditional moves 除了要求分支无副作用<span class="mojikumi-line-end">，</span>还需要两个 branch 都执行<span class="mojikumi-line-end">，</span>所以如果分支过大<span class="mojikumi-line-end">，</span>就不如 conditional control<span class="mojikumi-line-end">。</span></p>
<h3 id="实现循环语句" class="heading"><a href="#实现循环语句" class="heading-anchor" aria-label="章节： 实现循环语句" tabindex="-1"></a><span>实现循环语句</span></h3>
<p><code>do while</code>: 跑完一段代码后进行测试<span class="mojikumi-line-end">，</span>通过则跳转到开头<span class="mojikumi-line-end">。</span></p>
<p><code>while</code>: 在 <code>do while</code> 的基础上<span class="mojikumi-line-end">，</span>要么在开头直接跳转到测试 (jump to middle)<span class="mojikumi-line-end">，</span>要么在开头进行一次测试<span class="mojikumi-line-end">，</span>不通过则跳到结尾 (guarded do)<span class="mojikumi-line-end">。</span></p>
<p><code>for</code>: 在 <code>while</code> 的基础上<span class="mojikumi-line-end">，</span>开头初始化<span class="mojikumi-line-end">，</span>测试前更新<span class="mojikumi-line-end">。</span></p>
<h3 id="实现-switch-语句" class="heading"><a href="#实现-switch-语句" class="heading-anchor" aria-label="章节： 实现 switch 语句" tabindex="-1"></a><span>实现 switch 语句</span></h3>
<p>具体例子可以参考 CS:APP<span class="mojikumi-line-end">，</span>重点在于<span class="mojikumi-line-end">，</span>如果 cases 的值不过于稀疏<span class="mojikumi-line-end">，</span>可以建一个叫做 jump table 的数组<span class="mojikumi-line-end">，</span>以 cases 的值作为下标<span class="mojikumi-line-end">，</span>label 作为值<span class="mojikumi-line-end">，</span>这样就可以用一次数组访问而非多次条件跳转来实现 <code>switch</code> 语句<span class="mojikumi-line-end">。</span>jump table 也可以和条件跳转结合<span class="mojikumi-line-end">，</span>以处理 default case 或者个别 cases<span class="mojikumi-line-end">。</span></p>
<h2 id="procedures" class="heading"><a href="#procedures" class="heading-anchor" aria-label="章节： Procedures" tabindex="-1"></a><span>Procedures</span></h2>
<p>procedure 的实现主要涉及三个方面<span class="mojikumi-line-end">：</span></p>
<ul>
<li>在不同的 procedure 之间转移控制权<span class="mojikumi-line-end">，</span>即调用 procedure 时交出控制权<span class="mojikumi-line-end">，</span>procedure 返回时拿回控制权</li>
<li>传递参数和返回值</li>
<li>为局部变量分配/释放内存</li>
</ul>
<p>调用 procedure 的核心是在 <a href="#pushpop-stack">push/pop stack</a> 一节中介绍过的 runtime stack<span class="mojikumi-line-end">。</span>大体上来讲<span class="mojikumi-line-end">，</span>stack 会分成一堆 frame<span class="mojikumi-line-end">，</span>栈顶的 frame 为当前 procedure 的相关数据<span class="mojikumi-line-end">，</span>从栈顶到栈底的各个 frame 依次放着调用链上的各个 procedure<span class="mojikumi-line-end">，</span>在调用一个 procedure 时会将相关数据压入栈中<span class="mojikumi-line-end">，</span>返回时再弹出<span class="mojikumi-line-end">。</span></p>
<p>这部分会采取<span class="mojikumi-line-start">“</span>简介-原则-实现<span class="mojikumi-line-end">”</span>的结构<span class="mojikumi-line-end">，</span>先简单介绍大概是什么样的<span class="mojikumi-line-end">，</span>再说明实现需要遵循的原则<span class="mojikumi-line-end">，</span>再说明具体实现<span class="mojikumi-line-end">，</span>以及实现是如何满足以及利用原则的<span class="mojikumi-line-end">。</span></p>
<h3 id="转移控制权" class="heading"><a href="#转移控制权" class="heading-anchor" aria-label="章节： 转移控制权" tabindex="-1"></a><span>转移控制权</span></h3>
<p>调用 procedure 时<span class="mojikumi-line-end">，</span>会将当前 program counter 的值存在 stack 中<span class="mojikumi-line-end">，</span>然后将 program counter 修改为 callee<span class="mojikumi-line-end">，</span>在返回时再从 stack 中取出 caller 的地址设为 program counter<span class="mojikumi-line-end">。</span></p>
<a id="存放-caller-地址的原则" name="存放-caller-地址的原则" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-green-2 dark:bg-green-9 b-green-5" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-lightbulb-outline text-green" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Hint: </span><span data-v-a2ab257f="">存放 caller 地址的原则</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>进入一个 procedure 时<span class="mojikumi-line-end">，</span>栈顶放的是 caller 的地址<span class="mojikumi-line-start">（</span>具体来说<span class="mojikumi-line-end">，</span>是 <code>call</code> 指令的下一条指令的地址<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></p><p>返回时<span class="mojikumi-line-end">，</span>这个 caller 的地址会出栈<span class="mojikumi-line-end">，</span>即返回后的 <code>%rsp</code> 是进入时的 <code>%rsp</code> 加 8<span class="mojikumi-line-end">。</span></p></div></div></aside>
<p>具体实现会使用 <code>CALL</code> 和 <code>RET</code> 两条指令<span class="mojikumi-line-end">：</span></p>
<ul>
<li><code>call Label</code></li>
<li><code>call *(r/m64)</code></li>
<li><code>ret</code></li>
</ul>
<p>其中 <code>call</code> 的 operand 和 <code>jmp</code> 是一样的<span class="mojikumi-line-end">，</span>效果相当于先 <code>pushq %rip</code> 再 <code>jmp</code><span class="mojikumi-line-end">。</span><code>ret</code> 则相当于把 <code>popq</code> 的结果作为 <code>jmp</code> 的 operand<span class="mojikumi-line-end">。</span></p>
<h3 id="传递参数" class="heading"><a href="#传递参数" class="heading-anchor" aria-label="章节： 传递参数" tabindex="-1"></a><span>传递参数</span></h3>
<p>寄存器中有 6 个用来存放 procedure 的 arguments<span class="mojikumi-line-end">，</span>如果参数多于 6 个<span class="mojikumi-line-end">，</span>则会放在 stack 中<span class="mojikumi-line-end">。</span></p>
<div class="overflow-auto my-6"><table>
<thead>
<tr>
<th align="center">bits</th>
<th align="center">1</th>
<th align="center">2</th>
<th align="center">3</th>
<th align="center">4</th>
<th align="center">5</th>
<th align="center">6</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">64</td>
<td align="center"><code>%rdi</code></td>
<td align="center"><code>%rsi</code></td>
<td align="center"><code>%rdx</code></td>
<td align="center"><code>%rcx</code></td>
<td align="center"><code>%r8</code></td>
<td align="center"><code>%r9</code></td>
</tr>
<tr>
<td align="center">32</td>
<td align="center"><code>%edi</code></td>
<td align="center"><code>%esi</code></td>
<td align="center"><code>%edx</code></td>
<td align="center"><code>%ecx</code></td>
<td align="center"><code>%r8d</code></td>
<td align="center"><code>%r9d</code></td>
</tr>
<tr>
<td align="center">16</td>
<td align="center"><code>%di</code></td>
<td align="center"><code>%si</code></td>
<td align="center"><code>%dx</code></td>
<td align="center"><code>%cx</code></td>
<td align="center"><code>%r8w</code></td>
<td align="center"><code>%r9w</code></td>
</tr>
<tr>
<td align="center">8</td>
<td align="center"><code>%dil</code></td>
<td align="center"><code>%sil</code></td>
<td align="center"><code>%dl</code></td>
<td align="center"><code>%cl</code></td>
<td align="center"><code>%r8b</code></td>
<td align="center"><code>%r9b</code></td>
</tr>
</tbody>
</table></div>
<a id="存放参数的原则" name="存放参数的原则" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-green-2 dark:bg-green-9 b-green-5" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-lightbulb-outline text-green" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Hint: </span><span data-v-a2ab257f="">存放参数的原则</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>进入 procedure 时<span class="mojikumi-line-end">，</span>前 6 个参数<span class="mojikumi-line-start">（</span>如果有<span class="mojikumi-line-end">）</span>会被放在相应的寄存器中<span class="mojikumi-line-end">；</span>其余参数放在
stack 中<span class="mojikumi-line-end">，</span>具体来说<span class="mojikumi-line-end">，</span>第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span> 个参数被放在栈顶下面的第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">n-6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span></span></span></span></span> 个位置<span class="mojikumi-line-end">，</span>也就是
<code>M[R[%rsp] + 8(n-6)]</code><span class="mojikumi-line-end">。</span></p></div></div></aside>
<p>具体实现为<span class="mojikumi-line-end">：</span></p>
<ul>
<li>在 caller 中<span class="mojikumi-line-end">、</span><code>call</code> 之前<span class="mojikumi-line-end">：</span>将前 6 个参数放在相应的寄存器<span class="mojikumi-line-end">，</span>并将其余参数按从后向前的顺序依次压入 stack</li>
<li>在 caller 中<span class="mojikumi-line-end">、</span><code>call</code> 之后<span class="mojikumi-line-end">：</span>把 stack 中的参数<span class="mojikumi-line-start">（</span>如果有<span class="mojikumi-line-end">）</span>弹出 (<code>addq $8(n-6), %rsp</code>)</li>
<li>在 callee 中<span class="mojikumi-line-end">：</span>从相应的寄存器或 stack 中读取参数</li>
</ul>
<h3 id="传递返回值" class="heading"><a href="#传递返回值" class="heading-anchor" aria-label="章节： 传递返回值" tabindex="-1"></a><span>传递返回值</span></h3>
<a id="存放返回值的原则" name="存放返回值的原则" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-green-2 dark:bg-green-9 b-green-5" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-lightbulb-outline text-green" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Hint: </span><span data-v-a2ab257f="">存放返回值的原则</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>在调用 procedure 并返回后<span class="mojikumi-line-end">，</span>如果该 procedure 有返回值<span class="mojikumi-line-end">，</span><code>%rax</code>
中存放的是该返回值<span class="mojikumi-line-end">。</span></p></div></div></aside>
<p>具体实现就是在 <code>ret</code> 前确保 <code>%rax</code> 中放的是返回值<span class="mojikumi-line-end">。</span></p>
<h3 id="存储局部变量" class="heading"><a href="#存储局部变量" class="heading-anchor" aria-label="章节： 存储局部变量" tabindex="-1"></a><span>存储局部变量</span></h3>
<p>局部变量一般会优先放在寄存器中<span class="mojikumi-line-end">，</span>如果放不下就会放在 stack 中<span class="mojikumi-line-end">。</span></p>
<p>特别地<span class="mojikumi-line-end">，</span>如果代码中涉及到取局部变量的地址<span class="mojikumi-line-end">，</span>或者局部变量是结构化数据<span class="mojikumi-line-start">（</span>例如数组或结构体<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>则必须放在 stack 中<span class="mojikumi-line-end">。</span></p>
<p>如果局部变量放在寄存器中<span class="mojikumi-line-end">，</span>且在使用该局部变量的过程中调用了 procedure<span class="mojikumi-line-end">，</span>那么该局部变量就会需要先存起来以保证调用 procedure 之后不会改变<span class="mojikumi-line-end">，</span>而这有两种方式实现<span class="mojikumi-line-end">：</span></p>
<ul>
<li>caller saved<span class="mojikumi-line-end">，</span>即在 caller 中将寄存器里的值存在 stack 里<span class="mojikumi-line-end">。</span></li>
<li>callee saved<span class="mojikumi-line-end">，</span>即在 callee 中存储<span class="mojikumi-line-end">：</span>有一些特殊的寄存器是 callee-saved register<span class="mojikumi-line-end">，</span>如果把局部变量存在这些寄存器中<span class="mojikumi-line-end">，</span>在 caller 中就不用担心它们的值会在调用 procedure 后被修改<span class="mojikumi-line-end">。</span></li>
</ul>
<a id="callee-saved-registers-的使用原则" name="callee-saved-registers-的使用原则" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-green-2 dark:bg-green-9 b-green-5" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-lightbulb-outline text-green" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Hint: </span><span data-v-a2ab257f="">callee-saved registers 的使用原则</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>有 6 个特殊的寄存器 <code>%rbx</code><span class="mojikumi-line-end">、</span><code>%rbp</code><span class="mojikumi-line-end">、</span><code>%r12-15</code> 是 callee-saved register<span class="mojikumi-line-end">。</span></p><p>任何 procedure 都要保证<span class="mojikumi-line-end">，</span>每个 callee-saved register 的值在进入和返回时是相同的<span class="mojikumi-line-end">。</span></p></div></div></aside>
<p>caller saved 的具体实现<span class="mojikumi-line-end">：</span>在 <code>call</code> 之前<span class="mojikumi-line-start">（</span>以及压入超过 6 个的参数之前<span class="mojikumi-line-end">）</span>将局部变量入栈<span class="mojikumi-line-end">，</span><code>call</code> 之后<span class="mojikumi-line-start">（</span>以及弹出放在栈中的参数之后<span class="mojikumi-line-end">）</span>再把栈中存的弹出到寄存器中<span class="mojikumi-line-end">。</span></p>
<p>callee saved 的具体实现<span class="mojikumi-line-end">：</span>如果一个 procedure 使用了某个 callee-saved register<span class="mojikumi-line-end">，</span>则要在 procedure 的开头将这个寄存器原本的值入栈<span class="mojikumi-line-end">，</span>而在 procedure 的结尾将存下来的这个原本的值弹出到相应的寄存器中<span class="mojikumi-line-end">。</span></p>
<p>为了尽可能使用<span class="mojikumi-line-start">（</span>数量尽量少的<span class="mojikumi-line-end">）</span>寄存器而非 stack<span class="mojikumi-line-end">，</span>经常会有多个生命周期不交叉的的变量共用一个寄存器<span class="mojikumi-line-end">，</span>或者临时地把局部变量放在一般用于存放参数或返回值的寄存器中<span class="mojikumi-line-end">。</span></p>
<h3 id="可变大小的-stack-frame" class="heading"><a href="#可变大小的-stack-frame" class="heading-anchor" aria-label="章节： 可变大小的 stack frame" tabindex="-1"></a><span>可变大小的 stack frame</span></h3>
<p>通常情况下一个 procedure 的 stack frame 的大小是确定的<span class="mojikumi-line-end">，</span>但有时 stack frame 的大小是不能在编译时确定的<span class="mojikumi-line-start">（</span>例如有非确定大小的数组<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></p>
<p>stack frame 大小确定主要是为了能够通过与 <code>%rsp</code> 即栈顶的相对距离来访问局部变量等<span class="mojikumi-line-end">，</span>在 stack frame 大小不确定时<span class="mojikumi-line-end">，</span>则可以通过记录 stack frame 底部的地址来访问局部变量<span class="mojikumi-line-end">。</span></p>
<a id="stack-frame-pointer-的原则" name="stack-frame-pointer-的原则" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-green-2 dark:bg-green-9 b-green-5" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-lightbulb-outline text-green" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Hint: </span><span data-v-a2ab257f="">stack frame pointer 的原则</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>在 stack frame 大小不确定时<span class="mojikumi-line-end">，</span>使用 <code>%rbp</code> 作为 frame pointer (base
pointer)<span class="mojikumi-line-end">，</span>其值为刚进入 procedure 时的 <code>%rsp</code><span class="mojikumi-line-end">。</span></p></div></div></aside>
<p>具体实现为<span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h4 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="Assembly 代码块" data-v-ad49d235="">Assembly</h4><ile-root id="ile-13"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-13",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #82AAFF">function_name:</span></span>
<span><span style="color: #D6DEEB">    pushq %</span><span style="color: #82AAFF">rbp</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">movq</span><span style="color: #D6DEEB"> %</span><span style="color: #82AAFF">rsp</span><span style="color: #D6DEEB">, %</span><span style="color: #82AAFF">rbp</span></span>
<span><span style="color: #D6DEEB">    ……</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">leave</span></span>
<span><span style="color: #D6DEEB">    </span><span style="color: #7FDBCA">ret</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #4876D6">function_name:</span></span>
<span><span style="color: #403F53">    pushq %</span><span style="color: #4876D6">rbp</span></span>
<span><span style="color: #403F53">    </span><span style="color: #0C969B">movq</span><span style="color: #403F53"> %</span><span style="color: #4876D6">rsp</span><span style="color: #403F53">, %</span><span style="color: #4876D6">rbp</span></span>
<span><span style="color: #403F53">    ……</span></span>
<span><span style="color: #403F53">    </span><span style="color: #0C969B">leave</span></span>
<span><span style="color: #403F53">    </span><span style="color: #0C969B">ret</span></span></code></pre></div></section>
<p>设置好 <code>%rbp</code> 后<span class="mojikumi-line-end">，</span>就可以使用 <code>-8(%rbp)</code> 等方式访问相对于 stack frame 底端的位置了<span class="mojikumi-line-end">。</span></p>
<p>这里有一个新指令 <code>leave</code>: 没有 operand<span class="mojikumi-line-end">，</span>相当于 <code>move %rbp, %rsp</code> 然后 <code>pop %rbp</code><span class="mojikumi-line-end">。</span></p>
<a id="leave-vs-enter" name="leave-vs-enter" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-blue-1 dark:bg-blue-9 b-blue" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-pencil text-blue" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Note: </span><span data-v-a2ab257f=""><code>leave</code> vs <code>enter</code></span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>上面的代码中使用了 <code>leave</code> 而非 <code>move %rbp, %rsp</code><span class="mojikumi-line-end">、</span><code>pop %rbp</code><span class="mojikumi-line-end">，</span>但没有使用
<code>enter</code> 指令<span class="mojikumi-line-end">，</span>简单来说是历史以及性能原因<span class="mojikumi-line-end">，</span>可以参考 <a href="https://stackoverflow.com/questions/5959890/enter-vs-push-ebp-mov-ebp-esp-sub-esp-imm-and-leave-vs-mov-esp-ebp">assembly - "enter" vs
"push ebp; mov ebp, esp; sub esp, imm" and "leave" vs "mov esp, ebp; pop
ebp" - Stack
Overflow</a><span class="mojikumi-line-end">。</span></p></div></div></aside>
<p>除了使用 <code>%rbp</code> 作为 frame pointer<span class="mojikumi-line-end">，</span>为非确定大小的数组分配栈空间还涉及到 <a href="#data-alignment">data alignment</a> 的问题<span class="mojikumi-line-end">，</span>可以参考 CS:APP Practice Problem 3.49<span class="mojikumi-line-end">。</span></p>
<h3 id="stack-frame-alignment" class="heading"><a href="#stack-frame-alignment" class="heading-anchor" aria-label="章节： Stack Frame Alignment" tabindex="-1"></a><span>Stack Frame Alignment</span></h3>
<p>x86-64 中要求 stack frame 以 16 byte 对齐<span class="mojikumi-line-end">。</span>具体来说<span class="mojikumi-line-end">，</span>就是执行 <code>call</code> 之前 <code>%rsp</code> 的值必须是 16 的倍数<span class="mojikumi-line-end">，</span>而在进入一个 procedure 时 <code>%rsp</code> 的值就模 16 余 8<span class="mojikumi-line-end">。</span></p>
<p>为了满足这一对齐要求<span class="mojikumi-line-end">，</span>有时会在 <code>call</code> 之前先 <code>subq $8, %rsp</code><span class="mojikumi-line-end">，</span><code>call</code> 之后再 <code>addq $8, %rsp</code><span class="mojikumi-line-end">。</span></p>
<h2 id="array-allocation-and-access" class="heading"><a href="#array-allocation-and-access" class="heading-anchor" aria-label="章节： Array Allocation and Access" tabindex="-1"></a><span>Array Allocation and Access</span></h2>
<p>简单来说<span class="mojikumi-line-end">，</span><code>Imm(rb, ri, s)</code> 的 operand 格式使得数组访问变得容易<span class="mojikumi-line-end">。</span></p>
<p>而编译器会做很多优化<span class="mojikumi-line-end">，</span>例如用指针加法代替每次都算一遍乘法<span class="mojikumi-line-end">。</span></p>
<h2 id="heterogeneous-data-structures" class="heading"><a href="#heterogeneous-data-structures" class="heading-anchor" aria-label="章节： Heterogeneous Data Structures" tabindex="-1"></a><span>Heterogeneous Data Structures</span></h2>
<h3 id="struct" class="heading"><a href="#struct" class="heading-anchor" aria-label="章节： Struct" tabindex="-1"></a><span>Struct</span></h3>
<p>结构体也是内存中连续的一段<span class="mojikumi-line-end">，</span>会在编译时在结构体地址的基础上加上相应的 offset 来访问各个 field<span class="mojikumi-line-end">。</span></p>
<h3 id="union" class="heading"><a href="#union" class="heading-anchor" aria-label="章节： Union" tabindex="-1"></a><span>Union</span></h3>
<p>union 的大小是最大的 field 的大小<span class="mojikumi-line-end">，</span>每个 field 的 offset 都是 0<span class="mojikumi-line-end">。</span></p>
<p>在使用 union 时<span class="mojikumi-line-end">，</span>byte ordering 可能非常重要<span class="mojikumi-line-end">。</span></p>
<h3 id="data-alignment" class="heading"><a href="#data-alignment" class="heading-anchor" aria-label="章节： Data Alignment" tabindex="-1"></a><span>Data Alignment</span></h3>
<p>在 x86-64 中<span class="mojikumi-line-end">，</span>进行 data alignment 可以提升程序效率<span class="mojikumi-line-end">。</span>具体要求为<span class="mojikumi-line-end">，</span>任何<span class="mojikumi-line-start">（</span>主要是结构体内的<span class="mojikumi-line-end">）</span>primitive type 的地址需要是其长度的倍数<span class="mojikumi-line-end">。</span></p>
<p>为了满足 alignment 要求<span class="mojikumi-line-end">，</span>可能需要<span class="mojikumi-line-end">：</span></p>
<ol>
<li>在结构体的不同 field 之间添加 padding</li>
<li>保证结构体自身的地址是其自身 alignment 的倍数</li>
<li>在结构体末尾添加 padding<span class="mojikumi-line-end">，</span>例如在数组中需要保证下一个元素的起始地址为其 alignment 的倍数</li>
</ol>
<p>汇编代码中会使用 <code>.align</code> directive 来指定 data alignment<span class="mojikumi-line-end">。</span></p>
<h2 id="thwarting-buffer-overflow-attacks" class="heading"><a href="#thwarting-buffer-overflow-attacks" class="heading-anchor" aria-label="章节： Thwarting Buffer Overflow Attacks" tabindex="-1"></a><span>Thwarting Buffer Overflow Attacks</span></h2>
<p>了解了 stack 的构造<span class="mojikumi-line-end">，</span>就能更加明白数组越界的危害<span class="mojikumi-line-end">：</span>可以修改 stack 上包括 caller address 在内的数据<span class="mojikumi-line-end">，</span>导致程序出错或跳转到错误的位置<span class="mojikumi-line-end">，</span>而攻击者可以利用这一漏洞跳转到设计好的位置以执行攻击代码<span class="mojikumi-line-end">。</span></p>
<p>下面是一些无需修改程序代码就能做到的降低 buffer overflow 危害的方法<span class="mojikumi-line-end">，</span>当然<span class="mojikumi-line-end">，</span>这些方法也不是万能或总是有效的<span class="mojikumi-line-end">。</span></p>
<h3 id="stack-randomization" class="heading"><a href="#stack-randomization" class="heading-anchor" aria-label="章节： Stack Randomization" tabindex="-1"></a><span>Stack Randomization</span></h3>
<p>可以修改 stack 的起始地址<span class="mojikumi-line-end">，</span>以降低指令地址的可预测性<span class="mojikumi-line-end">，</span>增大攻击难度<span class="mojikumi-line-end">。</span>这在 Linux 中已经是标准做法了<span class="mojikumi-line-end">，</span>是 address-space layout randomization (ASLR) 的一部分<span class="mojikumi-line-end">。</span></p>
<p>攻击者可以通过 <span class="mojikumi">“</span>nop sled<span class="mojikumi">”</span><span class="mojikumi-line-end">，</span>即通过大量 <code>nop</code> 指令来增长攻击代码的长度<span class="mojikumi-line-end">，</span>来降低猜测指令地址的难度<span class="mojikumi-line-end">。</span></p>
<h3 id="stack-corruption-detection" class="heading"><a href="#stack-corruption-detection" class="heading-anchor" aria-label="章节： Stack Corruption Detection" tabindex="-1"></a><span>Stack Corruption Detection</span></h3>
<p>gcc 使用 <i>stack protector</i> 来检测 stack corruption<span class="mojikumi-line-end">，</span>以避免 corrupted stack 造成的危害<span class="mojikumi-line-end">。</span></p>
<p>简单来说<span class="mojikumi-line-end">，</span>使用 stack protector 时<span class="mojikumi-line-end">，</span>会在 stack frame 中插入一个运行时随机生成的 <i>canary value</i> (<i>guard value</i>) <span class="mojikumi-line-end">，</span>并在 <code>ret</code> 前检查这个值是否被修改<span class="mojikumi-line-end">。</span></p>
<h3 id="limiting-executable-code-regions" class="heading"><a href="#limiting-executable-code-regions" class="heading-anchor" aria-label="章节： Limiting Executable Code Regions" tabindex="-1"></a><span>Limiting Executable Code Regions</span></h3>
<p>可以限制能够被执行的 memory region<span class="mojikumi-line-end">，</span>以避免攻击者执行位于 stack 中的<span class="mojikumi-line-end">、</span>由攻击者注入的指令<span class="mojikumi-line-end">。</span></p>
<p>但是<span class="mojikumi-line-end">，</span>有的语言<span class="mojikumi-line-start">（</span>例如 Java<span class="mojikumi-line-end">）</span>可能需要能够执行动态生成的指令<span class="mojikumi-line-end">，</span>这样的话就不能禁止执行 stack 中的指令<span class="mojikumi-line-end">。</span></p>
<h2 id="floating-point-code" class="heading"><a href="#floating-point-code" class="heading-anchor" aria-label="章节： Floating-Point Code" tabindex="-1"></a><span>Floating-Point Code</span></h2>
<p>这部分内容基于 AVX2 指令集<span class="mojikumi-line-end">，</span>可以指定 <code>-mavx2</code> 选项来让编译器使用 AVX2 指令<span class="mojikumi-line-end">。</span></p>
<p>如果不支持 AVX<span class="mojikumi-line-end">，</span>则可以使用 SSE 指令集<span class="mojikumi-line-end">，</span>大体上是类似的<span class="mojikumi-line-end">。</span>简单来说<span class="mojikumi-line-end">，</span>主要的区别就是 AVX 指令的名称会有一个 <code>v</code> 的前缀<span class="mojikumi-line-end">，</span>而很多 AVX 中三个 operand 的指令在 SSE 中是两个 operand<span class="mojikumi-line-end">。</span></p>
<h3 id="ymm-寄存器" class="heading"><a href="#ymm-寄存器" class="heading-anchor" aria-label="章节： YMM 寄存器" tabindex="-1"></a><span>YMM 寄存器</span></h3>
<p>浮点数存放在 16 个 YMM registers 中<span class="mojikumi-line-end">，</span>每个寄存器有 256 bits<span class="mojikumi-line-end">，</span>叫做 <code>%ymm0-15</code><span class="mojikumi-line-end">，</span>而低位 128 bits 叫做 <code>%xmm0-15</code><span class="mojikumi-line-end">。</span></p>
<p>这些寄存器可以存多个浮点数 (packed data) 并对它们同时进行操作以加速计算<span class="mojikumi-line-end">；</span>而如果只对单个浮点数 (scalar) 进行操作<span class="mojikumi-line-end">，</span>就只涉及到 <code>%xmm0-15</code> 的低位<span class="mojikumi-line-end">。</span></p>
<h3 id="浮点数的移动指令" class="heading"><a href="#浮点数的移动指令" class="heading-anchor" aria-label="章节： 浮点数的移动指令" tabindex="-1"></a><span>浮点数的移动指令</span></h3>
<p>下面的指令都没有列全可能的 operand 类型<span class="mojikumi-line-end">，</span>仅列出 CS:APP 里讲到的常用的<span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>vmovss m32, xmm</code></li>
<li><code>vmovss xmm, m32</code></li>
<li><code>vmovsd m64, xmm</code></li>
<li><code>vmovsd xmm, m64</code></li>
<li><code>vmovaps xmm, xmm</code></li>
<li><code>vmovapd xmm, xmm</code></li>
</ul>
<p>其中 <code>v</code> 是 AVX 指令的前缀<span class="mojikumi-line-end">，</span><code>ss</code> 表示 scalar single-precision<span class="mojikumi-line-end">，</span><code>sd</code> 表示 scalar double-precision<span class="mojikumi-line-end">，</span><code>a</code> 表示 aligned<span class="mojikumi-line-end">，</span><code>ps</code> 表示 packed single-precision<span class="mojikumi-line-end">，</span><code>pd</code> 表示 packed double-precision<span class="mojikumi-line-end">。</span>也就是说<span class="mojikumi-line-end">，</span><code>s</code> 结尾的用于 float<span class="mojikumi-line-end">，</span><code>d</code> 结尾的用于 double<span class="mojikumi-line-end">。</span></p>
<h3 id="浮点数类型转换" class="heading"><a href="#浮点数类型转换" class="heading-anchor" aria-label="章节： 浮点数类型转换" tabindex="-1"></a><span>浮点数类型转换</span></h3>
<h4 id="浮点数转为整数" class="heading"><a href="#浮点数转为整数" class="heading-anchor" aria-label="章节： 浮点数转为整数" tabindex="-1"></a><span>浮点数转为整数</span></h4>
<ul>
<li><code>vcvttss2si xmm/m32, r32</code></li>
<li><code>vcvttsd2si xmm/m64, r32</code></li>
<li><code>vcvttss2siq<wbr> <wbr>xmm<wbr>/<wbr>m32<wbr>, <wbr>r64</code></li>
<li><code>vcvttsd2siq<wbr> <wbr>xmm<wbr>/<wbr>m64<wbr>, <wbr>r64</code></li>
</ul>
<p>其中 <code>cvttss2si</code> 的意思是: <code>cvt</code> -&gt; convert, <code>t</code> -&gt; (with) truncation, <code>ss</code> -&gt; scalar single-precision, <code>2</code> -&gt; to, <code>si</code> -&gt; signed integer<span class="mojikumi-line-end">。</span></p>
<p><code>ss</code> 用于 float<span class="mojikumi-line-end">，</span><code>sd</code> 用于 double<span class="mojikumi-line-end">；</span>结尾为 <code>q</code> 的用来转成 64 位整数<span class="mojikumi-line-end">。</span></p>
<h4 id="整数转为浮点数" class="heading"><a href="#整数转为浮点数" class="heading-anchor" aria-label="章节： 整数转为浮点数" tabindex="-1"></a><span>整数转为浮点数</span></h4>
<ul>
<li><code>vcvtsi2ss r/m32, xmm, xmm</code></li>
<li><code>vcvtsi2sd r/m32, xmm, xmm</code></li>
<li><code>vcvtsi2ssq r/m64, xmm, xmm</code></li>
<li><code>vcvtsi2sdq r/m64, xmm, xmm</code></li>
</ul>
<p>这里 <code>cvt</code> 后少了一个 <code>t</code> 是因为整数转为浮点数不会 truncate<span class="mojikumi-line-end">。</span></p>
<p>效果是把第一个 operand 转换后放在第三个 operand 处<span class="mojikumi-line-end">，</span>而第二个 operand 一般不用管<span class="mojikumi-line-end">，</span>设为和第三个 operand 一样即可<span class="mojikumi">。</span><wbr><span class="mojikumi-line-start">（</span>转换结果会放在 destination 的低位<span class="mojikumi-line-end">，</span>而第二个 operand 用来设置 destination 的高位<span class="mojikumi">。</span><span class="mojikumi-line-end">）</span></p>
<h4 id="浮点数精度转换" class="heading"><a href="#浮点数精度转换" class="heading-anchor" aria-label="章节： 浮点数精度转换" tabindex="-1"></a><span>浮点数精度转换</span></h4>
<ul>
<li><code>vcvtss2sd xmm, xmm, xmm</code></li>
<li><code>vcvtsd2ss xmm, xmm, xmm</code></li>
</ul>
<p>operand 的作用和上面整数转为浮点数的指令一样<span class="mojikumi-line-end">。</span></p>
<a id="gcc-使用的浮点数精度转换指令" name="gcc-使用的浮点数精度转换指令" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-blue-1 dark:bg-blue-9 b-blue" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h5 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-pencil text-blue" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Note: </span><span data-v-a2ab257f="">gcc 使用的浮点数精度转换指令</span></h5><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p>在某些版本的 gcc 中<span class="mojikumi-line-end">，</span>或针对某些处理器架构进行优化时<span class="mojikumi-line-end">，</span>gcc
可能会使用另外的指令来进行浮点数精度转换<span class="mojikumi-line-end">。</span>详见
<a href="/post/2022/10/gcc-use_vector_fp_converts">另一篇博客</a><span class="mojikumi-line-end">。</span></p></div></div></aside>
<h3 id="函数调用中的浮点数" class="heading"><a href="#函数调用中的浮点数" class="heading-anchor" aria-label="章节： 函数调用中的浮点数" tabindex="-1"></a><span>函数调用中的浮点数</span></h3>
<ul>
<li>前 7 个浮点参数可以存在 <code>%xmm0-7</code> 中<span class="mojikumi-line-end">，</span>其余参数存在 stack 里<span class="mojikumi-line-end">。</span></li>
<li>浮点函数返回值存在 <code>%xmm0</code> 中<span class="mojikumi-line-end">。</span></li>
<li>没有 callee-saved 寄存器<span class="mojikumi-line-start">（</span>所有寄存器都是 caller-saved<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></li>
</ul>
<p>看参数是第几个<span class="mojikumi-line-end">、</span>放在哪个寄存器时<span class="mojikumi-line-end">，</span>浮点参数和整型参数是分开算的<span class="mojikumi-line-end">，</span>例如 <code>double f1(int x, double y, long z)</code> 和 <code>double f2(double y, int x, long z)</code> 的参数寄存器分配是相同的<span class="mojikumi-line-end">。</span></p>
<h3 id="浮点数算术运算" class="heading"><a href="#浮点数算术运算" class="heading-anchor" aria-label="章节： 浮点数算术运算" tabindex="-1"></a><span>浮点数算术运算</span></h3>
<p>下面的指令把 <code>ss</code> 换成 <code>sd</code><span class="mojikumi-line-end">、</span><code>m32</code> 换成 <code>m64</code> 即为 double-precision 的版本<span class="mojikumi-line-end">。</span></p>
<h4 id="浮点数二元运算" class="heading"><a href="#浮点数二元运算" class="heading-anchor" aria-label="章节： 浮点数二元运算" tabindex="-1"></a><span>浮点数二元运算</span></h4>
<p>记三个 operand 分别为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>S</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>D</mi></mrow><annotation encoding="application/x-tex">S_1, S_2, D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="mojikumi-line-end">，</span>则效果为计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">S_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">S_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 的运算结果<span class="mojikumi-line-end">，</span>存在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span></span> 中<span class="mojikumi-line-end">，</span>例如 <code>vsubss S_1 S_2 D</code> 是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>←</mo><msub><mi>S</mi><mn>2</mn></msub><mo>−</mo><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">D \gets S_2 - S_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>vaddss xmm/m32, xmm, xmm</code></li>
<li><code>vsubss xmm/m32, xmm, xmm</code></li>
<li><code>vmulss xmm/m32, xmm, xmm</code></li>
<li><code>vdivss xmm/m32, xmm, xmm</code></li>
<li><code>vmaxss xmm/m32, xmm, xmm</code></li>
<li><code>vminss xmm/m32, xmm, xmm</code></li>
</ul>
<h4 id="浮点数一元运算" class="heading"><a href="#浮点数一元运算" class="heading-anchor" aria-label="章节： 浮点数一元运算" tabindex="-1"></a><span>浮点数一元运算</span></h4>
<p><code>sqrtss xmm/m32, xmm</code>: 将 source 开方存入 destination</p>
<p>这里 CS:APP 中列出的是 SSE 指令 <code>sqrtss</code> 而非 AVX 指令 <code>vsqrtss</code><span class="mojikumi-line-end">，</span>我自己编译出来也是<span class="mojikumi-line-end">。</span>可能可以参考 <a href="https://stackoverflow.com/questions/8924729/using-avx-intrinsics-instead-of-sse-does-not-improve-speed-why">c++ - Using AVX intrinsics instead of SSE does not improve speed -- why? - Stack Overflow</a><span class="mojikumi-line-end">。</span></p>
<h3 id="浮点数常量" class="heading"><a href="#浮点数常量" class="heading-anchor" aria-label="章节： 浮点数常量" tabindex="-1"></a><span>浮点数常量</span></h3>
<p>浮点数相关的指令不接受 immediate value 作为 operand<span class="mojikumi-line-end">，</span>所以使用常量时需要先存下来<span class="mojikumi-line-end">，</span>例如<span class="mojikumi-line-end">：</span></p>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h4 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="C 代码块" data-v-ad49d235="">C</h4><ile-root id="ile-14"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-14",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #C792EA">double</span><span style="color: #D6DEEB"> </span><span style="color: #82AAFF">foo</span><span style="color: #D6DEEB">() { </span><span style="color: #C792EA">return</span><span style="color: #D6DEEB"> </span><span style="color: #F78C6C">1.8</span><span style="color: #D6DEEB">; }</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #994CC3">double</span><span style="color: #403F53"> </span><span style="color: #4876D6">foo</span><span style="color: #403F53">() { </span><span style="color: #994CC3">return</span><span style="color: #403F53"> </span><span style="color: #AA0982">1.8</span><span style="color: #403F53">; }</span></span></code></pre></div></section>
<section class="code-block relative my-6 shadow" itemprop="hasPart" itemscope="" itemtype="https://schema.org/SoftwareSourceCode" data-v-ad49d235=""><div class="h-6 items-center rd-t-1 bg-area px-4 dark:bg-#2A313A media-screen:important-flex" style="display:none;" data-v-ad49d235=""><h4 class="text-3 text-footer" itemprop="programmingLanguage" aria-label="Assembly 代码块" data-v-ad49d235="">Assembly</h4><ile-root id="ile-15"><button title="复制到剪贴板" class="copy-button b-footer text-footer" data-v-9288569d=""><span class="i-mdi-content-copy" data-v-9288569d=""></span><span class="sr-only" role="status" data-v-9288569d=""></span></button></ile-root><script></script><script type="module" async="">var s=(i,a)=>()=>(a||i((a={exports:{}}).exports,a),a.exports);var r=(i,a,o)=>new Promise((c,n)=>{var f=t=>{try{_(o.next(t))}catch(e){n(e)}},l=t=>{try{_(o.throw(t))}catch(e){n(e)}},_=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);_((o=o.apply(i,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{b as p}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=s(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(i=>i.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/CopyButton.f3d773d6.js"),["assets/CopyButton.f3d773d6.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});p(u,v,"ile-15",{},{})});export default E();
</script></div><div class="light:hidden" itemprop="text" data-v-ad49d235=""><pre class="shiki dark" style="background-color: #011627" tabindex="0"><code><span><span style="color: #82AAFF">foo:</span></span>
<span><span style="color: #D6DEEB">	</span><span style="color: #7FDBCA">vmovsd</span><span style="color: #D6DEEB">	.LC0(%</span><span style="color: #82AAFF">rip</span><span style="color: #D6DEEB">), %</span><span style="color: #82AAFF">xmm0</span></span>
<span><span style="color: #D6DEEB">	</span><span style="color: #7FDBCA">ret</span></span>
<span><span style="color: #C792EA">.</span><span style="color: #82AAFF">LC0:</span></span>
<span><span style="color: #D6DEEB">	.long	-</span><span style="color: #F78C6C">858993459</span></span>
<span><span style="color: #D6DEEB">	.long	</span><span style="color: #F78C6C">1073532108</span></span></code></pre></div><div class="light:important-block" style="display:none;" data-v-ad49d235=""><pre class="shiki light" style="background-color: #FBFBFB" tabindex="0"><code><span><span style="color: #4876D6">foo:</span></span>
<span><span style="color: #403F53">	</span><span style="color: #0C969B">vmovsd</span><span style="color: #403F53">	.LC0(%</span><span style="color: #4876D6">rip</span><span style="color: #403F53">), %</span><span style="color: #4876D6">xmm0</span></span>
<span><span style="color: #403F53">	</span><span style="color: #0C969B">ret</span></span>
<span><span style="color: #994CC3">.</span><span style="color: #4876D6">LC0:</span></span>
<span><span style="color: #403F53">	.long	-</span><span style="color: #AA0982">858993459</span></span>
<span><span style="color: #403F53">	.long	</span><span style="color: #AA0982">1073532108</span></span></code></pre></div></section>
<h3 id="浮点数位运算" class="heading"><a href="#浮点数位运算" class="heading-anchor" aria-label="章节： 浮点数位运算" tabindex="-1"></a><span>浮点数位运算</span></h3>
<p>位运算都是在整个寄存器上对 packed data 进行的<span class="mojikumi-line-end">。</span></p>
<ul>
<li><code>vxorps xmm/m128, xmm, xmm</code></li>
<li><code>vxorpd xmm/m128, xmm, xmm</code></li>
<li><code>vandps xmm/m128, xmm, xmm</code></li>
<li><code>vandpd xmm/m128, xmm, xmm</code></li>
</ul>
<p>operands 格式和上面一样<span class="mojikumi-line-end">。</span></p>
<p>一些浮点数位运算的实际运用<span class="mojikumi-line-end">：</span></p>
<ul>
<li>用 and 运算将 sign bit 置零<span class="mojikumi-line-end">，</span>以取绝对值</li>
<li>用 xor 运算将 sign bit 取反<span class="mojikumi-line-end">，</span>以取相反数</li>
<li>将 xor 的两个 source 设为同一个寄存器以得到 0</li>
</ul>
<a id="packed-singledouble-precision-在移动和位运算上的区别？" name="packed-singledouble-precision-在移动和位运算上的区别？" aria-hidden="true"></a>
<aside role="note" data-v-a2ab257f=""><div class="shadow-md rd-1 b-l-6 my-6 bg-purple-2 dark:bg-purple-9 b-purple-5" data-v-a2ab257f=""><div class="p-3 flex justify-between items-center" data-v-a2ab257f=""><h4 class="flex items-center gap-1 font-bold" data-v-a2ab257f=""><span class="text-5 i-mdi-help-circle-outline text-purple" data-v-a2ab257f=""></span><span class="sr-only" data-v-a2ab257f="">Question: </span><span data-v-a2ab257f="">packed single/double precision 在移动和位运算上的区别？</span></h4><!--v-if--></div><div class="overflow-auto rd-br-1 bg-card px-6 dark:bg-bghover" data-v-a2ab257f=""><p><code>vmovaps</code> 和 <code>vmovapd</code><span class="mojikumi-line-end">、</span><code>vxorps</code> 和 <code>vxorpd</code><span class="mojikumi-line-end">、</span><code>vandps</code> 和 <code>vandpd</code>
看起来效果是一样的<span class="mojikumi-line-end">，</span>为什么要给 single/double precision 分别一条指令呢 🤔</p></div></div></aside>
<h3 id="浮点数比较" class="heading"><a href="#浮点数比较" class="heading-anchor" aria-label="章节： 浮点数比较" tabindex="-1"></a><span>浮点数比较</span></h3>
<ul>
<li><code>vucomiss xmm/m32, xmm</code></li>
<li><code>vucomisd xmm/m64, xmm</code></li>
</ul>
<p>效果为<span class="mojikumi-line-end">，</span>计算第二个 operand 减去第一个 operand 并设置 status flags<span class="mojikumi-line-end">。</span></p>
<p>浮点数的比较是 <span class="mojikumi">“</span>unordered<span class="mojikumi">”</span> 的<span class="mojikumi-line-end">，</span>即若某个 operand 是 NaN<span class="mojikumi-line-end">，</span>则比较结果为 unordered<span class="mojikumi-line-end">。</span></p>
<p>不同的比较结果对应的 status flags 以及 condition code 为<span class="mojikumi-line-end">：</span></p>
<div class="overflow-auto my-6"><table>
<thead>
<tr>
<th align="center">比较结果</th>
<th align="center">CF</th>
<th align="center">ZF</th>
<th align="center">PF</th>
<th align="center">condition code</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">unordered</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center"><code>p</code></td>
</tr>
<tr>
<td align="center"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>2</mn></msub><mo>&lt;</mo><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">S_2 &lt; S_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center"><code>b</code></td>
</tr>
<tr>
<td align="center"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>2</mn></msub><mo>=</mo><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">S_2 = S_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center"><code>e</code></td>
</tr>
<tr>
<td align="center"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>2</mn></msub><mo>&gt;</mo><msub><mi>S</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">S_2 &gt; S_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center"><code>a</code></td>
</tr>
</tbody>
</table></div>
<p>其中 PF 在浮点数比较中用来表示 unordered<span class="mojikumi-line-end">，</span>在整数计算中也会被设置但几乎没用<span class="mojikumi-line-end">。</span></p></section><div class="article-style my-9"><hr></div><footer><div class="my-6 b-l-6 b-gray-4 bg-area p-6 shadow dark:b-gray-11" itemprop="copyrightNotice"><ul class="flex flex-col gap-1"><li class="flex gap-1"><span class="shrink-0">文章作者:</span><a href="https://github.com/ouuan" rel="author">ouuan</a></li><li class="flex gap-1"><span class="shrink-0">原文链接:</span><a href="https://ouuan.moe/post/2022/09/csapp-3" rel="canonical" class="break-all">https://ouuan.moe/post/2022/09/csapp-3</a></li><li class="flex gap-1"><span class="shrink-0">许可协议:</span><span> 本文采用 <span class="article-style"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.zh" class="font-sans" itemprop="license">CC BY-SA 4.0</a></span> 许可协议进行授权，未满足 <span class="underline decoration-dotted" title="简而言之，转载时必须标明出处（本文的链接），标明是转载而非原创，标明作了哪些修改，并使用相同的许可协议，但无需私信征求许可">许可协议要求</span> 不得转载。 </span></li></ul></div></footer></article><div class="my-6 print:hidden" itemprop="comment" itemscope="" itemtype="https://schema.org/Comment"><ile-root id="ile-16"></ile-root><script></script><script type="module" async="">import{h as r,c as m}from"/assets/iles.0aa4bab4.js";import{_ as o}from"/assets/GiscusCommentsInner.ce9f27a5.js";import"/assets/vendor-vue.8e27fa9d.js";import"/assets/vite.5ce4fca4.js";import"/assets/useTheme.060d9991.js";import"/assets/site.0440d0dc.js";r(m,o,"ile-16",{term:"CS:APP 第三章学习笔记"},{});
</script></div><nav class="my-6 flex justify-between gap-6 print:hidden lg:text-justify"><div class="flex flex-1"><a class="flex items-center gap-1 hover:text-hover" href="/post/2022/09/csapp-2"><span class="i-mdi-chevron-left"></span><span class="sr-only">上一篇</span><span class="break-anywhere">CS:APP 第二章学习笔记</span></a></div><div class="flex flex-1 justify-end"><a class="flex flex-row-reverse items-center gap-1 hover:text-hover" href="/post/2022/10/csapp-4"><span class="i-mdi-chevron-right"></span><span class="sr-only">下一篇</span><span class="break-anywhere">CS:APP 第四章学习笔记</span></a></div></nav></div><ile-root id="ile-17"><div class="flex print:hidden"><aside style="max-height:calc(100vh - 10rem);" id="__toc" class="sticky top-16 m-4 hidden w-72 rd-2 bg-card py-6 shadow xl:block 2xl:w-84 3xl:w-96" aria-label="文章目录" itemprop="hasPart" itemscope="" itemtype="https://schema.org/WPSideBar"><div class="mb-3 flex flex-wrap items-center justify-between gap-2 pl-8 pr-4"><div class="flex items-center"><h2 class="text-xl font-bold"> 文章目录 </h2><button id="__toc-close" class="flex items-center px-1 text-xl" title="关闭目录" aria-controls="__toc" aria-expanded="true"><span class="i-mdi-close"></span></button></div><div><label class="ml-auto flex items-center gap-1"><span>展开全部</span><input type="checkbox"></label></div></div><div style="max-height:calc(100% - 2rem);" class="overflow-auto overscroll-contain pl-8 pr-4"><ol data-v-c5806953=""><li id="__toc-item-program-encodings" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#program-encodings" data-v-c5806953=""><span data-v-c5806953="">Program Encodings</span></a></li><li id="__toc-item-data-formats" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#data-formats" data-v-c5806953=""><span data-v-c5806953="">Data Formats</span></a></li><li id="__toc-item-accessing-information" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#accessing-information" data-v-c5806953=""><span data-v-c5806953="">Accessing Information</span></a></li><li id="__toc-item-arithmetic-and-logical-operations" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#arithmetic-and-logical-operations" data-v-c5806953=""><span data-v-c5806953="">Arithmetic and Logical Operations</span></a></li><li id="__toc-item-control" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#control" data-v-c5806953=""><span data-v-c5806953="">Control</span></a></li><li id="__toc-item-procedures" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#procedures" data-v-c5806953=""><span data-v-c5806953="">Procedures</span></a></li><li id="__toc-item-array-allocation-and-access" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#array-allocation-and-access" data-v-c5806953=""><span data-v-c5806953="">Array Allocation and Access</span></a></li><li id="__toc-item-heterogeneous-data-structures" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#heterogeneous-data-structures" data-v-c5806953=""><span data-v-c5806953="">Heterogeneous Data Structures</span></a></li><li id="__toc-item-thwarting-buffer-overflow-attacks" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#thwarting-buffer-overflow-attacks" data-v-c5806953=""><span data-v-c5806953="">Thwarting Buffer Overflow Attacks</span></a></li><li id="__toc-item-floating-point-code" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#floating-point-code" data-v-c5806953=""><span data-v-c5806953="">Floating-Point Code</span></a></li></ol></div></aside><button style="display:none;" id="__toc-open" title="显示文章目录" class="bottom-24 text-lg floating-button" aria-haspopup="dialog" aria-controls="__toc" aria-expanded="true"><span class="i-mdi-menu"></span></button></div></ile-root><script></script><script type="module" async="">import{h as T,c as P}from"/assets/iles.0aa4bab4.js";import{_ as V}from"/assets/TableOfContents.0efa4f7e.js";import"/assets/vendor-vue.8e27fa9d.js";import"/assets/vite.5ce4fca4.js";T(P,V,"ile-17",function(e,l,t,s,u,i,o,g,v,r,c,n,a,m,p,d,f,C,E,k,F,h,w,A,M,S,q,y,O,j,z){return{headings:[{level:s,title:"Program Encodings",slug:"program-encodings"},{level:e,title:"汇编/机器码中的程序状态",slug:"汇编机器码中的程序状态"},{level:e,title:"将 C 代码编译为汇编代码",slug:"将-c-代码编译为汇编代码"},{level:e,title:u,slug:u},{level:l,title:"指令集的 reference；ATT 格式 vs Intel 格式",slug:"指令集的-reference；att-格式-vs-intel-格式"},{level:s,title:"Data Formats",slug:"data-formats"},{level:s,title:"Accessing Information",slug:"accessing-information"},{level:e,title:i,slug:i},{level:e,title:"Operand 格式",slug:"operand-格式"},{level:e,title:"move 类指令",slug:"move-类指令"},{level:t,title:"MOV 指令",slug:"mov-指令"},{level:t,title:"MOVZ 指令",slug:"movz-指令"},{level:l,title:"没用的 <code>movzbq</code> 和 <code>movzwq</code> 🤔？",slug:"没用的-movzbq-和-movzwq-？"},{level:t,title:"MOVS 指令",slug:"movs-指令"},{level:e,title:"push/pop stack",slug:"pushpop-stack"},{level:l,title:"为什么 top 位于低地址？",slug:"为什么-top-位于低地址？"},{level:l,title:"<code>pushq</code>/<code>popq</code> vs 直接修改 <code>%rsp</code>",slug:"pushqpopq-vs-直接修改-rsp"},{level:s,title:"Arithmetic and Logical Operations",slug:"arithmetic-and-logical-operations"},{level:e,title:"Load Effective Address",slug:"load-effective-address"},{level:e,title:o,slug:o},{level:e,title:g,slug:g},{level:e,title:v,slug:v},{level:l,title:r,slug:r},{level:e,title:"结果是 operand 两倍长度的运算",slug:"结果是-operand-两倍长度的运算"},{level:s,title:"Control",slug:"control"},{level:l,title:'<span class="mojikumi">“</span>status flag<span class="mojikumi">”</span> vs <span class="mojikumi">“</span>condition code<span class="mojikumi">”</span>',slug:"“status-flag”-vs-“condition-code”"},{level:e,title:"Status Flags",slug:"status-flags"},{level:l,title:"ARM 中的 carry flag —— carry flag vs borrow flag",slug:"arm-中的-carry-flag------carry-flag-vs-borrow-flag"},{level:e,title:"Condition Codes",slug:"condition-codes"},{level:e,title:"CMP 和 TEST 指令",slug:"cmp-和-test-指令"},{level:l,title:"CMP 的比较顺序",slug:"cmp-的比较顺序"},{level:e,title:"SETcc 指令",slug:"setcc-指令"},{level:e,title:"Jump 类指令",slug:"jump-类指令"},{level:t,title:"Label",slug:"label"},{level:t,title:c,slug:c},{level:t,title:n,slug:n},{level:t,title:"rep; ret",slug:"rep-ret"},{level:t,title:"jump 指令编码",slug:"jump-指令编码"},{level:e,title:"CMOVcc 指令",slug:"cmovcc-指令"},{level:e,title:"实现 if-else 语句",slug:"实现-if-else-语句"},{level:e,title:a,slug:a},{level:e,title:"实现 switch 语句",slug:"实现-switch-语句"},{level:s,title:"Procedures",slug:"procedures"},{level:e,title:m,slug:m},{level:l,title:"存放 caller 地址的原则",slug:"存放-caller-地址的原则"},{level:e,title:p,slug:p},{level:l,title:d,slug:d},{level:e,title:f,slug:f},{level:l,title:C,slug:C},{level:e,title:E,slug:E},{level:l,title:"callee-saved registers 的使用原则",slug:"callee-saved-registers-的使用原则"},{level:e,title:"可变大小的 stack frame",slug:"可变大小的-stack-frame"},{level:l,title:"stack frame pointer 的原则",slug:"stack-frame-pointer-的原则"},{level:l,title:"<code>leave</code> vs <code>enter</code>",slug:"leave-vs-enter"},{level:e,title:"Stack Frame Alignment",slug:"stack-frame-alignment"},{level:s,title:"Array Allocation and Access",slug:"array-allocation-and-access"},{level:s,title:"Heterogeneous Data Structures",slug:"heterogeneous-data-structures"},{level:e,title:"Struct",slug:"struct"},{level:e,title:"Union",slug:"union"},{level:e,title:"Data Alignment",slug:"data-alignment"},{level:s,title:"Thwarting Buffer Overflow Attacks",slug:"thwarting-buffer-overflow-attacks"},{level:e,title:"Stack Randomization",slug:"stack-randomization"},{level:e,title:"Stack Corruption Detection",slug:"stack-corruption-detection"},{level:e,title:"Limiting Executable Code Regions",slug:"limiting-executable-code-regions"},{level:s,title:"Floating-Point Code",slug:"floating-point-code"},{level:e,title:"YMM 寄存器",slug:"ymm-寄存器"},{level:e,title:k,slug:k},{level:e,title:F,slug:F},{level:t,title:h,slug:h},{level:t,title:w,slug:w},{level:t,title:A,slug:A},{level:l,title:"gcc 使用的浮点数精度转换指令",slug:"gcc-使用的浮点数精度转换指令"},{level:e,title:M,slug:M},{level:e,title:S,slug:S},{level:t,title:q,slug:q},{level:t,title:y,slug:y},{level:e,title:O,slug:O},{level:e,title:j,slug:j},{level:l,title:"packed single/double precision 在移动和位运算上的区别？",slug:"packed-singledouble-precision-在移动和位运算上的区别？"},{level:e,title:z,slug:z}]}}(3,6,4,2,"反汇编与机器码","寄存器","一元运算","二元运算","位移","对过大位移位数的处理","无条件跳转","条件跳转","实现循环语句","转移控制权","传递参数","存放参数的原则","传递返回值","存放返回值的原则","存储局部变量","浮点数的移动指令","浮点数类型转换","浮点数转为整数","整数转为浮点数","浮点数精度转换","函数调用中的浮点数","浮点数算术运算","浮点数二元运算","浮点数一元运算","浮点数常量","浮点数位运算","浮点数比较"),{});
</script></div></main><footer class="flex flex-col gap-1 bg-card p-6 text-footer" itemprop="hasPart" itemscope="" itemtype="https://schema.org/WPFooter"><div class="flex flex-wrap items-center justify-center gap-x-1"><span>Copyright ©</span><span>2022 - 2023</span><a class="flex items-center" href="/sponsor" title="赞赏支持"><span class="i-mdi-heart text-red dark:text-red-7"></span></a><span>ouuan</span></div><div class="flex flex-wrap items-center justify-center gap-x-1"><span> 当前有 <ile-root id="ile-18"><span><span class="i-mdi-loading motion-safe:animate-spin"></span><span class="sr-only">加载中</span></span></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(o=>o.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/VisitorCountRealtime.08e8132a.js"),["assets/VisitorCountRealtime.08e8132a.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});s(u,v,"ile-18",{},{})});export default E();
</script> 人在线 </span><span class="i-mdi-circle-small"></span><span title="实际上，为了保护用户隐私，同一用户的多次访问只有在同一天内使用同一浏览器在同一ip下才会被算作同一人"> 共有 <ile-root id="ile-19"><span><span class="i-mdi-loading motion-safe:animate-spin"></span><span class="sr-only">加载中</span></span></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(o=>o.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/VisitorCount.38f2b4ce.js"),["assets/VisitorCount.38f2b4ce.js","assets/VisitorCount.15186388.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});s(u,v,"ile-19",{},{})});export default E();
</script> 人到访过这里 </span></div><div class="flex flex-wrap items-center justify-center gap-x-1"> 基于 <a class="underline" href="https://github.com/ElMassimo/iles">îles</a><a class="underline" href="https://github.com/ouuan/iles-blog/blob/master/package.json">等项目</a><span class="i-mdi-circle-small"></span><span>由 ouuan 设计/制作</span><span class="i-mdi-circle-small"></span><a class="underline" href="https://github.com/ouuan/iles-blog">源代码</a></div></footer><meta itemprop="copyrightYear" content="2022 - 2023"><div class="hidden" itemscope="" itemtype="https://schema.org/Person" itemprop="copyrightHolder"><meta itemprop="name" content="ouuan"><meta itemprop="givenName" content="Yufan"><meta itemprop="familyName" content="You"><meta itemprop="url" content="https://github.com/ouuan"><link itemprop="gender" href="https://schema.org/Male"><meta itemprop="image" content="/android-chrome-512x512.png"></div><ile-root id="ile-20"><button class="group bottom-10 flex-col floating-button" title="前往底部"><div aria-hidden="true" class="flex justify-center"><span class="i-mdi-chevron-double-up motion-safe:transition-font-size text-0"></span></div><div aria-hidden="true" class="text-0 group-hover:text-3.5 motion-safe:transition-font-size"></div><div aria-hidden="false" class="flex justify-center"><span class="i-mdi-chevron-double-down motion-safe:transition-font-size text-5 group-hover:text-3"></span></div></button></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(o=>o.v),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/BackToTop.9bd1cd14.js"),["assets/BackToTop.9bd1cd14.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default});s(u,v,"ile-20",{},{})});export default E();
</script><div class="hidden"></div><ile-root id="ile-21"></ile-root><script></script><script type="module" async="">var p=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports);var e=(t,a,_)=>new Promise((c,n)=>{var f=o=>{try{i(_.next(o))}catch(r){n(r)}},l=o=>{try{i(_.throw(o))}catch(r){n(r)}},i=o=>o.done?c(o.value):Promise.resolve(o.value).then(f,l);i((_=_.apply(t,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var u=p(m=>{const E=()=>e(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(t=>t.d),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),h=()=>e(m,null,function*(){return(yield d(()=>import("/assets/PlausibleTrigger.a73dac6e.js"),["assets/PlausibleTrigger.a73dac6e.js","assets/plausible.695470a7.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).onLoad});s(E,h,"ile-21",{},{})});export default u();
</script><div></div><ile-root id="ile-22"></ile-root><script></script><script type="module" async="">var p=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports);var e=(t,a,_)=>new Promise((c,n)=>{var f=o=>{try{i(_.next(o))}catch(r){n(r)}},l=o=>{try{i(_.throw(o))}catch(r){n(r)}},i=o=>o.done?c(o.value):Promise.resolve(o.value).then(f,l);i((_=_.apply(t,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.0aa4bab4.js";import"/assets/vendor-vue.8e27fa9d.js";var u=p(m=>{const E=()=>e(m,null,function*(){return(yield d(()=>import("/assets/iles.0aa4bab4.js").then(t=>t.d),["assets/iles.0aa4bab4.js","assets/vendor-vue.8e27fa9d.js","assets/vite.5ce4fca4.js"])).default}),h=()=>e(m,null,function*(){return(yield d(()=>import("/assets/TextJustifyFix.4fa5e997.js"),[])).onLoad});s(E,h,"ile-22",{},{})});export default u();
</script><meta itemprop="inLanguage" content="zh-CN"></div>
  
</body></html>