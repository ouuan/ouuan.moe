<!DOCTYPE html><html lang="zh-CN"><head>
    <meta charset="UTF-8">
<title>CNATDA 第四章学习笔记 - ouuan's blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="《Computer Networking: A Top-Down Approach (8th Edition)》第四章 “The Network Layer: Data Plane” 的学习笔记。">
<meta property="og:url" content="https://ouuan.moe/post/2023/06/cnatda-4">
<meta property="og:site_name" content="ouuan's blog">
<meta property="og:title" content="CNATDA 第四章学习笔记 · ouuan's blog">
<meta property="og:description" content="《Computer Networking: A Top-Down Approach (8th Edition)》第四章 “The Network Layer: Data Plane” 的学习笔记。">
<meta property="twitter:domain" content="ouuan.moe">
<meta property="twitter:title" content="CNATDA 第四章学习笔记 · ouuan's blog">
<meta property="twitter:description" content="《Computer Networking: A Top-Down Approach (8th Edition)》第四章 “The Network Layer: Data Plane” 的学习笔记。">
<meta property="twitter:url" content="https://ouuan.moe/post/2023/06/cnatda-4">
<style>html:not(.dark):not(.light) { visibility: hidden; } body { visibility: hidden; }</style>
<script>(() => { let dark; try { const theme = localStorage && localStorage.getItem('vueuse-color-scheme'); if (theme === 'dark') dark = true; else if (theme === 'light') dark = false; else dark = window.matchMedia('(prefers-color-scheme: dark)').matches; } catch (e) { dark = false; } document.documentElement.classList.add(dark ? 'dark' : 'light'); })()</script>
<noscript><style>@media (prefers-color-scheme: light) { :root:not(.dark):not(.light) { color-scheme: light; --text-color: #232637; --bg-color: #DEE6EE; --card-color: #EFF3F7; --link-color: #1E66B8; --hover-color: #2E80DD; --active-color: #164C89; --bghover-color: #D6E0EA; --popup-color: #F7F9FB; --footer-color: #5F627B; --area-color: #E1E2E8; --nested-color: #F0F0F3; } } @media (prefers-color-scheme: dark) { :root:not(.dark):not(.light) { color-scheme: dark; --text-color: #E6EDF2; --bg-color: #0D0E15; --card-color: #1F2130; --link-color: #8BB8EC; --hover-color: #A2C6F0; --active-color: #74AAE8; --bghover-color: #353853; --popup-color: #2C2F45; --footer-color: #9699AE; --area-color: #2F313D; --nested-color: #3C3E4E; } } html { visibility:visible !important; }</style></noscript>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="canonical" href="https://ouuan.moe/post/2023/06/cnatda-4">
<link rel="alternate" type="application/rss+xml" href="/feed.xml" title="RSS Feed - ouuan's blog">
<link rel="alternate" type="application/atom+xml" href="/feed.atom" title="Atom Feed - ouuan's blog">
<link rel="alternate" type="application/json" href="/feed.json" title="JSON Feed - ouuan's blog">
<link rel="dns-prefetch" href="https://plausible.ouuan.moe">
<link rel="preconnect" href="https://blog-visitor-count.ouuan.moe">
<link rel="stylesheet" href="/vendors/katex/katex.css">
<link rel="sitemap" href="https://ouuan.moe/sitemap.xml">
<meta name="author" content="ouuan">
<meta name="twitter:creator" content="@ouuan">
<meta name="twitter:card" content="summary">
<meta property="og:image" content="https://ouuan.moe/images/2023/06/cnatda-4.png">
<meta property="generator" content="îles">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-07-05T14:31:33.000Z">
<meta property="article:modified_time" content="2023-07-05T14:31:33.000Z">
<meta property="article:author" content="ouuan">
<meta property="article:tag" content="cnatda">
<meta property="article:tag" content="学习笔记">
<link rel="preconnect" href="https://giscus.app">
<link rel="dns-prefetch" href="https://avatars.githubusercontent.com">
    <link rel="stylesheet" href="/assets/style-a9905eb7.css">
    
  <link rel="modulepreload" href="/assets/iles.e30597ee.js" crossorigin=""><link rel="modulepreload" href="/assets/vendor-vue.f543892e.js" crossorigin=""><link rel="modulepreload" href="/assets/vite.5ce4fca4.js" crossorigin=""><link rel="modulepreload" href="/assets/SearchBar.3bec00c3.js" crossorigin=""><link rel="modulepreload" href="/assets/PostHead.f34853a3.js" crossorigin=""><link rel="modulepreload" href="/assets/VisitorCount.b65d15cd.js" crossorigin=""><link rel="modulepreload" href="/assets/site.0440d0dc.js" crossorigin=""><link rel="modulepreload" href="/assets/GiscusCommentsInner.cc959b9e.js" crossorigin=""><link rel="modulepreload" href="/assets/useTheme.84274661.js" crossorigin=""><link rel="modulepreload" href="/assets/TableOfContents.a1f1ec5b.js" crossorigin=""><style>@font-face { font-family: "Noto Serif SC Web Font"; font-weight: 400; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Regular.unique.b05a6ea1.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Regular.unique.3ecf8342.woff') format('woff'); unicode-range: U+0-9aa4; } @font-face { font-family: "Noto Serif SC Web Font"; font-weight: 400; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Regular.common.91b8f458.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Regular.common.501f0821.woff') format('woff'); unicode-range: U+0-ff1f; } @font-face { font-family: "Noto Serif SC Web Font"; font-weight: 700; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Bold.unique.44f2ba5f.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Bold.unique.b1b09b34.woff') format('woff'); unicode-range: U+0-201d; } @font-face { font-family: "Noto Serif SC Web Font"; font-weight: 700; font-style: normal; font-display: swap; src: url('/assets/fonts/NotoSerifSC-Bold.common.c5285db9.woff2') format('woff2'), url('/assets/fonts/NotoSerifSC-Bold.common.bc3fc7f5.woff') format('woff'); unicode-range: U+0-7684; }</style><link rel="preload" href="/assets/fonts/NotoSerifSC-Regular.unique.b05a6ea1.woff2" as="font" type="font/woff2" crossorigin=""><link rel="preload" href="/assets/fonts/NotoSerifSC-Regular.common.91b8f458.woff2" as="font" type="font/woff2" crossorigin=""><link rel="preload" href="/assets/fonts/NotoSerifSC-Bold.unique.44f2ba5f.woff2" as="font" type="font/woff2" crossorigin=""><link rel="preload" href="/assets/fonts/NotoSerifSC-Bold.common.c5285db9.woff2" as="font" type="font/woff2" crossorigin=""></head>
  <body itemscope="" itemtype="https://schema.org/ItemPage">
    <div id="app"><header class="bg-card shadow print:hidden" itemprop="hasPart" itemscope="" itemtype="https://schema.org/WPHeader"><div class="flex flex-wrap justify-center whitespace-nowrap px-4 page-container sm:flex-nowrap"><div class="flex basis-full items-stretch justify-center sm:mr-3 sm:basis-auto"><a class="flex items-center p-3 text-xl font-serif bghover" href="/"><span>ouuan<span class="mojikumi-narrow-left">’</span>s blog</span></a></div><nav class="flex"><ul class="flex"><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/"><span>首页</span></a></li><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/posts"><span>文章</span></a></li><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/tags"><span>标签</span></a></li><li class="flex flex-1 items-stretch justify-center"><a class="flex items-center p-3 bghover" href="/about"><span>关于</span></a></li></ul></nav><div class="sm:basis-full"></div><ul class="flex"><li class="flex"><ile-root id="ile-1"><div class="flex items-stretch lg:hidden"><a class="flex items-center p-2 bghover" href="/search" title="全站搜索"><span class="i-mdi-magnify text-xl"></span></a></div><form role="search" class="hidden items-stretch justify-center lg:flex"><div class="flex items-center"><input value="" class="w-48 rd-full bg-area px-3 py-1" type="search" placeholder="关键词" aria-label="全站搜索"></div><a class="flex items-center p-2 bghover" href="/search?q=" title="全站搜索"><span class="i-mdi-magnify text-xl"></span></a></form></ile-root><script></script><script type="module" async="">import{h as r,c as a}from"/assets/iles.e30597ee.js";import{_ as m}from"/assets/SearchBar.3bec00c3.js";import"/assets/vendor-vue.f543892e.js";import"/assets/vite.5ce4fca4.js";r(a,m,"ile-1",{},{});
</script></li><li class="flex items-stretch"><a class="flex items-center p-2 bghover" href="/feed.xml" title="RSS 订阅"><span class="i-mdi-rss text-xl"></span></a></li><li class="flex"><ile-root id="ile-2"><div class="relative flex items-stretch"><button title="暗色模式设置" class="flex items-center p-2 bghover" aria-haspopup="menu" aria-controls="__theme-switcher" aria-expanded="false"><span class="i-mdi-theme-light-dark text-xl"></span></button><ul style="display:none;" id="__theme-switcher" class="absolute right-0 top-full z-20 whitespace-nowrap rd-1 bg-popup shadow-md" role="menu" aria-label="暗色模式选项"><li class="bghover" role="menuitemradio" aria-checked="true"><button class="flex items-center p-1 text-hover"><span class="i-mdi-cellphone md:i-mdi-tablet lg:i-mdi-monitor mr-1"></span><span>跟随系统</span></button></li><li class="bghover" role="menuitemradio" aria-checked="false"><button class="flex items-center p-1"><span class="i-mdi-white-balance-sunny mr-1"></span><span>总是亮色</span></button></li><li class="bghover" role="menuitemradio" aria-checked="false"><button class="flex items-center p-1"><span class="i-mdi-weather-night mr-1"></span><span>总是暗色</span></button></li></ul></div></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.e30597ee.js";import"/assets/vendor-vue.f543892e.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.e30597ee.js").then(o=>o.v),["assets/iles.e30597ee.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/ThemeSwitcher.358e828c.js"),["assets/ThemeSwitcher.358e828c.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js","assets/useTheme.84274661.js"])).default});s(u,v,"ile-2",{},{})});export default E();
</script></li></ul></div></header><main class="min-h-100vh py-6 page-container" itemprop="mainContentOfPage" itemscope="" itemtype="https://schema.org/WebPageElement"><div class="flex justify-center"><div class="grow m-4 standard-card max-w-200"><article itemprop="mainEntity" itemscope="" itemtype="https://schema.org/BlogPosting"><div class="hidden" itemscope="" itemtype="https://schema.org/Person" itemprop="author"><meta itemprop="name" content="ouuan"><meta itemprop="givenName" content="Yufan"><meta itemprop="familyName" content="You"><meta itemprop="url" content="https://github.com/ouuan"><link itemprop="gender" href="https://schema.org/Male"><meta itemprop="image" content="/android-chrome-512x512.png"></div><meta itemprop="inLanguage" content="zh-CN"><meta itemprop="mainEntityOfPage" content="https://ouuan.moe/post/2023/06/cnatda-4"><meta itemprop="image" content="https://ouuan.moe/images/2023/06/cnatda-4.png"><ile-root id="ile-3" class="my-12"><header class="my-12" data-v-2045e486=""><h1 class="mb-3 mt-6 text-center text-8" itemprop="headline" data-v-2045e486=""><span class="inline-block font-serif break-anywhere" data-v-2045e486=""><span data-v-2045e486="" data-v-6544d8e8="">CNATDA 第四章学习笔记</span></span></h1><div class="flex flex-wrap justify-center gap-x-4 gap-y-1 text-footer md:text-sm" data-v-2045e486=""><span class="flex items-center" title="创建于 2023-06-26 15:29:59 GMT+8" data-v-2045e486=""><span class="i-mdi-folder-plus-outline mr-1" data-v-2045e486=""></span><span class="sr-only" data-v-2045e486="">创建于</span><a class="hover:underline" href="https://github.com/ouuan/iles-blog/blob/master/src/pages/post/2023/06/cnatda-4.mdx?plain=1" data-v-2045e486=""><time datetime="2023-06-26T15:29:59+08:00" itemprop="dateCreated" data-v-2045e486="">2023-06-26</time></a></span><span class="flex items-center" title="修改于 2023-07-05 22:31:33 GMT+8" data-v-2045e486=""><span class="i-mdi-update mr-1" data-v-2045e486=""></span><span class="sr-only" data-v-2045e486="">修改于</span><a class="hover:underline" href="https://github.com/ouuan/iles-blog/commits/master/src/pages/post/2023/06/cnatda-4.mdx" data-v-2045e486=""><time datetime="2023-07-05T22:31:33+08:00" itemprop="dateModified" data-v-2045e486="">2023-07-05</time></a></span><span class="flex items-center" title="访问量" data-v-2045e486=""><span class="i-mdi-eye-outline mr-1" data-v-2045e486=""></span><span class="sr-only" data-v-2045e486="">访问量</span><span data-v-2045e486="">106</span></span><span class="flex flex-wrap justify-center gap-x-2 gap-y-1" data-v-2045e486=""><span title="标签: cnatda" class="flex items-center" data-v-2045e486=""><span class="i-mdi-tag-outline mr-1" data-v-2045e486=""></span><span class="sr-only" data-v-2045e486="">标签</span><a href="/tag/cnatda" class="hover:underline" data-v-2045e486=""><span itemprop="keywords" data-v-2045e486="" data-v-6544d8e8="">cnatda</span></a></span><span title="标签: 学习笔记" class="flex items-center" data-v-2045e486=""><span class="i-mdi-tag-outline mr-1" data-v-2045e486=""></span><span class="sr-only" data-v-2045e486="">标签</span><a href="/tag/学习笔记" class="hover:underline" data-v-2045e486=""><span itemprop="keywords" data-v-2045e486="" data-v-6544d8e8="">学习笔记</span></a></span></span></div></header></ile-root><script></script><script type="module" async="">import{h as t,c as a}from"/assets/iles.e30597ee.js";import{c as e}from"/assets/PostHead.f34853a3.js";import"/assets/vendor-vue.f543892e.js";import"/assets/vite.5ce4fca4.js";import"/assets/VisitorCount.b65d15cd.js";import"/assets/site.0440d0dc.js";t(a,e,"ile-3",{class:"my-12",href:"/post/2023/06/cnatda-4",filename:"src/pages/post/2023/06/cnatda-4.mdx",frontmatter:{title:"CNATDA 第四章学习笔记",date:new Date(1687764599e3),image:"/images/2023/06/cnatda-4.png",tags:["cnatda","学习笔记"],lastUpdated:new Date(1688567493e3),published:new Date(1688567493e3),visitor:106,description:"《Computer Networking: A Top-Down Approach (8th Edition)》第四章 “The Network Layer: Data Plane” 的学习笔记。"}},{});
</script><section class="article-style" itemprop="articleBody">

<p><span class="mojikumi-line-start">《</span>Computer Networking: A Top-Down Approach (8th Edition)<span class="mojikumi-line-end">》</span>第四章 <span class="mojikumi">“</span>The Network Layer: Data Plane<span class="mojikumi">”</span> 的学习笔记<span class="mojikumi-line-end">。</span></p>

<h2 id="overview-of-network-layer" class="heading"><a href="#overview-of-network-layer" class="heading-anchor" aria-label="章节： Overview of Network Layer" tabindex="-1"></a><span>Overview of Network Layer</span></h2>
<p>Network Layer 可以被细分为 data plane 和 control plane 两部分<span class="mojikumi-line-end">。</span></p>
<p>data plane 的主要功能是 <i>forwarding</i><span class="mojikumi-line-start">（</span>也称作 <i>switching</i><span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>即一个 router 将 input link 收到的数据转发到正确的 output link<span class="mojikumi-line-end">。</span></p>
<p>control plane 的主要功能是 <i>routing</i><span class="mojikumi-line-end">，</span>即决定从 sending host 到 receiving host 的路径<span class="mojikumi-line-end">。</span></p>
<p>router 中会有一个 <i>forwarding table</i><span class="mojikumi-line-end">，</span>从 packet header 中选取某些 field 用来 index forwarding table<span class="mojikumi-line-end">，</span>得到 outgoing link interface<span class="mojikumi-line-end">。</span></p>
<p>计算 forwarding table 则是 control plane 的任务<span class="mojikumi-line-end">，</span>有两种实现方式<span class="mojikumi-line-end">：</span></p>
<ul>
<li>the traditional approach: router 之间根据 routing protocol 互相通信<span class="mojikumi-line-end">，</span>根据 routing algorithm 计算得到 forwarding table<span class="mojikumi-line-end">。</span></li>
<li>the SDN approach: router 只实现 forwarding<span class="mojikumi-line-end">，</span>而 routing 由一个 remote controller 完成<span class="mojikumi-line-end">：</span>router 向 remote controller 发送信息<span class="mojikumi-line-end">，</span>由 remote controller 计算得到 forwarding table 发给 router<span class="mojikumi-line-end">。</span>这个 remote controller 通常是由软件实现的<span class="mojikumi-line-end">，</span>所以这种方法被称作 <i>software-defined networking</i> (SDN)<span class="mojikumi-line-end">。</span></li>
</ul>
<h2 id="what’s-inside-a-router" class="heading"><a href="#what’s-inside-a-router" class="heading-anchor" aria-label="章节： What’s Inside a Router?" tabindex="-1"></a><span>What<span class="mojikumi-narrow-left">’</span>s Inside a Router?</span></h2>
<p>router 一般包含以下部分<span class="mojikumi-line-end">：</span></p>
<ul>
<li>
<p>input ports</p>
<ul>
<li>incoming link 的 physical layer 和 link layer</li>
<li>input queue</li>
<li>lookup:
<ul>
<li>从 forwarding table 查 output port</li>
<li>将 control packet<span class="mojikumi-line-start">（</span>例如包含 routing protocol information 的 packet<span class="mojikumi-line-end">）</span>forward 到 routing processor</li>
</ul>
</li>
</ul>
</li>
<li>
<p>switching fabric: 连接 input ports 和 output ports</p>
</li>
<li>
<p>output ports</p>
<ul>
<li>outgoing link 的 link layer 和 physical layer</li>
<li>output queue</li>
</ul>
</li>
<li>
<p>routing processor: 得到 forwarding table<span class="mojikumi-line-end">，</span>进行 network management</p>
<ul>
<li>traditional: 执行 routing protocol</li>
<li>SDN: 与 remote controller 通信</li>
</ul>
</li>
</ul>
<p>为了保证通信速度<span class="mojikumi-line-end">，</span>forwarding 的用时需要在 ns 级<span class="mojikumi-line-end">，</span>所以要用硬件实现<span class="mojikumi-line-end">；</span>而 control plane 的用时一般在 ms 或 s 级<span class="mojikumi-line-end">，</span>可以用软件实现<span class="mojikumi-line-end">。</span></p>
<h3 id="input-port-processing-and-destination-based-forwarding" class="heading"><a href="#input-port-processing-and-destination-based-forwarding" class="heading-anchor" aria-label="章节： Input Port Processing and Destination-Based Forwarding" tabindex="-1"></a><span>Input Port Processing and Destination-Based Forwarding</span></h3>
<p>多个 input port 可以合并到一个 line card 上<span class="mojikumi-line-end">。</span></p>
<p>forwarding table 会从 routing processor 给每个 line card 都复制一份<span class="mojikumi-line-end">，</span>从而可以在每个局部分别计算<span class="mojikumi-line-end">，</span>不需要集中计算<span class="mojikumi-line-end">。</span></p>
<p>对于 destination-based forwarding<span class="mojikumi-line-end">，</span>forwarding table 一般是 index 为 IP 地址前缀<span class="mojikumi-line-end">，</span>value 为 link interface<span class="mojikumi-line-end">，</span>采用 longest prefix matching<span class="mojikumi-line-end">。</span></p>
<p>lookup 通常要在 ns 级别的时间内完成<span class="mojikumi-line-end">，</span>而 forwarding table 很大<span class="mojikumi-line-end">，</span>不仅需要通过硬件实现<span class="mojikumi-line-end">，</span>还需要使用特殊的算法或存储器<span class="mojikumi-line-end">，</span>例如使用 TCAM<span class="mojikumi-line-end">。</span></p>
<p>input port processing 除了 lookup 还有 physical-layer 和 link-layer processing<span class="mojikumi-line-end">，</span>还需要检查/更新 packet version<span class="mojikumi-line-end">、</span>checksum<span class="mojikumi-line-end">、</span>TTL<span class="mojikumi-line-end">，</span>更新 network management 的 counter<span class="mojikumi-line-end">。</span></p>
<h3 id="switching" class="heading"><a href="#switching" class="heading-anchor" aria-label="章节： Switching" tabindex="-1"></a><span>Switching</span></h3>
<p>switching 有多种形式<span class="mojikumi-line-end">：</span></p>
<ul>
<li>via memory: packet 从 input port 复制到 memory 再复制到 output port<span class="mojikumi-line-end">，</span>如果使用集中的 memory 而非每个 line card 分别的 memory<span class="mojikumi-line-end">，</span>则传输速率会受 memory 的速率限制<span class="mojikumi-line-end">。</span></li>
<li>via bus: 将 packet 加上一个 switch-internal label 再通过 bus 发送给所有 output port<span class="mojikumi-line-end">，</span>收到后根据 label 决定是否保留这个 packet<span class="mojikumi-line-end">，</span>传输速率会受 bus 的速率限制<span class="mojikumi-line-end">。</span></li>
<li>via interconnection network: 每个 input port 对应一个 bus<span class="mojikumi-line-end">，</span>每个 output port 对应一个 bus<span class="mojikumi-line-end">，</span>每对 input port bus 和 output port bus 之间都有 crosspoint<span class="mojikumi-line-end">，</span>通过控制 crosspoint 来控制从哪传到哪<span class="mojikumi-line-start">（</span>结构和 ROM 类似<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span>这是 non-blocking 的<span class="mojikumi-line-end">，</span>只要两个 packet 的 output port 不同就可以同时传输<span class="mojikumi-line-end">。</span></li>
</ul>
<h3 id="input-queuing" class="heading"><a href="#input-queuing" class="heading-anchor" aria-label="章节： Input Queuing" tabindex="-1"></a><span>Input Queuing</span></h3>
<p>如果 switching fabric 的速率达到了所有 input port 的速率之和<span class="mojikumi-line-end">，</span>则不会发生 input queuing<span class="mojikumi-line-end">，</span>否则可能要等待其他 packet 在 switching fabric 上传输<span class="mojikumi-line-end">。</span></p>
<p>以 switching via interconnection network 为例<span class="mojikumi-line-end">，</span>只有多个 packet 传输到同一个 output port 才会发生 input queuing<span class="mojikumi-line-end">，</span>但是一个 packet 即使没有和它 output port 相同的 packet 也可能因为 input queue 中在它前面的其他 packet 而被 block<span class="mojikumi-line-end">，</span>即 HOL blocking<span class="mojikumi-line-end">。</span></p>
<h3 id="output-queuing" class="heading"><a href="#output-queuing" class="heading-anchor" aria-label="章节： Output Queuing" tabindex="-1"></a><span>Output Queuing</span></h3>
<p>如果 packet 到达 output port 的速率超过了 output line 的速率<span class="mojikumi-line-end">，</span>则会发生 output queuing<span class="mojikumi-line-end">。</span></p>
<p>若 packet 到达时 buffer 已经满了<span class="mojikumi-line-end">，</span>则需要决定 drop 哪个 packet<span class="mojikumi-line-end">。</span>在 buffer 满之前进行 packet dropping 或 marking 称作 active queue management (AQM)<span class="mojikumi-line-end">，</span>例如 <a href="/post/2023/06/cnatda-3#network-assisted-explicit-congestion-notification">ECN</a><span class="mojikumi-line-end">、</span>random early detection (RED) 等<span class="mojikumi-line-end">。</span></p>
<h3 id="how-much-buffering-is-“enough”" class="heading"><a href="#how-much-buffering-is-“enough”" class="heading-anchor" aria-label="章节： How Much Buffering Is “Enough”?" tabindex="-1"></a><span>How Much Buffering Is <span class="mojikumi">“</span>Enough<span class="mojikumi">”</span>?</span></h3>
<p>有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 个 independent TCP flow 经过一个带宽为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></span> 的 link 时<span class="mojikumi-line-end">，</span>buffer 需要有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">R</mi><mi mathvariant="normal">T</mi><mi mathvariant="normal">T</mi></mrow><mo>⋅</mo><mi>C</mi><mi mathvariant="normal">/</mi><msqrt><mi>N</mi></msqrt></mrow><annotation encoding="application/x-tex">\mathrm{RTT} \cdot C / \sqrt N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord mathrm">RTT</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1767em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9267em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;padding-left:0.833em;">N</span></span><span style="top:-2.8867em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1133em;"><span></span></span></span></span></span></span></span></span></span><span class="mojikumi-line-end">。</span></p>
<p>更大的 buffer 能减少 packet loss<span class="mojikumi-line-end">，</span>但可能会增加 delay<span class="mojikumi-line-end">。</span>TCP 可能会使得 buffer 一直不被清空<span class="mojikumi-line-end">，</span>从而导致 queuing delay 是 constant 且 persistent 的<span class="mojikumi-line-end">，</span>这被称作 <i>bufferbloat</i><span class="mojikumi-line-end">，</span>可以通过一些 AQM 措施来缓解<span class="mojikumi-line-end">。</span></p>
<h3 id="packet-scheduling" class="heading"><a href="#packet-scheduling" class="heading-anchor" aria-label="章节： Packet Scheduling" tabindex="-1"></a><span>Packet Scheduling</span></h3>
<ul>
<li>FIFO (FCFS)</li>
<li>priority queuing<br>
<span class="mojikumi-line-start">（</span>在 non-preemptive priority queuing 中<span class="mojikumi-line-end">，</span>如果低优先级的 packet 已经开始传输<span class="mojikumi-line-end">，</span>高优先级的 packet 再到来不会打断传输<span class="mojikumi">。</span><span class="mojikumi-line-end">）</span></li>
<li>weighted fair queuing (WFQ): 给每种 packet 类型一个 weight<span class="mojikumi-line-end">，</span>决定选择这种类型的频率<span class="mojikumi-line-end">。</span></li>
</ul>
<p>packet scheduling 可以根据 IP datagram header 中的各种信息优先传输或 block 某一类 packet<span class="mojikumi-line-end">。</span><i>Order on Protecting and Promoting an Open Internet</i> (2015) 规定了 net neutrality 的三条原则<span class="mojikumi-line-end">：</span>no blocking<span class="mojikumi-line-end">、</span>no throttling<span class="mojikumi-line-end">、</span>no paid prioritization<span class="mojikumi-line-end">。</span>而 <i>Restoring Internet Freedom Order</i> (2017) 则收回了这些限制<span class="mojikumi-line-end">，</span>而是注重于 ISP transparency<span class="mojikumi-line-end">。</span></p>
<h2 id="the-internet-protocol-ip" class="heading"><a href="#the-internet-protocol-ip" class="heading-anchor" aria-label="章节： The Internet Protocol (IP)" tabindex="-1"></a><span>The Internet Protocol (IP)</span></h2>
<h3 id="ipv4-datagram-format" class="heading"><a href="#ipv4-datagram-format" class="heading-anchor" aria-label="章节： IPv4 Datagram Format" tabindex="-1"></a><span>IPv4 Datagram Format</span></h3>
<p>IPv4 datagram 的格式如下图所示<span class="mojikumi-line-end">：</span><sup><a href="#user-content-fn-fig-4.17" id="user-content-fnref-fig-4.17" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup></p>
<p><picture><source type="image/webp" srcset="/assets/cnatda-fig-4.17.68bb8fa1.webp"><img srcset="/assets/cnatda-fig-4.17.7354e07d.png" loading="lazy" src="/assets/cnatda-fig-4.17.7354e07d.png" width="757" height="553" alt="IPv4 datagram format"></picture></p>
<ul>
<li>version: 例如 IPv4<span class="mojikumi-line-end">、</span>IPv6</li>
<li>header length: 因为可能有 options<span class="mojikumi-line-end">，</span>header 是不定长的</li>
<li>type of service (TOS): 用来识别各种类型的流量<span class="mojikumi-line-end">，</span>例如 real-time datagram (对延时敏感)<span class="mojikumi-line-end">，</span>其中有 2 个 bit 用于 <a href="/post/2023/06/cnatda-3#network-assisted-explicit-congestion-notification">ECN</a></li>
<li>datagram length: header + data 的长度<span class="mojikumi-line-end">，</span>为放入 Ethernet frame<span class="mojikumi-line-end">，</span>一般不超过 1500 bytes</li>
<li>identifier<span class="mojikumi-line-end">、</span>flags<span class="mojikumi-line-end">、</span>fragmentation offset: 用于 IP fragmentation<span class="mojikumi-line-end">，</span>在 IPv6 中已被弃用</li>
<li>TTL: 为了防止死循环<span class="mojikumi-line-end">，</span>TTL 每经过一个 router 会减一<span class="mojikumi-line-end">，</span>到 0 就会被 drop</li>
<li>protocol: transport-layer protocol<span class="mojikumi-line-end">，</span>用来连接 network layer 和 transport layer</li>
<li>header checksum: 只计算 header 不计算 data<span class="mojikumi-line-end">，</span>使用 ones<span class="mojikumi-narrow-left">’</span> complement sum<span class="mojikumi-line-end">；</span>header 每经过一个 router 都会更新<span class="mojikumi-line-end">，</span>checksum 也要相应地更新</li>
<li>source and destination IP address</li>
<li>options: 由于会影响性能<span class="mojikumi-line-end">，</span>在 IPv6 中已被弃用</li>
<li>data: 一般是 transport-layer segment<span class="mojikumi-line-end">，</span>但也可能是 ICMP message 之类的其他数据</li>
</ul>
<h3 id="ipv4-addressing" class="heading"><a href="#ipv4-addressing" class="heading-anchor" aria-label="章节： IPv4 Addressing" tabindex="-1"></a><span>IPv4 Addressing</span></h3>
<p>一般来说<span class="mojikumi-line-end">，</span>每个 host 有至少一个 interface 来接入网络<span class="mojikumi-line-end">，</span>每个 router 有多个 interface 来与其他 router 或 host 连接<span class="mojikumi-line-end">。</span>每个<span class="mojikumi-line-start">（</span>接入 Internet 而不在 NAT 后的<span class="mojikumi-line-end">）</span>interface 都有一个 IP address<span class="mojikumi-line-end">。</span></p>
<p>多个 host 和 router 之间可以通过 Ethernet switch<span class="mojikumi-line-end">、</span>wireless access point 等方式互相连接<span class="mojikumi-line-end">，</span>构成一个 routerless network<span class="mojikumi-line-end">。</span>在 IP 中<span class="mojikumi-line-end">，</span>这被称作一个 <i>subnet</i><span class="mojikumi-line-end">，</span>即 interface 之间由 link 连接<span class="mojikumi-line-end">、</span>不经过 router 和 host 而构成的连通块<span class="mojikumi-line-end">。</span></p>
<p>一个 subnet 会有一个 subnet address<span class="mojikumi-line-end">，</span>例如 223.1.1.0/24<span class="mojikumi-line-end">，</span>而其中的 IP address 包括 223.1.1.1<span class="mojikumi-line-end">、</span>223.1.1.2<span class="mojikumi-line-end">、</span>223.1.1.3 等<span class="mojikumi-line-end">。</span></p>
<p>Internet 分配 IP address 的方案是 classless interdomain routing (CIDR)<span class="mojikumi-line-end">，</span>其规定了 subnet address 的格式<span class="mojikumi-line-end">，</span>例如 <code>/24</code> 表示前 24 位是这个 subnet 的地址<span class="mojikumi-line-start">（</span>network prefix<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>这个 subnet 中的 IP address 的后 8 位可以取其他值<span class="mojikumi-line-end">。</span>这样的地址分配方案和 router lookup 使用的 longest prefix matching 配合在一起可以减少 lookup table 的表项<span class="mojikumi-line-end">。</span></p>
<p>在 CIDR 之前<span class="mojikumi-line-end">，</span>曾使用过 classful addressing<span class="mojikumi-line-end">，</span>相当于是 mask length 只能是 8<span class="mojikumi-line-end">、</span>16<span class="mojikumi-line-end">、</span>24<span class="mojikumi-line-end">，</span>分别被称作 class A, B, C network<span class="mojikumi-line-end">，</span>这使得不同 class 之间的 address 数量相差过大<span class="mojikumi-line-end">，</span>难以按需选择<span class="mojikumi-line-end">，</span>容易造成浪费<span class="mojikumi-line-end">，</span>最终促成了 classless 的 CIDR<span class="mojikumi-line-end">。</span></p>
<p>longest prefix matching 也使得 address aggregation 成为可能<span class="mojikumi-line-end">：</span>可以在 lookup table 中将多个有 common prefix 的 subnet 合并为一个更大的 subnet address<span class="mojikumi-line-end">，</span>即使这些 subnet 并没有覆盖这个大的 subnet address 中的所有 address<span class="mojikumi-line-end">，</span>没覆盖到的部分还可以由更小的 subnet address<span class="mojikumi-line-start">（</span>更长的 prefix<span class="mojikumi-line-end">）</span>override<span class="mojikumi-line-end">。</span></p>
<p>255.255.255.255 是一个特殊的 IP address<span class="mojikumi-line-end">，</span>表示 broadcast<span class="mojikumi-line-end">，</span>destination address 为 broadcast address 的 datagram 会发送给整个 subnet 内的所有 host<span class="mojikumi-line-end">，</span>还有可能发送给 neighbour<span class="mojikumi-line-end">。</span></p>
<h3 id="obtaining-addresses" class="heading"><a href="#obtaining-addresses" class="heading-anchor" aria-label="章节： Obtaining Addresses" tabindex="-1"></a><span>Obtaining Addresses</span></h3>
<h4 id="obtaining-a-block-of-addresses" class="heading"><a href="#obtaining-a-block-of-addresses" class="heading-anchor" aria-label="章节： Obtaining a Block of Addresses" tabindex="-1"></a><span>Obtaining a Block of Addresses</span></h4>
<p>IP address 由 ICANN 管理<span class="mojikumi-line-end">，</span>ISP 以及 organization 可以从由 ICANN 管理的 Internet registry (Address Supporting Organization) 处获得 IP address block<span class="mojikumi-line-end">。</span></p>
<p>ISP 可以将其拥有的 IP address block 再进行细分来提供给用户<span class="mojikumi-line-end">。</span></p>
<h4 id="obtaining-a-host-address-dhcp" class="heading"><a href="#obtaining-a-host-address-dhcp" class="heading-anchor" aria-label="章节： Obtaining a Host Address: DHCP" tabindex="-1"></a><span>Obtaining a Host Address: DHCP</span></h4>
<p>router 的 IP address 一般是手动<span class="mojikumi-line-start">（</span>半自动<span class="mojikumi-line-end">）</span>配置的<span class="mojikumi-line-end">，</span>而 host 的 IP address 通常是通过 Dynamic Host Configuration Protocol (DHCP) 自动进行的<span class="mojikumi-line-end">。</span></p>
<p>使用 DHCP 能减少手动配置的工作量<span class="mojikumi-line-end">，</span>尤其是在 host 经常移动时<span class="mojikumi-line-start">（</span>例如笔记本电脑在教室和寝室之间移动<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>手动配置几乎是不可能的<span class="mojikumi-line-end">。</span></p>
<p>DHCP 可以给 host 提供一个固定或临时的 IP address<span class="mojikumi-line-end">，</span>除此之外还能提供 subnet mask<span class="mojikumi-line-end">、</span>first-hop router address (default gateway)<span class="mojikumi-line-end">、</span>local DNS server address 等信息<span class="mojikumi-line-end">。</span></p>
<p>每个 subnet 一般都会有至少一个 DHCP server<span class="mojikumi-line-end">，</span>或者一个知道 DHCP server address 的 DHCP relay agent<span class="mojikumi-line-start">（</span>一个 router<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></p>
<p>使用 DHCP 获取 IP address 的步骤如下<span class="mojikumi-line-end">：</span></p>
<ol>
<li>host 发送 DHCP discover message<span class="mojikumi-line-end">：</span>通过 UDP 发送到 255.255.255.255<span class="mojikumi-line-end">、</span>port 67<span class="mojikumi-line-end">，</span>包含一个 transaction ID<span class="mojikumi-line-start">（</span>由于 DHCP 使用 broadcast<span class="mojikumi-line-end">，</span>需要通过 transaction ID 区分不同 host<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></li>
<li>DHCP server 收到 DHCP discover message 后发送 DHCP offer message<span class="mojikumi-line-end">，</span>是一个发送到 port 68 的 broadcast<span class="mojikumi-line-end">，</span>包含 transaction ID<span class="mojikumi-line-end">、</span>proposed IP address<span class="mojikumi-line-end">、</span>IP address lease time<span class="mojikumi-line-start">（</span>proposed IP address 的有效时间<span class="mojikumi-line-end">，</span>一般是几个小时或几天<span class="mojikumi">）</span><span class="mojikumi-line-end">、</span>DHCP server address 等信息<span class="mojikumi-line-end">。</span></li>
<li>host 收到 DHCP offer message 后<span class="mojikumi-line-end">，</span>选择其中一个<span class="mojikumi-line-start">（</span>如果收到了多个<span class="mojikumi-line-end">）</span>发送 DHCP request message<span class="mojikumi-line-end">，</span>包含和 DHCP offer message 类似的信息<span class="mojikumi-line-end">，</span>也是一个 broadcast<span class="mojikumi-line-start">（</span>虽然此时已知 DHCP server address<span class="mojikumi-line-end">，</span>但可能有多个 DHCP server<span class="mojikumi-line-end">，</span>broadcast 可以让其他 server 知道可以取消 address reservation 了<sup><a href="#user-content-fn-dhcp-request-broadcast" id="user-content-fnref-dhcp-request-broadcast" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup><span class="mojikumi">）</span><span class="mojikumi-line-end">。</span></li>
<li>DHCP server 收到 DHCP request message 后回应 DHCP ACK message<span class="mojikumi-line-end">。</span></li>
</ol>
<p><span class="mojikumi-line-start">（</span>实际上<span class="mojikumi-line-end">，</span>DHCP offer 和 ACK 也可能不是 broadcast<span class="mojikumi-line-end">。</span><sup><a href="#user-content-fn-dhcp-offer-ack-broadcast" id="user-content-fnref-dhcp-offer-ack-broadcast" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup><span class="mojikumi-line-end">）</span></p>
<p>host 收到 DHCP ACK message 后就可以在 lease time 内使用这个 IP address 了<span class="mojikumi-line-end">。</span>DHCP 还提供了延长 lease time 的机制<span class="mojikumi-line-end">。</span></p>
<h3 id="network-address-translation-nat" class="heading"><a href="#network-address-translation-nat" class="heading-anchor" aria-label="章节： Network Address Translation (NAT)" tabindex="-1"></a><span>Network Address Translation (NAT)</span></h3>
<p>subnet 需要一段连续的 IP address<span class="mojikumi-line-end">，</span>如果设备数量增长超过了原来的 IP address block 大小<span class="mojikumi-line-end">，</span>新地址的分配将会变得困难<span class="mojikumi-line-end">。</span>而且<span class="mojikumi-line-end">，</span>每个设备都有一个 globally unique address 对于 IPv4 来说难以承担<span class="mojikumi-line-end">。</span>Network Address Translation (NAT) 可以解决<span class="mojikumi-line-start">（</span>缓解<span class="mojikumi-line-end">）</span>这些问题<span class="mojikumi-line-end">。</span></p>
<p>使用 NAT 时<span class="mojikumi-line-end">，</span>subnet 内使用 IP address space reserved for private network<span class="mojikumi-line-start">（</span>10.0.0.0/8<span class="mojikumi-line-end">、</span>172.16.0.0/12<span class="mojikumi-line-end">、</span>192.168.0.0/16<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>有一个 router 与外界连接并进行 NAT<span class="mojikumi-line-end">，</span>这个 router 对外界表现为 a single device with a single IP address<span class="mojikumi-line-end">，</span>通过 NAT translation table 在 private address + port 和 WAN-side address + port 之间进行转换<span class="mojikumi-line-start">（</span>使用不同的 NAT port 来区分不同的 host 以及 application port<span class="mojikumi">）</span><span class="mojikumi-line-end">。</span>这个 router 的 public address 从 ISP<span class="mojikumi-line-start">（</span>可以通过 DHCP<span class="mojikumi-line-end">）</span>获得<span class="mojikumi-line-end">，</span>而它作为 DHCP server 为 subnet 内部提供 private address<span class="mojikumi-line-end">。</span></p>
<p>NAT 一般会改变 port<span class="mojikumi-line-end">，</span>而有时需要使用特定的 port 不能改变<span class="mojikumi-line-end">，</span>可以通过 NAT traversal 来实现<span class="mojikumi-line-end">。</span><span class="heimu"><span class="mojikumi-line-start">（</span>勾起了一些远古的 MC 联机回忆<span class="mojikumi-line-end">，</span>虽然当时并没成功<span class="mojikumi-line-start">（</span></span></p>
<h3 id="ipv6" class="heading"><a href="#ipv6" class="heading-anchor" aria-label="章节： IPv6" tabindex="-1"></a><span>IPv6</span></h3>
<p>为了解决 IPv4 address 即将耗尽的问题<span class="mojikumi-line-end">，</span>IPv6 被研发了出来<span class="mojikumi-line-end">。</span>除了将 IP address 从 32 bits 扩展到 128 bits<span class="mojikumi-line-end">，</span>IPv6 还顺带解决了 IPv4 中的一些其他问题<span class="mojikumi-line-end">。</span></p>
<p>IPv6 datagram 的格式如下图所示<span class="mojikumi-line-end">：</span><sup><a href="#user-content-fn-fig-4.26" id="user-content-fnref-fig-4.26" data-footnote-ref="" aria-describedby="footnote-label">4</a></sup></p>
<p><picture><source type="image/webp" srcset="/assets/cnatda-fig-4.26.15f4647d.webp"><img srcset="/assets/cnatda-fig-4.26.7d119d85.png" loading="lazy" src="/assets/cnatda-fig-4.26.7d119d85.png" width="755" height="419" alt="IPv6 datagram format"></picture></p>
<p>IPv6 的主要变化<span class="mojikumi-line-end">：</span></p>
<ul>
<li>在 unicast 和 broadcast 的基础上引入了 anycast<span class="mojikumi-line-end">，</span>即向多个地址之一发送信息<span class="mojikumi-line-end">，</span>例如可以用来向多个有相同内容的 server 发送 anycast 来获取其中最近的一个的 response<span class="mojikumi-line-end">。</span></li>
<li>使用定长 (40 bytes) 的 header<span class="mojikumi-line-end">。</span></li>
<li>引入了 <i>flow label</i> 使得 router 可以对 flow 进行特殊处理<span class="mojikumi-line-end">。</span></li>
<li>删除了 fragmentation 功能以提高性能<span class="mojikumi-line-end">。</span></li>
<li>删除了 checksum<span class="mojikumi-line-end">，</span>因为 transport-layer segment 一般已经有 checksum 了<span class="mojikumi-line-end">，</span>每次修改 TTL 都更新 checksum 也非常耗时<span class="mojikumi-line-end">。</span></li>
<li>删除了 options<span class="mojikumi-line-end">，</span>而 next header 不一定是 transport-layer protocol<span class="mojikumi-line-end">，</span>也可以是 option<span class="mojikumi-line-end">。</span></li>
<li>TOS 改为 traffic class<span class="mojikumi-line-end">，</span>TTL 改为 hop limit<span class="mojikumi-line-end">，</span>datagram length 改为 payload length<span class="mojikumi-line-start">（</span>不含 header length<span class="mojikumi">）</span><span class="mojikumi-line-end">，</span>protocol 改为 next header<span class="mojikumi-line-end">。</span></li>
</ul>
<p>network-layer protocol 的改动非常困难<span class="mojikumi-line-end">，</span>IPv4 到 IPv6 的转换至今仍在进行中<span class="mojikumi-line-end">。</span></p>
<p>新的设备<span class="mojikumi-line-start">（</span>router<span class="mojikumi-line-end">）</span>可以同时支持 IPv4 和 IPv6<span class="mojikumi-line-end">，</span>但旧的设备只能支持 IPv4<span class="mojikumi-line-end">，</span>为了使它们共存<span class="mojikumi-line-end">，</span>可以采用 <i>tunneling</i><span class="mojikumi-line-end">，</span>即将 IPv6 datagram 作为 IPv4 的 payload 进行传输<span class="mojikumi-line-end">，</span>两个 IPv6 router 之间的一系列 IPv4 router 被称作 <i>tunnel</i><span class="mojikumi-line-end">。</span></p>
<h3 id="generalized-forwarding-and-sdn" class="heading"><a href="#generalized-forwarding-and-sdn" class="heading-anchor" aria-label="章节： Generalized Forwarding and SDN" tabindex="-1"></a><span>Generalized Forwarding and SDN</span></h3>
<p>generalized forwarding 基于<span class="mojikumi-line-start">“</span>match-plus-action<span class="mojikumi-line-end">”</span>的原则<span class="mojikumi-line-end">，</span>比起 destination-based forwarding<span class="mojikumi">，</span><wbr><span class="mojikumi-line-start">“</span>match<span class="mojikumi-line-end">”</span>时可以考虑 IP header 中 destination 以外的其他 field<span class="mojikumi-line-end">，</span>也可以考虑 link-layer header<span class="mojikumi-line-end">、</span>transport-layer header<span class="mojikumi-line-end">、</span>ingress port 等<span class="mojikumi">；</span><wbr><span class="mojikumi-line-start">“</span>action<span class="mojikumi-line-end">”</span>除了 forward 还可以是 drop<span class="mojikumi-line-end">、</span>修改 header field 等<span class="mojikumi-line-end">。</span></p>
<p>OpenFlow 是一个 generalized forwarding 的协议<span class="mojikumi-line-end">，</span>规定了 match 时可以/不能使用哪些 field<span class="mojikumi-line-end">，</span>以及可以采取哪些 action<span class="mojikumi-line-end">。</span>设计一个 flow table<span class="mojikumi-line-end">，</span>就可以实现各种功能<span class="mojikumi-line-end">，</span>例如 forwarding<span class="mojikumi-line-end">、</span>load balancing<span class="mojikumi-line-end">、</span>NAT<span class="mojikumi-line-end">、</span>firewall 等<span class="mojikumi-line-end">。</span></p>
<p>P4 (Programming Protocol-independent Packet Processors) 是一个用来实现 generalized forwarding 的 programming language<span class="mojikumi-line-end">，</span>可以比 flow table 更加灵活<span class="mojikumi-line-end">。</span></p>
<h2 id="middleboxes" class="heading"><a href="#middleboxes" class="heading-anchor" aria-label="章节： Middleboxes" tabindex="-1"></a><span>Middleboxes</span></h2>
<p>在 network 中<span class="mojikumi-line-end">，</span>除了基础的 forwarding<span class="mojikumi-line-end">，</span>还有一些用来实现其他功能的设施<span class="mojikumi-line-end">，</span>称作 <i>middlebox</i><span class="mojikumi-line-end">：</span></p>
<ul>
<li>NAT translation</li>
<li>security services<span class="mojikumi-line-end">，</span>例如 firewall<span class="mojikumi-line-end">、</span>email filter</li>
<li>performance enhancement<span class="mojikumi-line-end">，</span>例如 Web cache<span class="mojikumi-line-end">、</span>load balancing<span class="mojikumi-line-end">、</span>TCP splitter</li>
</ul>
<p>为了降低运营维护的成本<span class="mojikumi-line-end">，</span>有的 middlebox 用软件甚至云服务代替硬件来实现<span class="mojikumi-line-end">，</span>称作 network function virtualization (NFV)<span class="mojikumi-line-end">。</span></p>
<p>middlebox 在一定程度上破坏了 network 的 layered architecture<span class="mojikumi-line-end">：</span>很多 middlebox 位于 network layer<span class="mojikumi-line-end">，</span>却依赖于 transport layer 甚至 application layer 的信息<span class="mojikumi-line-end">。</span>例如 NAT 会修改 IP address 和 port<span class="mojikumi-line-end">，</span>firewall 可能依赖于 application message 的内容<span class="mojikumi-line-end">。</span></p>
<p>Internet architecture 的基本原则是<span class="mojikumi-line-start">“</span>the goal is connectivity, the tool is the Internet Protocol, and the intelligence is end to end rather than hidden in the network<span class="mojikumi">”</span><span class="mojikumi-line-end">。</span><sup><a href="#user-content-fn-rfc-1958" id="user-content-fnref-rfc-1958" data-footnote-ref="" aria-describedby="footnote-label">5</a></sup>在 network layer 中只有 IP 一个 protocol<span class="mojikumi-line-end">、</span>将 complexity 放在 end system<span class="mojikumi-line-end">，</span>可以简化 network layer 的功能<span class="mojikumi-line-end">，</span>保证 connectivity<span class="mojikumi-line-end">，</span>而 middlebox 在一定程度上破坏了这样的原则<span class="mojikumi-line-end">。</span></p>
<p>尽管在架构上有些不完美<span class="mojikumi-line-end">，</span>但 middlebox 承担着非常重要的功能<span class="mojikumi-line-end">，</span>并不会消亡<span class="mojikumi-line-end">。</span></p>
<section data-footnotes="" class="footnotes"><h2 class="sr-only" id="footnote-label">Footnotes</h2>
<ol>
<li id="user-content-fn-fig-4.17">
<p>p331, Figure 4.17: IPv4 datagram format <a href="#user-content-fnref-fig-4.17" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-dhcp-request-broadcast">
<p><a href="https://networkengineering.stackexchange.com/a/48881">Why is broadcast used at the DHCPREQUEST step? - Network Engineering Stack Exchange</a> <a href="#user-content-fnref-dhcp-request-broadcast" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-dhcp-offer-ack-broadcast">
<p><a href="https://stackoverflow.com/a/10757849">Why are DHCP Offer and Ack broadcasted? - Stack Overflow</a> <a href="#user-content-fnref-dhcp-offer-ack-broadcast" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-fig-4.26">
<p>p349, Figure 4.26: IPv6 datagram format <a href="#user-content-fnref-fig-4.26" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-rfc-1958">
<p><a href="https://datatracker.ietf.org/doc/html/rfc1958#section-2">2. Is there an Internet Architecture? - RFC1958</a> <a href="#user-content-fnref-rfc-1958" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section></section><div class="article-style my-9"><hr></div><footer><div class="my-6 b-l-6 b-gray-4 bg-area p-6 shadow dark:b-gray-11" itemprop="copyrightNotice"><ul class="flex flex-col gap-1"><li class="flex gap-1"><span class="shrink-0">文章作者:</span><a href="https://github.com/ouuan" rel="author">ouuan</a></li><li class="flex gap-1"><span class="shrink-0">原文链接:</span><a href="https://ouuan.moe/post/2023/06/cnatda-4" rel="canonical" class="break-all">https://ouuan.moe/post/2023/06/cnatda-4</a></li><li class="flex gap-1"><span class="shrink-0">许可协议:</span><span> 本文采用 <span class="article-style"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.zh" class="font-sans" itemprop="license">CC BY-SA 4.0</a></span> 许可协议进行授权，未满足 <span class="underline decoration-dotted" title="简而言之，转载时必须标明出处（本文的链接），标明是转载而非原创，标明作了哪些修改，并使用相同的许可协议，但无需私信征求许可">许可协议要求</span> 不得转载。 </span></li></ul></div></footer></article><div class="my-6 print:hidden" itemprop="comment" itemscope="" itemtype="https://schema.org/Comment"><ile-root id="ile-4"></ile-root><script></script><script type="module" async="">import{h as r,c as m}from"/assets/iles.e30597ee.js";import{_ as o}from"/assets/GiscusCommentsInner.cc959b9e.js";import"/assets/vendor-vue.f543892e.js";import"/assets/vite.5ce4fca4.js";import"/assets/useTheme.84274661.js";import"/assets/site.0440d0dc.js";r(m,o,"ile-4",{term:"CNATDA 第四章学习笔记",lang:void 0},{});
</script></div><nav class="my-6 flex justify-between gap-6 print:hidden lg:text-justify"><div class="flex flex-1"><a class="flex items-center gap-1 hover:text-hover" href="/post/2023/06/cnatda-3"><span class="i-mdi-chevron-left"></span><span class="sr-only">上一篇</span><span class="break-anywhere">CNATDA 第三章学习笔记</span></a></div><div class="flex flex-1 justify-end"><a class="flex flex-row-reverse items-center gap-1 hover:text-hover" href="/post/2023/07/cnatda-5"><span class="i-mdi-chevron-right"></span><span class="sr-only">下一篇</span><span class="break-anywhere">CNATDA 第五章学习笔记</span></a></div></nav></div><ile-root id="ile-5"><div class="flex print:hidden"><aside style="max-height:calc(100vh - 10rem);" id="__toc" class="sticky top-16 m-4 hidden w-72 rd-2 bg-card py-6 shadow xl:block 2xl:w-84 3xl:w-96" aria-label="文章目录" itemprop="hasPart" itemscope="" itemtype="https://schema.org/WPSideBar"><div class="mb-3 flex flex-wrap items-center justify-between gap-2 pl-8 pr-4"><div class="flex items-center"><h2 class="text-xl font-bold"> 文章目录 </h2><button id="__toc-close" class="flex items-center px-1 text-xl" title="关闭目录" aria-controls="__toc" aria-expanded="true"><span class="i-mdi-close"></span></button></div><div><label class="ml-auto flex items-center gap-1"><span>展开全部</span><input type="checkbox"></label></div></div><div style="max-height:calc(100% - 2rem);" class="overflow-auto overscroll-contain pl-8 pr-4"><ol data-v-c5806953=""><li id="__toc-item-overview-of-network-layer" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#overview-of-network-layer" data-v-c5806953=""><span data-v-c5806953="">Overview of Network Layer</span></a></li><li id="__toc-item-what’s-inside-a-router" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#what’s-inside-a-router" data-v-c5806953=""><span data-v-c5806953="">What’s Inside a Router?</span></a></li><li id="__toc-item-the-internet-protocol-ip" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-chevron-right" data-v-c5806953=""></span><span class="sr-only" data-v-c5806953="">已折叠</span><a class="transition-color ease-out" href="#the-internet-protocol-ip" data-v-c5806953=""><span data-v-c5806953="">The Internet Protocol (IP)</span></a></li><li id="__toc-item-middleboxes" class="relative my-1" data-v-c5806953=""><span class="absolute top-1.2 left--4
                   motion-safe:transition-transform ease-out i-mdi-circle-medium" data-v-c5806953=""></span><a class="transition-color ease-out" href="#middleboxes" data-v-c5806953=""><span data-v-c5806953="">Middleboxes</span></a></li></ol></div></aside><button style="display:none;" id="__toc-open" title="显示文章目录" class="bottom-24 text-lg floating-button" aria-haspopup="dialog" aria-controls="__toc" aria-expanded="true"><span class="i-mdi-menu"></span></button></div></ile-root><script></script><script type="module" async="">import{h as i,c as s}from"/assets/iles.e30597ee.js";import{_ as n}from"/assets/TableOfContents.a1f1ec5b.js";import"/assets/vendor-vue.f543892e.js";import"/assets/vite.5ce4fca4.js";i(s,n,"ile-5",function(e,t,l){return{headings:[{level:t,title:"Overview of Network Layer",slug:"overview-of-network-layer"},{level:t,title:"What’s Inside a Router?",slug:"what’s-inside-a-router"},{level:e,title:"Input Port Processing and Destination-Based Forwarding",slug:"input-port-processing-and-destination-based-forwarding"},{level:e,title:"Switching",slug:"switching"},{level:e,title:"Input Queuing",slug:"input-queuing"},{level:e,title:"Output Queuing",slug:"output-queuing"},{level:e,title:"How Much Buffering Is “Enough”?",slug:"how-much-buffering-is-“enough”"},{level:e,title:"Packet Scheduling",slug:"packet-scheduling"},{level:t,title:"The Internet Protocol (IP)",slug:"the-internet-protocol-ip"},{level:e,title:"IPv4 Datagram Format",slug:"ipv4-datagram-format"},{level:e,title:"IPv4 Addressing",slug:"ipv4-addressing"},{level:e,title:"Obtaining Addresses",slug:"obtaining-addresses"},{level:l,title:"Obtaining a Block of Addresses",slug:"obtaining-a-block-of-addresses"},{level:l,title:"Obtaining a Host Address: DHCP",slug:"obtaining-a-host-address-dhcp"},{level:e,title:"Network Address Translation (NAT)",slug:"network-address-translation-nat"},{level:e,title:"IPv6",slug:"ipv6"},{level:e,title:"Generalized Forwarding and SDN",slug:"generalized-forwarding-and-sdn"},{level:t,title:"Middleboxes",slug:"middleboxes"}]}}(3,2,4),{});
</script></div></main><footer class="flex flex-col gap-1 bg-card p-6 text-footer" itemprop="hasPart" itemscope="" itemtype="https://schema.org/WPFooter"><div class="flex flex-wrap items-center justify-center gap-x-1" itemprop="copyrightNotice"><span>Copyright ©</span><span>2022 - 2024</span><a class="flex items-center" href="/sponsor" title="赞赏支持"><span class="i-mdi-heart text-red dark:text-red-7"></span></a><span>ouuan</span></div><div class="flex flex-wrap items-center justify-center gap-x-1 print:hidden"><span> 当前有 <ile-root id="ile-6"><span><span class="i-mdi-loading motion-safe:animate-spin"></span><span class="sr-only">加载中</span></span></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.e30597ee.js";import"/assets/vendor-vue.f543892e.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.e30597ee.js").then(o=>o.v),["assets/iles.e30597ee.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/VisitorCountRealtime.44b7ccfd.js"),["assets/VisitorCountRealtime.44b7ccfd.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).default});s(u,v,"ile-6",{},{})});export default E();
</script> 人在线 </span><span class="i-mdi-circle-small"></span><span title="实际上，为了保护用户隐私，同一用户的多次访问只有在同一天内使用同一浏览器在同一ip下才会被算作同一人"> 共有 <ile-root id="ile-7"><span><span class="i-mdi-loading motion-safe:animate-spin"></span><span class="sr-only">加载中</span></span></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.e30597ee.js";import"/assets/vendor-vue.f543892e.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.e30597ee.js").then(o=>o.v),["assets/iles.e30597ee.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/VisitorCount.7062fe22.js"),["assets/VisitorCount.7062fe22.js","assets/VisitorCount.b65d15cd.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).default});s(u,v,"ile-7",{},{})});export default E();
</script> 人到访过这里 </span></div><div class="flex flex-wrap items-center justify-center gap-x-1 print:hidden"> 基于 <a class="underline" href="https://github.com/ElMassimo/iles">îles</a><a class="underline" href="https://github.com/ouuan/iles-blog/blob/master/package.json">等项目</a><span class="i-mdi-circle-small"></span><span>由 ouuan 设计/制作</span><span class="i-mdi-circle-small"></span><a class="underline" href="https://github.com/ouuan/iles-blog">源代码</a></div></footer><meta itemprop="copyrightYear" content="2022"><meta itemprop="copyrightYear" content="2023"><meta itemprop="copyrightYear" content="2024"><div class="hidden" itemscope="" itemtype="https://schema.org/Person" itemprop="copyrightHolder"><meta itemprop="name" content="ouuan"><meta itemprop="givenName" content="Yufan"><meta itemprop="familyName" content="You"><meta itemprop="url" content="https://github.com/ouuan"><link itemprop="gender" href="https://schema.org/Male"><meta itemprop="image" content="/android-chrome-512x512.png"></div><ile-root id="ile-8"><button class="group bottom-10 flex-col floating-button" title="前往底部"><div aria-hidden="true" class="flex justify-center"><span class="i-mdi-chevron-double-up motion-safe:transition-font-size text-0"></span></div><div aria-hidden="true" class="text-0 group-hover:text-3.5 motion-safe:transition-font-size"></div><div aria-hidden="false" class="flex justify-center"><span class="i-mdi-chevron-double-down motion-safe:transition-font-size text-5 group-hover:text-3"></span></div></button></ile-root><script></script><script type="module" async="">var p=(o,a)=>()=>(a||o((a={exports:{}}).exports,a),a.exports);var r=(o,a,_)=>new Promise((c,n)=>{var f=t=>{try{e(_.next(t))}catch(i){n(i)}},l=t=>{try{e(_.throw(t))}catch(i){n(i)}},e=t=>t.done?c(t.value):Promise.resolve(t.value).then(f,l);e((_=_.apply(o,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.e30597ee.js";import"/assets/vendor-vue.f543892e.js";var E=p(m=>{const u=()=>r(m,null,function*(){return(yield d(()=>import("/assets/iles.e30597ee.js").then(o=>o.v),["assets/iles.e30597ee.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).default}),v=()=>r(m,null,function*(){return(yield d(()=>import("/assets/BackToTop.173a6e5e.js"),["assets/BackToTop.173a6e5e.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).default});s(u,v,"ile-8",{},{})});export default E();
</script><div class="hidden"></div><ile-root id="ile-9"></ile-root><script></script><script type="module" async="">var p=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports);var e=(t,a,_)=>new Promise((c,n)=>{var f=o=>{try{i(_.next(o))}catch(r){n(r)}},l=o=>{try{i(_.throw(o))}catch(r){n(r)}},i=o=>o.done?c(o.value):Promise.resolve(o.value).then(f,l);i((_=_.apply(t,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.e30597ee.js";import"/assets/vendor-vue.f543892e.js";var u=p(m=>{const E=()=>e(m,null,function*(){return(yield d(()=>import("/assets/iles.e30597ee.js").then(t=>t.d),["assets/iles.e30597ee.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).default}),h=()=>e(m,null,function*(){return(yield d(()=>import("/assets/PlausibleTrigger.eac998da.js"),["assets/PlausibleTrigger.eac998da.js","assets/plausible.3552d806.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).onLoad});s(E,h,"ile-9",{},{})});export default u();
</script><div></div><ile-root id="ile-10"></ile-root><script></script><script type="module" async="">var p=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports);var e=(t,a,_)=>new Promise((c,n)=>{var f=o=>{try{i(_.next(o))}catch(r){n(r)}},l=o=>{try{i(_.throw(o))}catch(r){n(r)}},i=o=>o.done?c(o.value):Promise.resolve(o.value).then(f,l);i((_=_.apply(t,a)).next())});import{_ as d}from"/assets/vite.5ce4fca4.js";import{a as s}from"/assets/iles.e30597ee.js";import"/assets/vendor-vue.f543892e.js";var u=p(m=>{const E=()=>e(m,null,function*(){return(yield d(()=>import("/assets/iles.e30597ee.js").then(t=>t.d),["assets/iles.e30597ee.js","assets/vendor-vue.f543892e.js","assets/vite.5ce4fca4.js"])).default}),h=()=>e(m,null,function*(){return(yield d(()=>import("/assets/TextJustifyFix.4fa5e997.js"),[])).onLoad});s(E,h,"ile-10",{},{})});export default u();
</script></div>
  
</body></html>